# Go è¯­è¨€å®æˆ˜: ç¼–å†™å¯ç»´æŠ¤ Go è¯­è¨€ä»£ç å»ºè®®

ğŸ‘ å»ºè®®è‹±è¯­å¥½çš„æœ‹å‹ç›´æ¥é˜…è¯»[Dave å¤§ç¥çš„åŸæ–‡](https://dave.cheney.net/practical-go/presentations/qcon-china.html)ï¼ŒåŸæ»‹åŸå‘³ï¼Œå®¹æ˜“ç†è§£ã€‚

è‹±è¯­ä¸æ˜¯é‚£ä¹ˆè‡ªä¿¡çš„æœ‹å‹ï¼Œè¯»ç¿»è¯‘ç‰ˆæœ¬å¯ä»¥å¿«é€Ÿç†è§£ï¼Œä¸ç†è§£çš„åœ°æ–¹å¯ä»¥ç¿»åˆ°è‹±æ–‡åœ°æ–¹å»çœ‹çœ‹ï¼Œå¦‚æœæœ‰é—®é¢˜éšæ„`Issue`ï¼Œæ¬¢è¿ PRã€‚

æœ€æ–¹ä¾¿é˜…è¯»çš„æ–¹å¼æ˜¯`fork`åˆ°è‡ªå·±çš„ä»“åº“ï¼ŒåŒæ—¶é¡ºä¾¿ä¿®æ”¹ï¼Œç„¶å PRã€‚

æœ¬ä»“åº“`fork`è‡ª[llitfkitfk/go-best-practice](https://github.com/llitfkitfk/go-best-practice)ï¼Œå¹¶åœ¨æ­¤åŸºç¡€ä¸Šè¿›è¡Œäº†å°é‡ä¿®æ”¹å’Œå¢åŠ äº†æ³¨é‡Šï¼Œæ³¨é‡Šä¸ºæ‹¬å·å†…*æ–œä½“éƒ¨åˆ†*ã€‚

## ç›®å½•

- [1. æŒ‡å¯¼åŸåˆ™](#1-æŒ‡å¯¼åŸåˆ™)
	- [1.1 ç®€å•æ€§](#11-ç®€å•æ€§)
	- [1.2 å¯è¯»æ€§](#12-å¯è¯»æ€§)
	- [1.3 ç”Ÿäº§åŠ›](#13-ç”Ÿäº§åŠ›)

- [2. æ ‡è¯†ç¬¦](#2-æ ‡è¯†ç¬¦)
	- [2.1 é€‰æ‹©æ ‡è¯†æ˜¯ä¸ºäº†æ¸…æ™°, è€Œä¸æ˜¯ç®€æ´](#21-é€‰æ‹©æ ‡è¯†ç¬¦æ˜¯ä¸ºäº†æ¸…æ™°è€Œä¸æ˜¯ç®€æ´)
	- [2.2 æ ‡è¯†ç¬¦é•¿åº¦](#22-æ ‡è¯†ç¬¦é•¿åº¦)
	- [2.3 ä¸è¦ç”¨å˜é‡ç±»å‹å‘½åå˜é‡](#23-ä¸è¦ç”¨å˜é‡ç±»å‹å‘½åä½ çš„å˜é‡)
	- [2.4 ä½¿ç”¨ä¸€è‡´çš„å‘½åé£æ ¼](#24-ä½¿ç”¨ä¸€è‡´çš„å‘½åæ–¹å¼)
	- [2.5 ä½¿ç”¨ä¸€è‡´çš„å£°æ˜æ ·å¼](#25-ä½¿ç”¨ä¸€è‡´çš„å£°æ˜æ ·å¼)
	- [2.6 æˆä¸ºå›¢é˜Ÿçš„åˆä½œè€…](#26-æˆä¸ºå›¢é˜Ÿåˆä½œè€…)

- [3. æ³¨é‡Š](#3-æ³¨é‡Š)
	- [3.1 å…³äºå˜é‡å’Œå¸¸é‡çš„æ³¨é‡Šåº”æè¿°å…¶å†…å®¹è€Œéå…¶ç›®çš„](#31-å…³äºå˜é‡å’Œå¸¸é‡çš„æ³¨é‡Šåº”æè¿°å…¶å†…å®¹è€Œéå…¶ç›®çš„)
	- [3.2 å…¬å…±ç¬¦å·å§‹ç»ˆè¦æ³¨é‡Š](#32-å…¬å…±ç¬¦å·å§‹ç»ˆè¦æ³¨é‡Š)

- [4. åŒ…çš„è®¾è®¡](#4-åŒ…çš„è®¾è®¡)
	- [4.1 ä¸€ä¸ªå¥½çš„åŒ…ä»å®ƒçš„åå­—å¼€å§‹](#41-ä¸€ä¸ªå¥½çš„åŒ…ä»å®ƒçš„åå­—å¼€å§‹)
	- [4.2 é¿å…ä½¿ç”¨ç±»ä¼¼`base`ã€`common`æˆ–`util`çš„åŒ…åç§°](#42-é¿å…ä½¿ç”¨ç±»ä¼¼basecommonæˆ–utilçš„åŒ…åç§°)
	- [4.3 å°½æ—©`return`è€Œä¸æ˜¯æ·±åº¦åµŒå¥—](#43-å°½æ—©returnè€Œä¸æ˜¯æ·±åº¦åµŒå¥—)
	- [4.4 è®©é›¶å€¼æ›´æœ‰ç”¨](#44-è®©é›¶å€¼æ›´æœ‰ç”¨)
	- [4.5 é¿å…åŒ…çº§åˆ«çŠ¶æ€](#45-é¿å…åŒ…çº§åˆ«çŠ¶æ€)
 
- [5. é¡¹ç›®ç»“æ„](#5-é¡¹ç›®ç»“æ„)
	- [5.1 è€ƒè™‘æ›´å°‘ï¼Œæ›´å¤§çš„åŒ…](#51-è€ƒè™‘æ›´å°‘æ›´å¤§çš„åŒ…)
	- [5.2 ä¿æŒ`main`åŒ…å†…å®¹å°½å¯èƒ½çš„å°‘](#52-ç¡®ä¿mainåŒ…å†…å®¹å°½å¯èƒ½çš„å°‘)

- [6. APIè®¾è®¡](#6-apiè®¾è®¡)
	- [6.1 è®¾è®¡éš¾ä»¥è¢«è¯¯ç”¨çš„API](#61-è®¾è®¡éš¾ä»¥è¢«è¯¯ç”¨çš„api)
	- [6.2 ä¸ºå…¶é»˜è®¤ç”¨ä¾‹è®¾è®¡API](#62-ä¸ºå…¶é»˜è®¤ç”¨ä¾‹è®¾è®¡api)
	- [6.3 è®©å‡½æ•°å®šä¹‰å®ƒä»¬æ‰€éœ€çš„è¡Œä¸º](#63-è®©å‡½æ•°å®šä¹‰å®ƒä»¬æ‰€éœ€çš„è¡Œä¸º)

- [7. é”™è¯¯å¤„ç†](#7-é”™è¯¯å¤„ç†)
	- [7.1 é€šè¿‡æ¶ˆé™¤é”™è¯¯æ¥æ¶ˆé™¤é”™è¯¯å¤„ç†](#71-é€šè¿‡æ¶ˆé™¤é”™è¯¯æ¥æ¶ˆé™¤é”™è¯¯å¤„ç†)
	- [7.2 é”™è¯¯åªå¤„ç†ä¸€æ¬¡](#72-é”™è¯¯åªå¤„ç†ä¸€æ¬¡)

- [8. å¹¶å‘](#8-å¹¶å‘)
	- [8.1 ä¿æŒè‡ªå·±å¿™ç¢Œæˆ–åšè‡ªå·±çš„å·¥ä½œ](#81-ä¿æŒè‡ªå·±å¿™ç¢Œæˆ–åšè‡ªå·±çš„å·¥ä½œ)
	- [8.2 å°†å¹¶å‘æ€§ç•™ç»™è°ƒç”¨è€…](#82-å°†å¹¶å‘æ€§ç•™ç»™è°ƒç”¨è€…)
	- [8.3 æ°¸è¿œä¸è¦å¯åŠ¨ä¸€ä¸ªåœæ­¢ä¸äº†çš„`goroutine`](#83-æ°¸è¿œä¸è¦å¯åŠ¨ä¸€ä¸ªåœæ­¢ä¸äº†çš„goroutine)

## ä»‹ç»

å¤§å®¶å¥½,æˆ‘åœ¨æ¥ä¸‹æ¥çš„ä¸¤ä¸ªä¼šè®®ä¸­çš„ç›®æ ‡æ˜¯å‘å¤§å®¶æä¾›æœ‰å…³ç¼–å†™ Go ä»£ç æœ€ä½³å®è·µçš„å»ºè®®ã€‚

è¿™æ˜¯ä¸€ä¸ªç ”è®¨ä¼šå½¢å¼çš„æ¼”è®²ï¼Œä¸ä¼šæœ‰å¹»ç¯ç‰‡,è€Œæ˜¯ç›´æ¥ä»æ–‡æ¡£å¼€å§‹ã€‚

> è´´å£«: åœ¨è¿™é‡Œæœ‰æœ€æ–°çš„æ–‡ç« é“¾æ¥<https://dave.cheney.net/practical-go/presentations/qcon-china.html>

## ç¼–è€…çš„è¯

- ç»ˆäºç¿»è¯‘å®Œäº† Dave å¤§ç¥çš„è¿™ä¸€ç¯‡ã€Š**Go è¯­è¨€æœ€ä½³å®è·µ**ã€‹
- è€—æ—¶ä¸¤å‘¨çš„ç©ºé—²æ—¶é—´
- ç¿»è¯‘çš„åŒæ—¶ä¹Ÿå¯¹ Go è¯­è¨€çš„å¼€å‘ä¸å®è·µæœ‰äº†æ›´æ·±å±‚æ¬¡çš„äº†è§£
- æœ‰å…´è¶£çš„åŒå­¦å¯ä»¥ç¿»é˜… Dave çš„å¦ä¸€ç¯‡åšæ–‡[ã€Š**SOLID Go è¯­è¨€è®¾è®¡**ã€‹](https://www.jianshu.com/p/0aebd9618300)(ç¬¬å…­ç« èŠ‚ä¹Ÿä¼šæåˆ°)
- åŒæ—¶åœ¨è¿™é‡Œä¹Ÿæ¨èä¸€ä¸ª Telegram Docker ç¾¤ç»„(åˆ†äº«/äº¤æµ): [https://t.me/dockertutorial](https://t.me/dockertutorial)

## æ­£æ–‡

### 1. æŒ‡å¯¼åŸåˆ™

å¦‚æœæˆ‘è¦è°ˆè®ºä»»ä½•ç¼–ç¨‹è¯­è¨€çš„æœ€ä½³å®è·µï¼Œæˆ‘éœ€è¦ä¸€äº›æ–¹æ³•æ¥å®šä¹‰â€œä»€ä¹ˆæ˜¯æœ€ä½³â€ã€‚å¦‚æœä½ æ˜¨å¤©æ¥åˆ°æˆ‘çš„ä¸»é¢˜æ¼”è®²ï¼Œä½ ä¼šçœ‹åˆ° Go å›¢é˜Ÿè´Ÿè´£äºº Russ Cox çš„è¿™å¥è¯ï¼š

> Software engineering is what happens to programming when you add time and other programmers. (è½¯ä»¶å·¥ç¨‹å°±æ˜¯ä½ å’Œå…¶ä»–ç¨‹åºå‘˜èŠ±è´¹æ—¶é—´åœ¨ç¼–ç¨‹ä¸Šæ‰€å‘ç”Ÿçš„äº‹æƒ…ã€‚) â€” Russ Cox

Russ ä½œå‡ºäº†è½¯ä»¶ç¼–ç¨‹ä¸è½¯ä»¶å·¥ç¨‹çš„åŒºåˆ†ã€‚å‰è€…æ˜¯ä½ è‡ªå·±å†™çš„ä¸€ä¸ªç¨‹åºã€‚åè€…æ˜¯å¾ˆå¤šäººä¼šéšç€æ—¶é—´çš„æ¨ç§»è€Œå¼€å‘çš„äº§å“ã€‚å·¥ç¨‹å¸ˆä»¬æ¥æ¥å»å»ï¼Œå›¢é˜Ÿä¼šéšç€æ—¶é—´å¢é•¿ä¸ç¼©å°ï¼Œéœ€æ±‚ä¼šå‘ç”Ÿå˜åŒ–ï¼ŒåŠŸèƒ½ä¼šè¢«æ·»åŠ ï¼Œé”™è¯¯ä¹Ÿä¼šå¾—åˆ°ä¿®å¤ã€‚è¿™æ˜¯è½¯ä»¶å·¥ç¨‹çš„æœ¬è´¨ã€‚

æˆ‘å¯èƒ½æ˜¯è¿™ä¸ªæˆ¿é—´é‡Œ Go æœ€æ—©çš„ç”¨æˆ·ä¹‹ä¸€ï¼Œ~ä½†è¦äº‰è¾©è¯´æˆ‘çš„èµ„å†ç»™æˆ‘çš„çœ‹æ³•æ›´å¤šæ˜¯å‡çš„~ã€‚ç›¸åï¼Œä»Šå¤©æˆ‘è¦æçš„å»ºè®®æ˜¯åŸºäºæˆ‘è®¤ä¸ºçš„ Go è¯­è¨€æœ¬èº«çš„æŒ‡å¯¼åŸåˆ™ï¼š

1. ç®€å•æ€§
2. å¯è¯»æ€§
3. ç”Ÿäº§åŠ›

> æ³¨æ„:
> ä½ ä¼šæ³¨æ„åˆ°æˆ‘æ²¡æœ‰è¯´æ€§èƒ½æˆ–å¹¶å‘ã€‚æœ‰äº›è¯­è¨€æ¯” Go è¯­è¨€å¿«ä¸€ç‚¹ï¼Œä½†å®ƒä»¬è‚¯å®šä¸åƒ Go è¯­è¨€é‚£ä¹ˆç®€å•ã€‚æœ‰äº›è¯­è¨€ä½¿å¹¶å‘æˆä¸ºä»–ä»¬çš„æœ€é«˜ç›®æ ‡ï¼Œä½†å®ƒä»¬å¹¶ä¸å…·æœ‰å¯è¯»æ€§åŠç”Ÿäº§åŠ›ã€‚æ€§èƒ½å’Œå¹¶å‘æ˜¯é‡è¦çš„å±æ€§ï¼Œä½†ä¸å¦‚ç®€å•æ€§ï¼Œå¯è¯»æ€§å’Œç”Ÿäº§åŠ›é‚£ä¹ˆé‡è¦ã€‚

#### 1.1. ç®€å•æ€§

æˆ‘ä»¬ä¸ºä»€ä¹ˆè¦è¿½æ±‚ç®€å•ï¼Ÿä¸ºä»€ä¹ˆ Go è¯­è¨€ç¨‹åºçš„ç®€å•æ€§å¾ˆé‡è¦ï¼Ÿ

æˆ‘ä»¬éƒ½æ›¾é‡åˆ°è¿‡è¿™æ ·çš„æƒ…å†µ: â€œæˆ‘ä¸æ‡‚è¿™æ®µä»£ç â€ï¼Œä¸æ˜¯å—ï¼Ÿæˆ‘ä»¬éƒ½åšè¿‡è¿™æ ·çš„é¡¹ç›®:ä½ å®³æ€•åšå‡ºæ”¹å˜ï¼Œå› ä¸ºä½ æ‹…å¿ƒå®ƒä¼šç ´åç¨‹åºçš„å¦ä¸€éƒ¨åˆ†; ä½ ä¸ç†è§£çš„éƒ¨åˆ†ï¼Œä¸çŸ¥é“å¦‚ä½•ä¿®å¤ã€‚

è¿™å°±æ˜¯å¤æ‚æ€§ã€‚å¤æ‚æ€§æŠŠå¯é çš„è½¯ä»¶ä¸­å˜æˆä¸å¯é ã€‚å¤æ‚æ€§æ˜¯æ€æ­»è½¯ä»¶é¡¹ç›®çš„ç½ªé­ç¥¸é¦–ã€‚

ç®€å•æ€§æ˜¯ Go è¯­è¨€çš„æœ€é«˜ç›®æ ‡ã€‚ è®ºæˆ‘ä»¬ç¼–å†™ä»€ä¹ˆç¨‹åºï¼Œæˆ‘ä»¬éƒ½åº”è¯¥åŒæ„è¿™ä¸€ç‚¹:å®ƒä»¬å¾ˆç®€å•ã€‚

#### 1.2. å¯è¯»æ€§

> Readability is essential for maintainability.(å¯è¯»æ€§å¯¹äºå¯ç»´æŠ¤æ€§æ˜¯è‡³å…³é‡è¦çš„ã€‚) â€” Mark Reinhold (2018 JVM è¯­è¨€é«˜å±‚ä¼šè®®)

ä¸ºä»€ä¹ˆ Go è¯­è¨€çš„ä»£ç å¯è¯»æ€§æ˜¯å¾ˆé‡è¦çš„ï¼Ÿæˆ‘ä»¬ä¸ºä»€ä¹ˆè¦äº‰å–å¯è¯»æ€§ï¼Ÿ

> Programs must be written for people to read, and only incidentally for machines to execute. (ç¨‹åºåº”è¯¥è¢«å†™æ¥è®©äººä»¬é˜…è¯»ï¼Œåªæ˜¯é¡ºä¾¿ä¸ºäº†æœºå™¨æ‰§è¡Œã€‚) â€” Hal Abelson ä¸ Gerald Sussman (è®¡ç®—æœºç¨‹åºçš„ç»“æ„ä¸è§£é‡Š)

å¯è¯»æ€§å¾ˆé‡è¦ï¼Œå› ä¸ºæ‰€æœ‰è½¯ä»¶ä¸ä»…ä»…æ˜¯ Go è¯­è¨€ç¨‹åºï¼Œéƒ½æ˜¯ç”±äººç±»ç¼–å†™çš„ï¼Œä¾›ä»–äººé˜…è¯»ã€‚æ‰§è¡Œè½¯ä»¶çš„è®¡ç®—æœºåˆ™æ˜¯æ¬¡è¦çš„ã€‚

ä»£ç çš„è¯»å–æ¬¡æ•°æ¯”å†™å…¥æ¬¡æ•°å¤šã€‚ä¸€æ®µä»£ç åœ¨å…¶ç”Ÿå‘½å‘¨æœŸå†…ä¼šè¢«è¯»å–æ•°ç™¾æ¬¡ï¼Œç”šè‡³æ•°åƒæ¬¡ã€‚

> The most important skill for a programmer is the ability to effectively communicate ideas. (ç¨‹åºå‘˜æœ€é‡è¦çš„æŠ€èƒ½æ˜¯æœ‰æ•ˆæ²Ÿé€šæƒ³æ³•çš„èƒ½åŠ›ã€‚) â€” GastÃ³n Jorquera [[1]](<(https://gaston.life/books/effective-programming/)>)

å¯è¯»æ€§æ˜¯èƒ½å¤Ÿç†è§£ç¨‹åºæ­£åœ¨åšä»€ä¹ˆçš„å…³é”®ã€‚å¦‚æœä½ æ— æ³•ç†è§£ç¨‹åºæ­£åœ¨åšä»€ä¹ˆï¼Œé‚£ä½ å¸Œæœ›å¦‚ä½•ç»´æŠ¤å®ƒï¼Ÿå¦‚æœè½¯ä»¶æ— æ³•ç»´æŠ¤ï¼Œé‚£ä¹ˆå®ƒå°†è¢«é‡å†™;æœ€åè¿™å¯èƒ½æ˜¯ä½ çš„å…¬å¸æœ€åä¸€æ¬¡æŠ•èµ„ Go è¯­è¨€ã€‚

å¦‚æœä½ æ­£åœ¨ä¸ºè‡ªå·±ç¼–å†™ä¸€ä¸ªç¨‹åºï¼Œä¹Ÿè®¸å®ƒåªéœ€è¦è¿è¡Œä¸€æ¬¡ï¼Œæˆ–è€…ä½ æ˜¯å”¯ä¸€ä¸€ä¸ªæ›¾ç»çœ‹è¿‡å®ƒçš„äººï¼Œç„¶ååšä»»ä½•å¯¹ä½ æœ‰ç”¨çš„äº‹ã€‚ä½†æ˜¯ï¼Œå¦‚æœæ˜¯ä¸€ä¸ªä¸æ­¢ä¸€ä¸ªäººä¼šè´¡çŒ®ç¼–å†™çš„è½¯ä»¶ï¼Œæˆ–è€…åœ¨å¾ˆé•¿ä¸€æ®µæ—¶é—´å†…éœ€æ±‚ã€åŠŸèƒ½æˆ–è€…ç¯å¢ƒä¼šæ”¹å˜ï¼Œé‚£ä¹ˆä½ çš„ç›®æ ‡å¿…é¡»æ˜¯ä½ çš„ç¨‹åºå¯è¢«ç»´æŠ¤ã€‚

ç¼–å†™å¯ç»´æŠ¤ä»£ç çš„ç¬¬ä¸€æ­¥æ˜¯ç¡®ä¿ä»£ç å¯è¯»ã€‚

#### 1.3. ç”Ÿäº§åŠ›

> Design is the art of arranging code to work today, and be changeable forever. (è®¾è®¡æ˜¯å®‰æ’ä»£ç åˆ°å·¥ä½œçš„è‰ºæœ¯ï¼Œå¹¶ä¸”æ°¸è¿œå¯å˜ã€‚) â€” Sandi Metz

æˆ‘è¦å¼ºè°ƒçš„æœ€åä¸€ä¸ªåŸºæœ¬åŸåˆ™æ˜¯ç”Ÿäº§åŠ›ã€‚å¼€å‘äººå‘˜çš„å·¥ä½œæ•ˆç‡æ˜¯ä¸€ä¸ªåºå¤§çš„ä¸»é¢˜ï¼Œä½†å½’ç»“ä¸ºæ­¤; ä½ èŠ±å¤šå°‘æ—¶é—´åšæœ‰ç”¨çš„å·¥ä½œï¼Œè€Œä¸æ˜¯ç­‰å¾…ä½ çš„å·¥å…·æˆ–è¿·å¤±åœ¨ä¸€ä¸ªå¤–å›½çš„ä»£ç åº“é‡Œã€‚Go ç¨‹åºå‘˜åº”è¯¥è§‰å¾—ä»–ä»¬å¯ä»¥é€šè¿‡ Go è¯­è¨€å®Œæˆå¾ˆå¤šå·¥ä½œã€‚

æœ‰äººå¼€ç©ç¬‘è¯´ï¼ŒGo è¯­è¨€æ˜¯åœ¨ç­‰å¾… C ++è¯­è¨€ç¨‹åºç¼–è¯‘æ—¶è®¾è®¡çš„ã€‚å¿«é€Ÿç¼–è¯‘æ˜¯ Go è¯­è¨€çš„ä¸€ä¸ªå…³é”®ç‰¹æ€§ï¼Œä¹Ÿæ˜¯å¸å¼•æ–°å¼€å‘äººå‘˜çš„å…³é”®å·¥å…·ã€‚è™½ç„¶ç¼–è¯‘é€Ÿåº¦ä»ç„¶æ˜¯ä¸€ä¸ªæŒä¹…çš„æˆ˜åœºï¼Œä½†å¯ä»¥è¯´ï¼Œåœ¨å…¶ä»–è¯­è¨€ä¸­éœ€è¦å‡ åˆ†é’Ÿçš„ç¼–è¯‘ï¼Œåœ¨ Go è¯­è¨€ä¸­åªéœ€å‡ ç§’é’Ÿã€‚è¿™æœ‰åŠ©äº Go è¯­è¨€å¼€å‘äººå‘˜æ„Ÿå—åˆ°ä¸ä½¿ç”¨åŠ¨æ€è¯­è¨€çš„åŒè¡Œä¸€æ ·çš„é«˜æ•ˆï¼Œè€Œä¸”æ²¡æœ‰é‚£äº›è¯­è¨€å›ºæœ‰çš„å¯é æ€§é—®é¢˜ã€‚

å¯¹äºå¼€å‘äººå‘˜ç”Ÿäº§åŠ›é—®é¢˜æ›´ä¸ºåŸºç¡€çš„æ˜¯ï¼ŒGo ç¨‹åºå‘˜æ„è¯†åˆ°ç¼–å†™ä»£ç æ˜¯ä¸ºäº†é˜…è¯»ï¼Œå› æ­¤å°†è¯»ä»£ç çš„è¡Œä¸ºç½®äºç¼–å†™ä»£ç çš„è¡Œä¸ºä¹‹ä¸Šã€‚Go è¯­è¨€ç”šè‡³é€šè¿‡å·¥å…·å’Œè‡ªå®šä¹‰å¼ºåˆ¶æ‰§è¡Œæ‰€æœ‰ä»£ç ä»¥ç‰¹å®šæ ·å¼æ ¼å¼åŒ–ã€‚è¿™å°±æ¶ˆé™¤äº†é¡¹ç›®ä¸­å­¦ä¹ ç‰¹å®šæ ¼å¼çš„æ‘©æ“¦ï¼Œå¹¶å¸®åŠ©å‘ç°é”™è¯¯ï¼Œå› ä¸ºå®ƒä»¬çœ‹èµ·æ¥ä¸æ­£ç¡®ã€‚

Go ç¨‹åºå‘˜ä¸ä¼šèŠ±è´¹æ•´å¤©çš„æ—¶é—´æ¥è°ƒè¯•ä¸å¯æ€è®®çš„ç¼–è¯‘é”™è¯¯ã€‚ä»–ä»¬ä¹Ÿä¸ä¼šå°†æµªè´¹æ—¶é—´åœ¨å¤æ‚çš„æ„å»ºè„šæœ¬æˆ–åœ¨ç”Ÿäº§ä¸­éƒ¨ç½²ä»£ç ã€‚æœ€é‡è¦çš„æ˜¯ï¼Œä»–ä»¬ä¸ç”¨èŠ±è´¹æ—¶é—´æ¥è¯•å›¾äº†è§£ä»–ä»¬çš„åŒäº‹æ‰€å†™çš„å†…å®¹ã€‚

å½“ä»–ä»¬è¯´è¯­è¨€å¿…é¡»æ‰©å±•æ—¶ï¼ŒGo å›¢é˜Ÿä¼šè°ˆè®ºç”Ÿäº§åŠ›ã€‚

### 2. æ ‡è¯†ç¬¦

æˆ‘ä»¬è¦è®¨è®ºçš„ç¬¬ä¸€ä¸ªä¸»é¢˜æ˜¯æ ‡è¯†ç¬¦ã€‚æ ‡è¯†ç¬¦æ˜¯ä¸€ä¸ªç”¨æ¥è¡¨ç¤ºåç§°çš„èŠ±å“¨å•è¯; å˜é‡çš„åç§°ï¼Œå‡½æ•°çš„åç§°ï¼Œæ–¹æ³•çš„åç§°ï¼Œç±»å‹çš„åç§°ï¼ŒåŒ…çš„åç§°ç­‰ã€‚

> Poor naming is symptomatic of poor design. (å‘½åä¸ä½³æ˜¯è®¾è®¡ä¸ä½³çš„ç—‡çŠ¶ã€‚) â€” Dave Cheney

é‰´äº Go è¯­è¨€çš„è¯­æ³•æœ‰é™ï¼Œæˆ‘ä»¬ä¸ºç¨‹åºé€‰æ‹©çš„åç§°å¯¹æˆ‘ä»¬ç¨‹åºçš„å¯è¯»æ€§äº§ç”Ÿäº†éå¸¸å¤§çš„å½±å“ã€‚å¯è¯»æ€§æ˜¯è‰¯å¥½ä»£ç çš„å®šä¹‰è´¨é‡ï¼Œå› æ­¤é€‰æ‹©å¥½åç§°å¯¹äº Go ä»£ç çš„å¯è¯»æ€§è‡³å…³é‡è¦ã€‚

#### 2.1. é€‰æ‹©æ ‡è¯†ç¬¦æ˜¯ä¸ºäº†æ¸…æ™°ï¼Œè€Œä¸æ˜¯ç®€æ´

> Obvious code is important. What you can do in one line you should do in three.(æ¸…æ™°çš„ä»£ç å¾ˆé‡è¦ã€‚åœ¨ä¸€è¡Œå¯ä»¥åšçš„ä½ åº”å½“åˆ†ä¸‰è¡Œåšã€‚(if/else å—?)) â€” Ukiah Smith

Go è¯­è¨€ä¸æ˜¯ä¸ºäº†å•è¡Œè€Œä¼˜åŒ–çš„è¯­è¨€ã€‚Go è¯­è¨€ä¸æ˜¯ä¸ºäº†æœ€å°‘è¡Œç¨‹åºè€Œä¼˜åŒ–çš„è¯­è¨€ã€‚æˆ‘ä»¬æ²¡æœ‰ä¼˜åŒ–æºä»£ç çš„å¤§å°ï¼Œä¹Ÿæ²¡æœ‰ä¼˜åŒ–è¾“å…¥æ‰€éœ€çš„æ—¶é—´ã€‚

> Good naming is like a good joke. If you have to explain it, itâ€™s not funny.(å¥½çš„å‘½åå°±åƒä¸€ä¸ªå¥½ç¬‘è¯ã€‚å¦‚æœä½ å¿…é¡»è§£é‡Šå®ƒï¼Œé‚£å°±ä¸å¥½ç¬‘äº†ã€‚) â€” Dave Cheney

æ¸…æ™°çš„å…³é”®æ˜¯åœ¨ Go è¯­è¨€ç¨‹åºä¸­æˆ‘ä»¬é€‰æ‹©çš„æ ‡è¯†åç§°ã€‚è®©æˆ‘ä»¬è°ˆä¸€è°ˆæ‰€è°“å¥½çš„åå­—ï¼š

- **å¥½çš„åå­—å¾ˆç®€æ´ã€‚** å¥½çš„åå­—ä¸ä¸€å®šæ˜¯æœ€çŸ­çš„åå­—ï¼Œä½†å¥½çš„åå­—ä¸ä¼šæµªè´¹åœ¨æ— å…³çš„ä¸œè¥¿ä¸Šã€‚å¥½åå­—å…·æœ‰é«˜çš„ä¿¡å™ªæ¯”ã€‚

- **å¥½çš„åå­—æ˜¯æè¿°æ€§çš„ã€‚** å¥½çš„åå­—ä¼šæè¿°å˜é‡æˆ–å¸¸é‡çš„åº”ç”¨ï¼Œè€Œä¸æ˜¯å®ƒä»¬çš„å†…å®¹ã€‚å¥½çš„åå­—åº”è¯¥æè¿°å‡½æ•°çš„ç»“æœæˆ–æ–¹æ³•çš„è¡Œä¸ºï¼Œè€Œä¸æ˜¯å®ƒä»¬çš„æ“ä½œã€‚å¥½çš„åå­—åº”è¯¥æè¿°åŒ…çš„ç›®çš„è€Œéå®ƒçš„å†…å®¹ã€‚æè¿°ä¸œè¥¿è¶Šå‡†ç¡®çš„åå­—å°±è¶Šå¥½ã€‚

- **å¥½çš„åå­—åº”è¯¥æ˜¯å¯é¢„æµ‹çš„ã€‚** ä½ èƒ½å¤Ÿä»åå­—ä¸­æ¨æ–­å‡ºä½¿ç”¨æ–¹å¼ã€‚è¿™æ˜¯é€‰æ‹©æè¿°æ€§åç§°çš„åŠŸèƒ½ï¼Œä½†å®ƒä¹Ÿéµå¾ªä¼ ç»Ÿã€‚è¿™æ˜¯ Go ç¨‹åºå‘˜åœ¨è°ˆåˆ°ä¹ æƒ¯ç”¨è¯­æ—¶æ‰€è°ˆè®ºçš„å†…å®¹ã€‚

è®©æˆ‘ä»¬æ·±å…¥è®¨è®ºä»¥ä¸‹è¿™äº›å±æ€§ã€‚

#### 2.2. æ ‡è¯†ç¬¦é•¿åº¦

æœ‰æ—¶å€™äººä»¬æ‰¹è¯„ Go è¯­è¨€æ¨èçŸ­å˜é‡åçš„é£æ ¼ã€‚æ­£å¦‚ Rob Pike æ‰€è¯´ï¼Œâ€œGo ç¨‹åºå‘˜æƒ³è¦æ­£ç¡®çš„é•¿åº¦çš„æ ‡è¯†ç¬¦â€ã€‚ [[1]](https://www.lysator.liu.se/c/pikestyle.html)

Andrew Gerrand å»ºè®®é€šè¿‡å¯¹æŸäº›äº‹ç‰©ä½¿ç”¨æ›´é•¿çš„æ ‡è¯†ï¼Œå‘è¯»è€…è¡¨æ˜å®ƒä»¬å…·æœ‰æ›´é«˜çš„é‡è¦æ€§ã€‚

> The greater the distance between a nameâ€™s declaration and its uses, the longer the name should be. (åå­—çš„å£°æ˜ä¸å…¶ä½¿ç”¨ä¹‹é—´çš„è·ç¦»è¶Šå¤§ï¼Œåå­—åº”è¯¥è¶Šé•¿ã€‚) â€” Andrew GerrandÂ [[2]](https://talks.golang.org/2014/names.slide#4)

ç”±æ­¤æˆ‘ä»¬å¯ä»¥å¾—å‡ºä¸€äº›æŒ‡å¯¼æ–¹é’ˆï¼š

- çŸ­å˜é‡åç§°åœ¨å£°æ˜å’Œä¸Šæ¬¡ä½¿ç”¨ä¹‹é—´çš„è·ç¦»å¾ˆçŸ­æ—¶æ•ˆæœå¾ˆå¥½ã€‚
- **é•¿å˜é‡åç§°éœ€è¦è¯æ˜è‡ªå·±çš„åˆç†æ€§; åç§°è¶Šé•¿ï¼Œéœ€è¦æä¾›çš„ä»·å€¼è¶Šé«˜ã€‚å†—é•¿çš„åç§°ä¸é¡µé¢ä¸Šçš„é‡é‡ç›¸æ¯”ï¼Œä¿¡æ¯é‡è¾ƒå°**ã€‚
- è¯·å‹¿åœ¨å˜é‡åç§°ä¸­åŒ…å«ç±»å‹åç§°ã€‚
- å¸¸é‡åº”è¯¥æè¿°å®ƒä»¬æŒæœ‰çš„å€¼ï¼Œè€Œä¸æ˜¯è¯¥å¦‚ä½•ä½¿ç”¨ã€‚
- å¯¹äºå¾ªç¯å’Œåˆ†æ”¯ä½¿ç”¨å•å­—æ¯å˜é‡ï¼Œå‚æ•°å’Œè¿”å›å€¼ä½¿ç”¨ 1 ä¸ªå•è¯ï¼Œå‡½æ•°å’ŒåŒ…çº§åˆ«å£°æ˜ä½¿ç”¨å¤šä¸ªå•è¯ã€‚
- æ–¹æ³•ã€æ¥å£å’ŒåŒ…ä½¿ç”¨ 1 ä¸ªå•è¯ã€‚(_æ¯”å¦‚ï¼ŒReader, Writer, fmt.Println_)
- è¯·è®°ä½ï¼ŒåŒ…çš„åç§°æ˜¯è°ƒç”¨è€…ç”¨æ¥å¼•ç”¨åç§°çš„ä¸€éƒ¨åˆ†ï¼Œå› æ­¤è¦å¥½å¥½åˆ©ç”¨è¿™ä¸€ç‚¹ã€‚

æˆ‘ä»¬æ¥ä¸¾ä¸ªä¾‹å­:

```go
type Person struct {
	Name string
	Age  int
}

// AverageAge returns the average age of people.
func AverageAge(people []Person) int {
	if len(people) == 0 {
		return 0
	}

	var count, sum int
	for _, p := range people {
		sum += p.Age
		count += 1
	}

	return sum / count
}
```

åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œå˜é‡`p`çš„åœ¨ç¬¬`10`è¡Œè¢«å£°æ˜å¹¶ä¸”ä¹Ÿåªåœ¨æ¥ä¸‹æ¥çš„ä¸€è¡Œä¸­è¢«å¼•ç”¨ã€‚`p`åœ¨æ‰§è¡Œå‡½æ•°æœŸé—´å­˜åœ¨æ—¶é—´å¾ˆçŸ­ã€‚å¦‚æœè¦äº†è§£`p`çš„ä½œç”¨åªéœ€é˜…è¯»ä¸¤è¡Œä»£ç ã€‚

ç›¸æ¯”ä¹‹ä¸‹ï¼Œ`people`åœ¨å‡½æ•°ç¬¬`7`è¡Œå‚æ•°ä¸­è¢«å£°æ˜ã€‚`sum`å’Œ`count`ä¹Ÿæ˜¯å¦‚æ­¤ï¼Œä»–ä»¬ç”¨äº†æ›´é•¿çš„åå­—ã€‚è¯»è€…å¿…é¡»æŸ¥çœ‹æ›´å¤šçš„è¡Œæ•°æ¥å®šä½å®ƒä»¬ï¼Œå› æ­¤ä»–ä»¬åå­—æ›´ä¸ºç‹¬ç‰¹ã€‚

æˆ‘å¯ä»¥é€‰æ‹©`s`æ›¿ä»£`sum`ä»¥åŠ`c`ï¼ˆæˆ–å¯èƒ½æ˜¯`n`ï¼‰æ›¿ä»£`count`ï¼Œä½†æ˜¯è¿™æ ·åšä¼šå°†ç¨‹åºä¸­çš„æ‰€æœ‰å˜é‡ä»½é‡é™ä½åˆ°åŒæ ·çš„çº§åˆ«ã€‚æˆ‘å¯ä»¥é€‰æ‹©`p`æ¥ä»£æ›¿`people`ï¼Œä½†æ˜¯ç”¨ä»€ä¹ˆæ¥è°ƒç”¨`for ... range`è¿­ä»£å˜é‡ã€‚å¦‚æœç”¨`person`çš„è¯çœ‹èµ·æ¥å¾ˆå¥‡æ€ªï¼Œå› ä¸ºå¾ªç¯è¿­ä»£å˜é‡çš„ç”Ÿå‘½æ—¶é—´å¾ˆçŸ­ï¼Œå…¶åå­—çš„é•¿åº¦è¶…å‡ºäº†å®ƒçš„å€¼ã€‚

> è´´å£«:åƒå¯¹æ–‡æ¡£åˆ†æ®µä¸€æ ·ï¼Œä½¿ç”¨ç”¨ç©ºè¡Œå¯¹å‡½æ•°åˆ†æ®µã€‚åœ¨`AverageAge`ä¸­ï¼ŒæŒ‰é¡ºåºå…±æœ‰ä¸‰ä¸ªæ“ä½œã€‚ç¬¬ä¸€ä¸ªæ˜¯å‰ææ¡ä»¶ï¼Œæ£€æŸ¥`people`æ˜¯å¦ä¸ºç©ºï¼Œç¬¬äºŒä¸ªæ˜¯`sum`å’Œ`count`çš„ç´¯ç§¯ï¼Œæœ€åæ˜¯å¹³å‡å€¼çš„è®¡ç®—ã€‚

#### 2.2.1. ä¸Šä¸‹æ–‡æ˜¯å…³é”®

é‡è¦çš„æ˜¯è¦æ„è¯†åˆ°å…³äºå‘½åçš„å¤§å¤šæ•°å»ºè®®éƒ½æ˜¯éœ€è¦è€ƒè™‘ä¸Šä¸‹æ–‡çš„ã€‚æˆ‘æƒ³è¯´è¿™æ˜¯ä¸€ä¸ªåŸåˆ™ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªè§„åˆ™ã€‚

ä¸¤ä¸ªæ ‡è¯†ç¬¦`i`å’Œ`index`ä¹‹é—´æœ‰ä»€ä¹ˆåŒºåˆ«ã€‚æˆ‘ä»¬ä¸èƒ½æ–­å®šä¸€ä¸ªå°±æ¯”å¦ä¸€ä¸ªå¥½ï¼Œä¾‹å¦‚

```go
for index := 0; index < len(s); index++ {
	//
}
```

ä»æ ¹æœ¬ä¸Šè¯´ï¼Œä¸Šé¢çš„ä»£ç æ›´å…·æœ‰å¯è¯»æ€§

```go
for i := 0; i < len(s); i++ {
	//
}
```

æˆ‘è®¤ä¸ºå®ƒä¸æ˜¯ï¼Œå› ä¸ºå°±æ­¤äº‹è€Œè®º, `i`å’Œ`index`çš„èŒƒå›´å¾ˆå¤§å¯èƒ½ä¸Šä»…é™äº for å¾ªç¯çš„ä¸»ä½“ï¼Œå‰è€…çš„é¢å¤–å†—é•¿æ€§(æŒ‡`index`)å‡ ä¹æ²¡æœ‰å¢åŠ å¯¹äºç¨‹åºçš„ç†è§£ã€‚

ä½†æ˜¯ï¼Œä¸‹é¢å“ªäº›å‡½æ•°æ›´å…·å¯è¯»æ€§ï¼Ÿ

```go
func (s *SNMP) Fetch(oid []int, index int) (int, error)
```

æˆ–

```go
func (s *SNMP) Fetch(o []int, i int) (int, error)
```

åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œ`oid`æ˜¯`SNMP Object ID`çš„ç¼©å†™ï¼Œå¦‚æœå°†å…¶ç¼©çŸ­ä¸º`o`ï¼Œæ„å‘³ç€ç¨‹åºå‘˜å¿…é¡»è¦é˜…è¯»æ–‡æ¡£æ‰èƒ½ç†è§£è¿™ä¸ªç¬¦å·çš„å«ä¹‰ã€‚ç±»ä¼¼åœ°å°†`index`æ›¿æ¢æˆ`i`, æ¨¡ç³Šäº†`i`æ‰€ä»£è¡¨çš„å«ä¹‰ï¼š`SNMP`æ¶ˆæ¯ä¸­ï¼Œ`index`æŒ‡æ¯ä¸ª`OID`çš„å­å€¼ã€‚

> è´´å£«: ä¸è¦åœ¨åŒä¸€å£°æ˜ä¸­ï¼ŒåŒæ—¶ä½¿ç”¨é•¿å’ŒçŸ­å½¢å¼çš„å‚æ•°åç§°ã€‚

#### 2.3. ä¸è¦ç”¨å˜é‡ç±»å‹å‘½åä½ çš„å˜é‡

ä½ ä¸åº”è¯¥ç”¨å˜é‡çš„ç±»å‹æ¥å‘½åä½ çš„å˜é‡, å°±åƒæ‚¨ä¸ä¼šå°†å® ç‰©å‘½åä¸ºâ€œç‹—â€å’Œâ€œçŒ«â€ã€‚å‡ºäºåŒæ ·çš„åŸå› ï¼Œæ‚¨ä¹Ÿä¸åº”åœ¨å˜é‡åå­—ä¸­åŒ…å«ç±»å‹çš„åå­—ã€‚

å˜é‡çš„åç§°åº”æè¿°å…¶å†…å®¹ï¼Œè€Œä¸æ˜¯å†…å®¹çš„ç±»å‹ã€‚ä¾‹å¦‚ï¼š

```go
var usersMap map[string]*User
```

è¿™ä¸ªå£°æ˜æœ‰ä»€ä¹ˆå¥½å¤„ï¼Ÿ æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å®ƒæ˜¯ä¸€ä¸ª`map`ï¼Œå®ƒä¸`*User`ç±»å‹æœ‰å…³ã€‚ä½†æ˜¯`usersMap`æ˜¯ä¸€ä¸ª`map`ï¼Œè€Œ Go è¯­è¨€æ˜¯ä¸€ç§é™æ€ç±»å‹çš„è¯­è¨€ï¼Œå¦‚æœæ²¡æœ‰å®šä¹‰å˜é‡,ä¸ä¼šè®©æˆ‘ä»¬æ„å¤–åœ°ä½¿ç”¨åˆ°å®ƒï¼Œå› æ­¤`Map`åç¼€æ˜¯å¤šä½™çš„ã€‚

æ¥ä¸‹æ¥, å¦‚æœæˆ‘ä»¬åƒè¿™æ ·æ¥å£°æ˜å…¶ä»–å˜é‡ï¼š

```go
var (
	companiesMap map[string]*Company
	productsMap map[string]*Products
)
```

`usersMap`ï¼Œ`companiesMap`å’Œ`productsMap` ä¸‰ä¸ª`map`ç±»å‹å˜é‡ï¼Œæ‰€æœ‰æ˜ å°„å­—ç¬¦ä¸²éƒ½æ˜¯ä¸åŒçš„ç±»å‹ã€‚æˆ‘ä»¬çŸ¥é“å®ƒä»¬æ˜¯`map`ï¼Œæˆ‘ä»¬ä¹ŸçŸ¥é“æˆ‘ä»¬ä¸èƒ½ä½¿ç”¨å…¶ä¸­ä¸€ä¸ªæ¥ä»£æ›¿å¦ä¸€ä¸ª - å¦‚æœæˆ‘ä»¬åœ¨éœ€è¦`map[string]*User`çš„åœ°æ–¹å°è¯•ä½¿ç”¨`companiesMap`, ç¼–è¯‘å™¨å°†æŠ›å‡ºé”™è¯¯å¼‚å¸¸ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¾ˆæ˜æ˜¾å˜é‡ä¸­`Map`åç¼€å¹¶æ²¡æœ‰æé«˜ä»£ç çš„æ¸…æ™°åº¦ï¼Œå®ƒåªæ˜¯å¢åŠ äº†è¦è¾“å…¥çš„é¢å¤–æ ·æ¿ä»£ç ã€‚

æˆ‘çš„å»ºè®®æ˜¯é¿å…ä½¿ç”¨ä»»ä½•ç±»ä¼¼å˜é‡ç±»å‹çš„åç¼€ã€‚

> è´´å£«: å¦‚æœ`users`çš„æè¿°æ€§éƒ½ä¸å¤Ÿç”¨ï¼Œé‚£ä¹ˆ`usersMap`ä¹Ÿä¸ä¼šã€‚

æ­¤å»ºè®®ä¹Ÿé€‚ç”¨äºå‡½æ•°å‚æ•°ã€‚ä¾‹å¦‚ï¼š

```go
type Config struct {
	//
}

func WriteConfig(w io.Writer, config *Config)
```

å‘½å`*Config`å‚æ•°`config`æ˜¯å¤šä½™çš„ã€‚æˆ‘ä»¬çŸ¥é“å®ƒæ˜¯`*Config`ç±»å‹ï¼Œå°±æ˜¯è¿™æ ·ã€‚

åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¦‚æœå˜é‡çš„ç”Ÿå‘½å‘¨æœŸè¶³å¤ŸçŸ­ï¼Œè¯·è€ƒè™‘ä½¿ç”¨`conf`æˆ–`c`ã€‚

å¦‚æœæœ‰æ›´å¤šçš„`*Config`ï¼Œé‚£ä¹ˆå°†å®ƒä»¬ç§°ä¸º`original`å’Œ`updated`æ¯”`conf1`å’Œ`conf2`ä¼šæ›´å…·æè¿°æ€§ï¼Œå› ä¸ºå‰è€…ä¸å¤ªå¯èƒ½è¢«äº’ç›¸è¯¯è§£ã€‚

> è´´å£«: ä¸è¦è®©åŒ…åçªƒå–å¥½çš„å˜é‡åã€‚

> å¯¼å…¥æ ‡è¯†ç¬¦çš„åç§°åŒ…æ‹¬å…¶åŒ…åç§°ã€‚ä¾‹å¦‚ï¼Œ`context`åŒ…ä¸­çš„`Context`ç±»å‹å°†è¢«ç§°ä¸º`context.Context`ã€‚è¿™ä½¿å¾—æ— æ³•å°†`context`ç”¨ä½œåŒ…ä¸­çš„å˜é‡æˆ–ç±»å‹ã€‚

```go
func WriteLog(context context.Context, message string)
```

> ä¸Šé¢çš„ä¾‹å­å°†ä¼šç¼–è¯‘å‡ºé”™ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆ`context.Context`ç±»å‹çš„é€šå¸¸çš„æœ¬åœ°å£°æ˜æ˜¯`ctx`ã€‚ä¾‹å¦‚ï¼š

```go
func WriteLog(ctx context.Context, message string)
```

#### 2.4. ä½¿ç”¨ä¸€è‡´çš„å‘½åæ–¹å¼

ä¸€ä¸ªå¥½åå­—çš„å¦ä¸€ä¸ªå±æ€§æ˜¯å®ƒåº”è¯¥æ˜¯å¯é¢„æµ‹çš„ã€‚åœ¨ç¬¬ä¸€æ¬¡é‡åˆ°è¯¥åå­—æ—¶è¯»è€…å°±èƒ½å¤Ÿç†è§£åå­—çš„ä½¿ç”¨ã€‚å½“ä»–ä»¬é‡åˆ°å¸¸è§çš„åå­—æ—¶ï¼Œä»–ä»¬åº”è¯¥èƒ½å¤Ÿè®¤ä¸ºè‡ªä»ä»–ä»¬ä¸Šæ¬¡çœ‹åˆ°å®ƒä»¥æ¥å®ƒæ²¡æœ‰æ”¹å˜æ„ä¹‰ã€‚

ä¾‹å¦‚ï¼Œå¦‚æœæ‚¨çš„ä»£ç åœ¨å¤„ç†æ•°æ®åº“è¯·ç¡®ä¿æ¯æ¬¡å‡ºç°å‚æ•°æ—¶ï¼Œå®ƒéƒ½å…·æœ‰ç›¸åŒçš„åç§°ã€‚ä¸å…¶ä½¿ç”¨`d * sql.DB`ï¼Œ`dbase * sql.DB`ï¼Œ`DB * sql.DB`å’Œ`database * sql.DB`çš„ç»„åˆï¼Œå€’ä¸å¦‚ç»Ÿä¸€ä½¿ç”¨:

```go
db *sql.DB
```

è¿™æ ·åšä½¿è¯»è€…æ›´ä¸ºç†Ÿæ‚‰; å¦‚æœä½ çœ‹åˆ°`db`ï¼Œä½ çŸ¥é“å®ƒå°±æ˜¯`*sql.DB`å¹¶ä¸”å®ƒå·²ç»åœ¨æœ¬åœ°å£°æ˜æˆ–è€…ç”±è°ƒç”¨è€…ä¸ºä½ æä¾›ã€‚

ç±»ä¼¼åœ°ï¼Œå¯¹äºæ–¹æ³•æ¥æ”¶å™¨: åœ¨è¯¥ç±»å‹çš„æ¯ä¸ªæ–¹æ³•ä¸Šä½¿ç”¨ç›¸åŒçš„æ¥æ”¶è€…åç§°ã€‚åœ¨è¿™ç§ç±»å‹çš„æ–¹æ³•å†…éƒ¨å¯ä»¥ä½¿è¯»è€…æ›´å®¹æ˜“ä½¿ç”¨ã€‚ï¼ˆ*æ³¨ï¼š`func (p *Person)Name()string{}`å…¶ä¸­çš„`p`ä¸ºæ–¹æ³•æ¥æ”¶å™¨åç§°\*ï¼‰

> æ³¨æ„:

    Goè¯­è¨€ä¸­çš„çŸ­æ¥æ”¶è€…åç§°æƒ¯ä¾‹ä¸ç›®å‰æä¾›çš„å»ºè®®ä¸ä¸€è‡´ã€‚è¿™åªæ˜¯æ—©æœŸåšå‡ºçš„é€‰æ‹©ä¹‹ä¸€ï¼Œå·²ç»æˆä¸ºé¦–é€‰çš„é£æ ¼ï¼Œå°±åƒä½¿ç”¨`CamelCase`è€Œä¸æ˜¯`snake_case`ä¸€æ ·ã€‚

> è´´å£«:

    Goè¯­è¨€æ ·å¼è§„å®šæ¥æ”¶å™¨å…·æœ‰å•ä¸ªå­—æ¯åç§°æˆ–ä»å…¶ç±»å‹æ´¾ç”Ÿçš„é¦–å­—æ¯ç¼©ç•¥è¯ã€‚ä½ å¯èƒ½ä¼šå‘ç°æ¥æ”¶å™¨çš„åç§°æœ‰æ—¶ä¼šä¸æ–¹æ³•ä¸­å‚æ•°çš„åç§°å†²çªã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œè¯·è€ƒè™‘å°†å‚æ•°åç§°å‘½åç¨é•¿ï¼Œå¹¶ä¸”ä¸è¦å¿˜è®°ä¸€è‡´åœ°ä½¿ç”¨æ­¤æ–°å‚æ•°åç§°ã€‚

æœ€åï¼ŒæŸäº›å•å­—æ¯å˜é‡ä¼ ç»Ÿä¸Šä¸å¾ªç¯å’Œè®¡æ•°ç›¸å…³è”ã€‚ä¾‹å¦‚ï¼Œ`i`ï¼Œ`j`å’Œ`k`é€šå¸¸æ˜¯ç®€å•`for`å¾ªç¯çš„å¾ªç¯å½’çº³å˜é‡ã€‚`n`é€šå¸¸ä¸è®¡æ•°å™¨æˆ–ç´¯åŠ å™¨ç›¸å…³è”ã€‚`v`æ˜¯é€šç”¨ç¼–ç å‡½æ•°ä¸­å€¼çš„å¸¸ç”¨ç®€å†™ï¼Œ`k`é€šå¸¸ç”¨äº`map`çš„é”®ï¼Œ`s`é€šå¸¸ç”¨ä½œå­—ç¬¦ä¸²ç±»å‹å‚æ•°çš„ç®€å†™ã€‚

ä¸ä¸Šé¢çš„`db`ç¤ºä¾‹ä¸€æ ·ï¼Œç¨‹åºå‘˜è®¤ä¸º`i`æ˜¯ä¸€ä¸ªå¾ªç¯å½’çº³å˜é‡ã€‚å¦‚æœç¡®ä¿`i`å§‹ç»ˆæ˜¯å¾ªç¯å˜é‡ï¼Œè€Œä¸”ä¸åœ¨`for`å¾ªç¯ä¹‹å¤–çš„å…¶ä»–åœ°æ–¹ä¸­ä½¿ç”¨ã€‚å½“è¯»è€…é‡åˆ°ä¸€ä¸ªåä¸º`i`æˆ–`j`çš„å˜é‡æ—¶ï¼Œä»–ä»¬çŸ¥é“å¾ªç¯å°±åœ¨é™„è¿‘ã€‚

> è´´å£«:

    å¦‚æœä½ å‘ç°è‡ªå·±æœ‰å¦‚æ­¤å¤šçš„åµŒå¥—å¾ªç¯ï¼Œ`i`ï¼Œ`j`å’Œ`k`å˜é‡éƒ½æ— æ³•æ»¡è¶³æ—¶ï¼Œè¿™ä¸ªæ—¶å€™å¯èƒ½å°±æ˜¯éœ€è¦å°†å‡½æ•°åˆ†è§£æˆæ›´å°çš„å‡½æ•°ã€‚

#### 2.5. ä½¿ç”¨ä¸€è‡´çš„å£°æ˜æ ·å¼

Go è‡³å°‘æœ‰å…­ç§ä¸åŒçš„æ–¹å¼æ¥å£°æ˜å˜é‡

- `var x int = 1`
- `var x = 1`
- `var x int; x = 1`
- `var x = int(1)`
- `x := 1`

æˆ‘ç¡®ä¿¡è¿˜æœ‰æ›´å¤šæˆ‘æ²¡æœ‰æƒ³åˆ°çš„ã€‚è¿™å¯èƒ½æ˜¯ Go è¯­è¨€çš„è®¾è®¡å¸ˆæ„è¯†åˆ°çš„ä¸€ä¸ªé”™è¯¯ï¼Œä½†ç°åœ¨æ”¹å˜å®ƒä¸ºæ—¶å·²æ™šã€‚é€šè¿‡æ‰€æœ‰è¿™äº›ä¸åŒçš„æ–¹å¼æ¥å£°æ˜å˜é‡ï¼Œæˆ‘ä»¬å¦‚ä½•é¿å…æ¯ä¸ª Go ç¨‹åºå‘˜é€‰æ‹©è‡ªå·±çš„é£æ ¼ï¼Ÿ

æˆ‘æƒ³å°±å¦‚ä½•åœ¨ç¨‹åºä¸­å£°æ˜å˜é‡æå‡ºå»ºè®®ã€‚ è¿™æ˜¯æˆ‘å°½å¯èƒ½ä½¿ç”¨çš„é£æ ¼ã€‚

- **å£°æ˜å˜é‡ä½†æ²¡æœ‰åˆå§‹åŒ–æ—¶ï¼Œè¯·ä½¿ç”¨`var`ã€‚** å½“å£°æ˜å˜é‡ç¨åå°†åœ¨å‡½æ•°ä¸­åˆå§‹åŒ–æ—¶ï¼Œè¯·ä½¿ç”¨`var`å…³é”®å­—ã€‚

```go
var players int    // 0

var things []Thing // an empty slice of Things

var thing Thing    // empty Thing struct
json.Unmarshall(reader, &thing)
```

`var`è¡¨ç¤ºæ­¤å˜é‡å·²è¢«å£°æ˜ä¸ºæŒ‡å®šç±»å‹çš„é›¶å€¼ã€‚è¿™ä¹Ÿä¸ä½¿ç”¨`var`è€Œä¸æ˜¯çŸ­å£°æ˜è¯­æ³•åœ¨åŒ…çº§åˆ«å£°æ˜å˜é‡çš„è¦æ±‚ä¸€è‡´ - å°½ç®¡æˆ‘ç¨åä¼šè¯´ä½ æ ¹æœ¬ä¸åº”è¯¥ä½¿ç”¨åŒ…çº§å˜é‡ã€‚

- **åœ¨å£°æ˜å’Œåˆå§‹åŒ–æ—¶ï¼Œä½¿ç”¨`:=`ã€‚** åœ¨åŒæ—¶å£°æ˜å’Œåˆå§‹åŒ–å˜é‡æ—¶ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬ä¸ä¼šå°†å˜é‡åˆå§‹åŒ–ä¸ºé›¶å€¼ï¼Œæˆ‘å»ºè®®ä½¿ç”¨çŸ­å˜é‡å£°æ˜ã€‚ è¿™ä½¿å¾—è¯»è€…æ¸…æ¥šåœ°çŸ¥é“`:=`å·¦ä¾§çš„å˜é‡æ˜¯åˆå§‹åŒ–è¿‡çš„ã€‚

ä¸ºäº†è§£é‡ŠåŸå› ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹å‰é¢çš„ä¾‹å­ï¼Œä½†è¿™æ¬¡æ˜¯åˆå§‹åŒ–æ¯ä¸ªå˜é‡ï¼š

```go
var players int = 0

var things []Thing = nil

var thing *Thing = new(Thing)
json.Unmarshall(reader, thing)
```

åœ¨ç¬¬ä¸€ä¸ªå’Œç¬¬ä¸‰ä¸ªä¾‹å­ä¸­ï¼Œå› ä¸ºåœ¨ Go è¯­è¨€ä¸­æ²¡æœ‰ä»ä¸€ç§ç±»å‹åˆ°å¦ä¸€ç§ç±»å‹çš„è‡ªåŠ¨è½¬æ¢; èµ‹å€¼è¿ç®—ç¬¦å·¦ä¾§çš„ç±»å‹å¿…é¡»ä¸å³ä¾§çš„ç±»å‹ç›¸åŒã€‚ ç¼–è¯‘å™¨å¯ä»¥ä»å³ä¾§çš„ç±»å‹æ¨æ–­å‡ºå£°æ˜çš„å˜é‡çš„ç±»å‹ï¼Œä¸Šé¢çš„ä¾‹å­å¯ä»¥æ›´ç®€æ´åœ°å†™ä¸ºï¼š

```go
var players = 0

var things []Thing = nil

var thing = new(Thing)
json.Unmarshall(reader, thing)
```

æˆ‘ä»¬å°†`players`åˆå§‹åŒ–ä¸º`0`ï¼Œä½†è¿™æ˜¯å¤šä½™çš„ï¼Œå› ä¸º`0`æ˜¯`players`çš„é›¶å€¼ã€‚å› æ­¤ï¼Œè¦æ˜ç¡®åœ°è¡¨ç¤ºä½¿ç”¨é›¶å€¼, æˆ‘ä»¬å°†ä¸Šé¢ä¾‹å­æ”¹å†™ä¸º:

```go
var players int
```

ç¬¬äºŒä¸ªå£°æ˜å¦‚ä½•ï¼Ÿ æˆ‘ä»¬ä¸èƒ½çœç•¥ç±»å‹è€Œå†™ä½œ:

```go
var things = nil
```

å› ä¸º nil æ²¡æœ‰ç±»å‹ã€‚ [[2]](https://speakerdeck.com/campoy/understanding-nil)ç›¸åï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªé€‰æ‹©ï¼Œå¦‚æœæˆ‘ä»¬è¦ä½¿ç”¨åˆ‡ç‰‡çš„é›¶å€¼åˆ™å†™ä½œ:

```go
var things []Thing
```

æˆ–è€…æˆ‘ä»¬è¦åˆ›å»ºä¸€ä¸ªæœ‰é›¶å…ƒç´ çš„åˆ‡ç‰‡åˆ™å†™ä½œ:

```go
var things = make([]Thing, 0)
```

å¦‚æœæˆ‘ä»¬æƒ³è¦åè€…é‚£ä¹ˆè¿™ä¸æ˜¯åˆ‡ç‰‡çš„é›¶å€¼ï¼Œæ‰€ä»¥æˆ‘ä»¬åº”è¯¥å‘è¯»è€…è¯´æ˜æˆ‘ä»¬é€šè¿‡ä½¿ç”¨ç®€çŸ­çš„å£°æ˜å½¢å¼åšå‡ºè¿™ä¸ªé€‰æ‹©ï¼š

```go
things := make([]Thing, 0)
```

è¿™å‘Šè¯‰è¯»è€…æˆ‘ä»¬å·²é€‰æ‹©æ˜ç¡®åˆå§‹åŒ–äº‹ç‰©ã€‚

ä¸‹é¢æ˜¯ç¬¬ä¸‰ä¸ªå£°æ˜ï¼Œ

```go
var thing = new(Thing)
```

æ—¢æ˜¯åˆå§‹åŒ–äº†å˜é‡åˆå¼•å…¥äº†ä¸€äº› Go ç¨‹åºå‘˜ä¸å–œæ¬¢çš„`new`å…³é”®å­—çš„ç½•è§ç”¨æ³•ã€‚å¦‚æœæˆ‘ä»¬ç”¨æ¨èåœ°ç®€çŸ­å£°æ˜è¯­æ³•ï¼Œé‚£ä¹ˆå°±å˜æˆäº†:

```go
thing := new(Thing)
```

è¿™æ¸…æ¥šåœ°è¡¨æ˜`thing`è¢«åˆå§‹åŒ–ä¸º`new(Thing)`çš„ç»“æœ - ä¸€ä¸ªæŒ‡å‘`Thing`çš„æŒ‡é’ˆ - ä½†ä¾æ—§æˆ‘ä»¬ä½¿ç”¨äº†`new`åœ°ç½•è§ç”¨æ³•ã€‚ æˆ‘ä»¬å¯ä»¥é€šè¿‡ä½¿ç”¨ç´§å‡‘çš„æ–‡å­—ç»“æ„åˆå§‹åŒ–å½¢å¼æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œ

```go
thing := &Thing{}
```

ä¸`new(Thing)`ç›¸åŒï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆä¸€äº› Go ç¨‹åºå‘˜å¯¹é‡å¤æ„Ÿåˆ°ä¸æ»¡ã€‚ç„¶è€Œï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬ä½¿ç”¨æŒ‡å‘`Thing{}`çš„æŒ‡é’ˆåˆå§‹åŒ–äº†`thing`ï¼Œä¹Ÿå°±æ˜¯`Thing`çš„é›¶å€¼ã€‚ï¼ˆ_æ³¨æ„ï¼š`Thing`çš„é›¶å€¼å¹¶ä¸æ˜¯`nil`ï¼Œè€Œæ˜¯å…¶ä¸­å­—æ®µçš„å€¼ä¸ºå„ç±»å‹çš„é›¶å€¼ã€‚å½“æˆ‘åˆ›å»ºä¸€ä¸ªå¯¹è±¡ï¼Œå¹¶å¾—åˆ°è¯¥å¯¹è±¡çš„åœ°å€æ—¶ï¼Œæˆ‘æœ€å–œæ¬¢è¿™ç§åšæ³•ã€‚_ï¼‰

ç›¸åï¼Œæˆ‘ä»¬åº”è¯¥è®¤è¯†åˆ°`thing`è¢«å£°æ˜ä¸ºé›¶å€¼ï¼Œå¹¶ä½¿ç”¨åœ°å€è¿ç®—ç¬¦å°†`thing`çš„åœ°å€ä¼ é€’ç»™`json.Unmarshall`

```go
var thing Thing
json.Unmarshall(reader, &thing)
```

> è´´å£«:
> å½“ç„¶ï¼Œä»»ä½•ç»éªŒæ³•åˆ™ï¼Œéƒ½æœ‰ä¾‹å¤–ã€‚ä¾‹å¦‚ï¼Œæœ‰æ—¶ä¸¤ä¸ªå˜é‡å¯†åˆ‡ç›¸å…³ï¼Œè¿™æ ·å†™ä¼šå¾ˆå¥‡æ€ª:

```go
var min int
max := 1000
```

> å¦‚æœè¿™æ ·å£°æ˜å¯èƒ½æ›´å…·å¯è¯»æ€§

```go
min, max := 0, 1000
```

ç»¼ä¸Šæ‰€è¿°ï¼š

åœ¨æ²¡æœ‰åˆå§‹åŒ–çš„æƒ…å†µä¸‹å£°æ˜å˜é‡æ—¶ï¼Œè¯·ä½¿ç”¨ var è¯­æ³•ã€‚

å£°æ˜å¹¶åˆå§‹åŒ–å˜é‡æ—¶ï¼Œè¯·ä½¿ç”¨`:=`ã€‚

> è´´å£«:
> ä½¿å¤æ‚çš„å£°æ˜æ˜¾è€Œæ˜“è§ã€‚å½“äº‹æƒ…å˜å¾—å¤æ‚æ—¶ï¼Œå®ƒçœ‹èµ·æ¥å°±ä¼šå¾ˆå¤æ‚ã€‚ä¾‹å¦‚

```go
var length uint32 = 0x80
```

> è¿™é‡Œ`length`å¯èƒ½è¦ä¸ç‰¹å®šæ•°å­—ç±»å‹çš„åº“ä¸€èµ·ä½¿ç”¨ï¼Œå¹¶ä¸”`length`æ˜ç¡®é€‰æ‹©ä¸º`uint32`ç±»å‹è€Œä¸æ˜¯çŸ­å£°æ˜å½¢å¼ï¼š

```go
length := uint32(0x80)
```

> åœ¨ç¬¬ä¸€ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘æ•…æ„è¿åäº†è§„åˆ™, ä½¿ç”¨`var`å£°æ˜å¸¦æœ‰åˆå§‹åŒ–å˜é‡çš„ã€‚è¿™ä¸ªå†³å®šä¸æˆ‘çš„å¸¸ç”¨çš„å½¢å¼ä¸åŒï¼Œè¿™ç»™è¯»è€…ä¸€ä¸ªçº¿ç´¢,å‘Šè¯‰ä»–ä»¬ä¸€äº›ä¸å¯»å¸¸çš„äº‹æƒ…å°†ä¼šå‘ç”Ÿã€‚

#### 2.6. æˆä¸ºå›¢é˜Ÿåˆä½œè€…

æˆ‘è°ˆåˆ°äº†è½¯ä»¶å·¥ç¨‹çš„ç›®æ ‡ï¼Œå³ç¼–å†™å¯è¯»åŠå¯ç»´æŠ¤çš„ä»£ç ã€‚å› æ­¤ï¼Œæ‚¨å¯èƒ½ä¼šå°†å¤§éƒ¨åˆ†èŒä¸šç”Ÿæ¶¯ç”¨äºä½ ä¸æ˜¯å”¯ä¸€ä½œè€…çš„é¡¹ç›®ã€‚æˆ‘åœ¨è¿™ç§æƒ…å†µä¸‹çš„å»ºè®®æ˜¯éµå¾ªé¡¹ç›®è‡ªèº«é£æ ¼ã€‚

åœ¨æ–‡ä»¶ä¸­é—´æ›´æ”¹æ ·å¼æ˜¯ä¸å’Œè°çš„ã€‚å³ä½¿ä¸æ˜¯ä½ å–œæ¬¢çš„æ–¹å¼ï¼Œå¯¹äºç»´æŠ¤è€Œè¨€ä¸€è‡´æ€§æ¯”ä½ çš„ä¸ªäººåå¥½æ›´æœ‰ä»·å€¼ã€‚ æˆ‘çš„ç»éªŒæ³•åˆ™æ˜¯: å¦‚æœå®ƒé€šè¿‡äº†`gofmt`,é‚£ä¹ˆé€šå¸¸ä¸å€¼å¾—å†åšä»£ç å®¡æŸ¥ã€‚

> è´´å£«:
> å¦‚æœè¦åœ¨ä»£ç åº“ä¸­è¿›è¡Œé‡å‘½åï¼Œè¯·ä¸è¦å°†å…¶æ··åˆåˆ°å¦ä¸€ä¸ªæ›´æ”¹ä¸­ã€‚å¦‚æœæœ‰äººä½¿ç”¨`git bisect`ï¼Œä»–ä»¬ä¸æƒ³é€šè¿‡æ•°åƒè¡Œé‡å‘½åæ¥æŸ¥æ‰¾æ‚¨æ›´æ”¹çš„ä»£ç ã€‚

### 3. æ³¨é‡Š

åœ¨æˆ‘ä»¬ç»§ç»­è®¨è®ºæ›´å¤§çš„é¡¹ç›®ä¹‹å‰ï¼Œæˆ‘æƒ³èŠ±å‡ åˆ†é’Ÿæ—¶é—´è°ˆè®ºä¸€ä¸‹æ³¨é‡Šã€‚

> Good code has lots of comments, bad code requires lots of comments.
> (å¥½çš„ä»£ç æœ‰å¾ˆå¤šæ³¨é‡Šï¼Œåä»£ç éœ€è¦å¾ˆå¤šæ³¨é‡Šã€‚) â€” Dave Thomas and Andrew Hunt (The Pragmatic Programmer)

æ³¨é‡Šå¯¹ Go è¯­è¨€ç¨‹åºçš„å¯è¯»æ€§éå¸¸é‡è¦ã€‚ æ³¨é‡Šåº”è¯¥åšçš„ä¸‰ä»¶äº‹ä¸­çš„ä¸€ä»¶ï¼š

1. æ³¨é‡Šåº”è¯¥è§£é‡Šå…¶ä½œç”¨ã€‚
2. æ³¨é‡Šåº”è¯¥è§£é‡Šå…¶å¦‚ä½•åšçš„ã€‚
3. æ³¨é‡Šåº”è¯¥è§£é‡Šå…¶åŸå› ã€‚

ç¬¬ä¸€ç§å½¢å¼æ˜¯å…¬å…±ç¬¦å·æ³¨é‡Šçš„ç†æƒ³é€‰æ‹©ï¼š

```go
// Open opens the named file for reading.
// If successful, methods on the returned file can be used for reading.
```

ç¬¬äºŒç§å½¢å¼éå¸¸é€‚åˆåœ¨æ–¹æ³•ä¸­æ³¨é‡Šï¼š

```go
// queue all dependant actions
var results []chan error
for _, dep := range a.Deps {
        results = append(results, execute(seen, dep))
}
```

ç¬¬ä¸‰ç§å½¢å¼æ˜¯ç‹¬ä¸€æ— äºŒçš„ï¼Œå› ä¸ºå®ƒä¸ä¼šå–ä»£å‰ä¸¤ç§å½¢å¼ï¼Œä½†ä¸æ­¤åŒæ—¶å®ƒå¹¶ä¸èƒ½ä»£æ›¿å‰ä¸¤ç§å½¢å¼ã€‚æ­¤å½¢å¼çš„æ³¨è§£ç”¨ä»¥è§£é‡Šä»£ç çš„å¤–éƒ¨å› ç´ ã€‚è¿™äº›å› ç´ è„±ç¦»ä¸Šä¸‹æ–‡åé€šå¸¸å¾ˆéš¾ç†è§£ï¼Œæ­¤æ³¨é‡Šçš„ä¸ºäº†æä¾›è¿™ç§ä¸Šä¸‹æ–‡ã€‚

```go
return &v2.Cluster_CommonLbConfig{
	// Disable HealthyPanicThreshold
        HealthyPanicThreshold: &envoy_type.Percent{
        	Value: 0,
        },
}
```

åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œæ— æ³•æ¸…æ¥šåœ°æ˜ç™½`HealthyPanicThreshold`è®¾ç½®ä¸ºé›¶ç™¾åˆ†æ¯”çš„æ•ˆæœã€‚éœ€è¦æ³¨é‡Š`0`å€¼å°†ç¦ç”¨`panic`é˜€å€¼ã€‚

#### 3.1. å…³äºå˜é‡å’Œå¸¸é‡çš„æ³¨é‡Šåº”æè¿°å…¶å†…å®¹è€Œéå…¶ç›®çš„

æˆ‘ä¹‹å‰è°ˆè¿‡ï¼Œå˜é‡æˆ–å¸¸é‡çš„åç§°åº”æè¿°å…¶ç›®çš„ã€‚å‘å˜é‡æˆ–å¸¸é‡æ·»åŠ æ³¨é‡Šæ—¶ï¼Œè¯¥æ³¨é‡Šåº”æè¿°å˜é‡å†…å®¹ï¼Œè€Œä¸æ˜¯å˜é‡ç›®çš„ã€‚

```go
const randomNumber = 6 // determined from an unbiased die
```

åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œæ³¨é‡Šæè¿°äº†ä¸ºä»€ä¹ˆ`randomNumber`è¢«èµ‹å€¼ä¸º 6ï¼Œä»¥åŠ 6 æ¥è‡ªå“ªé‡Œã€‚æ³¨é‡Šæ²¡æœ‰æè¿°`randomNumber`çš„ä½¿ç”¨ä½ç½®ã€‚è¿˜æœ‰æ›´å¤šçš„ä¾‹å­ï¼š

```go
const (
    StatusContinue           = 100 // RFC 7231, 6.2.1
    StatusSwitchingProtocols = 101 // RFC 7231, 6.2.2
    StatusProcessing         = 102 // RFC 2518, 10.1

    StatusOK                 = 200 // RFC 7231, 6.3.1
```

åœ¨ HTTP çš„ä¸Šä¸‹æ–‡ä¸­ï¼Œæ•°å­—`100`è¢«ç§°ä¸º`StatusContinue`ï¼Œå¦‚ RFC 7231 ç¬¬ 6.2.1 èŠ‚ä¸­æ‰€å®šä¹‰ã€‚

> è´´å£«:
> å¯¹äºæ²¡æœ‰åˆå§‹å€¼çš„å˜é‡ï¼Œæ³¨é‡Šåº”æè¿°è°è´Ÿè´£åˆå§‹åŒ–æ­¤å˜é‡ã€‚

```go
// sizeCalculationDisabled indicates whether it is safe
// to calculate Types' widths and alignments. See dowidth.
var sizeCalculationDisabled bool
```

> è¿™é‡Œçš„æ³¨é‡Šè®©è¯»è€…çŸ¥é“`dowidth`å‡½æ•°è´Ÿè´£ç»´æŠ¤`sizeCalculationDisabled`çš„çŠ¶æ€ã€‚
>
> **éšè—åœ¨ä¼—ç›®ç½ç½ä¸‹**
> è¿™ä¸ªæç¤ºæ¥è‡ª Kate Gregory[[3]](https://www.infoq.com/articles/API-Design-Joshua-Bloch)ã€‚æœ‰æ—¶ä½ ä¼šå‘ç°ä¸€ä¸ªæ›´å¥½çš„å˜é‡åç§°éšè—åœ¨æ³¨é‡Šä¸­ã€‚

```go
// registry of SQL drivers
var registry = make(map[string]*sql.Driver)
```

> æ³¨é‡Šæ˜¯ç”±ä½œè€…æ·»åŠ çš„ï¼Œå› ä¸º`registry`æ²¡æœ‰å……åˆ†è§£é‡Šå…¶ç›®çš„ - å®ƒæ˜¯ä¸€ä¸ªæ³¨å†Œè¡¨ï¼Œä½†æ³¨å†Œçš„æ˜¯ä»€ä¹ˆï¼Ÿ
>
> é€šè¿‡å°†å˜é‡é‡å‘½åä¸º`sqlDrivers`ï¼Œç°åœ¨å¯ä»¥æ¸…æ¥šåœ°çŸ¥é“æ­¤å˜é‡çš„ç›®çš„æ˜¯ä¿å­˜ SQL é©±åŠ¨ç¨‹åºã€‚

```go
var sqlDrivers = make(map[string]*sql.Driver)
```

> ä¹‹å‰çš„æ³¨é‡Šå°±æ˜¯å¤šä½™çš„ï¼Œå¯ä»¥åˆ é™¤ã€‚

#### 3.2. å…¬å…±ç¬¦å·å§‹ç»ˆè¦æ³¨é‡Š

`godoc`æ˜¯åŒ…çš„æ–‡æ¡£ï¼Œæ‰€ä»¥åº”è¯¥å§‹ç»ˆä¸ºåŒ…ä¸­å£°æ˜çš„æ¯ä¸ªå…¬å…±ç¬¦å· â€”â€‹ å˜é‡ã€å¸¸é‡ã€å‡½æ•°ä»¥åŠæ–¹æ³•æ·»åŠ æ³¨é‡Šã€‚

ä»¥ä¸‹æ˜¯`Google Style`æŒ‡å—ä¸­çš„ä¸¤æ¡è§„åˆ™:

- ä»»ä½•æ—¢ä¸æ˜æ˜¾ä¹Ÿä¸ç®€çŸ­çš„å…¬å…±åŠŸèƒ½å¿…é¡»äºˆä»¥æ³¨é‡Šã€‚
- æ— è®ºé•¿åº¦æˆ–å¤æ‚ç¨‹åº¦å¦‚ä½•ï¼Œå¯¹åº“ä¸­çš„ä»»ä½•å‡½æ•°éƒ½å¿…é¡»è¿›è¡Œæ³¨é‡Š

```go
package ioutil

// ReadAll reads from r until an error or EOF and returns the data it read.
// A successful call returns err == nil, not err == EOF. Because ReadAll is
// defined to read from src until EOF, it does not treat an EOF from Read
// as an error to be reported.
func ReadAll(r io.Reader) ([]byte, error)
```

è¿™æ¡è§„åˆ™æœ‰ä¸€ä¸ªä¾‹å¤–; æ‚¨ä¸éœ€è¦æ³¨é‡Šå®ç°æ¥å£çš„æ–¹æ³•ã€‚å…·ä½“ä¸è¦åƒä¸‹é¢è¿™æ ·åšï¼š

```go
// Read implements the io.Reader interface
func (r *FileReader) Read(buf []byte) (int, error)
```

è¿™ä¸ªæ³¨é‡Šä»€ä¹ˆä¹Ÿæ²¡è¯´ã€‚å®ƒæ²¡æœ‰å‘Šè¯‰ä½ è¿™ä¸ªæ–¹æ³•åšäº†ä»€ä¹ˆï¼Œæ›´ç³Ÿç³•æ˜¯å®ƒå‘Šè¯‰ä½ å»çœ‹å…¶ä»–åœ°æ–¹çš„æ–‡æ¡£ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘å»ºè®®å®Œå…¨åˆ é™¤è¯¥æ³¨é‡Šã€‚

è¿™æ˜¯`io`åŒ…ä¸­çš„ä¸€ä¸ªä¾‹å­

```go
// LimitReader returns a Reader that reads from r
// but stops with EOF after n bytes.
// The underlying implementation is a *LimitedReader.
func LimitReader(r Reader, n int64) Reader { return &LimitedReader{r, n} }

// A LimitedReader reads from R but limits the amount of
// data returned to just N bytes. Each call to Read
// updates N to reflect the new amount remaining.
// Read returns EOF when N <= 0 or when the underlying R returns EOF.
type LimitedReader struct {
	R Reader // underlying reader
	N int64  // max bytes remaining
}

func (l *LimitedReader) Read(p []byte) (n int, err error) {
	if l.N <= 0 {
		return 0, EOF
	}
	if int64(len(p)) > l.N {
		p = p[0:l.N]
	}
	n, err = l.R.Read(p)
	l.N -= int64(n)
	return
}
```

è¯·æ³¨æ„ï¼Œ`LimitedReader`çš„å£°æ˜å°±åœ¨ä½¿ç”¨å®ƒçš„å‡½æ•°ä¹‹å‰ï¼Œè€Œ`LimitedReader.Read`çš„å£°æ˜éµå¾ª`LimitedReader`æœ¬èº«çš„å£°æ˜ã€‚å°½ç®¡`LimitedReader.Read`æœ¬èº«æ²¡æœ‰æ–‡æ¡£ï¼Œä½†å®ƒæ¸…æ¥šåœ°è¡¨æ˜å®ƒæ˜¯`io.Reader`çš„ä¸€ä¸ªå®ç°ã€‚

> è´´å£«:
> åœ¨ç¼–å†™å‡½æ•°ä¹‹å‰ï¼Œè¯·ç¼–å†™æè¿°å‡½æ•°çš„æ³¨é‡Šã€‚ å¦‚æœä½ å‘ç°å¾ˆéš¾å†™å‡ºæ³¨é‡Šï¼Œé‚£ä¹ˆè¿™å°±è¡¨æ˜ä½ å°†è¦ç¼–å†™çš„ä»£ç å¾ˆéš¾ç†è§£ã€‚

#### 3.2.1. ä¸è¦æ³¨é‡Šä¸å¥½çš„ä»£ç ï¼Œå°†å®ƒé‡å†™

> Donâ€™t comment bad codeâ€‰â€”â€‰rewrite it. â€” Brian Kernighan

ç²—åŠ£çš„ä»£ç çš„æ³¨é‡Šé«˜äº®æ˜¾ç¤ºæ˜¯ä¸å¤Ÿçš„ã€‚ å¦‚æœä½ é‡åˆ°å…¶ä¸­ä¸€æ¡æ³¨é‡Šï¼Œåˆ™åº”æå‡ºé—®é¢˜ï¼Œä»¥æé†’æ‚¨ç¨åé‡æ„ã€‚ åªè¦æŠ€æœ¯å€ºåŠ¡æ•°é¢å·²çŸ¥ï¼Œå®ƒæ˜¯å¯ä»¥å¿å—çš„ã€‚

æ ‡å‡†åº“ä¸­çš„æƒ¯ä¾‹æ˜¯æ³¨æ„åˆ°å®ƒçš„äººç”¨`TODO(username)`çš„æ ·å¼æ¥æ³¨é‡Šã€‚

```go
// TODO(dfc) this is O(N^2), find a faster way to do this.
```

æ³¨é‡Š`username`ä¸æ˜¯è¯¥äººæ‰¿è¯ºè¦è§£å†³è¯¥é—®é¢˜ï¼Œä½†åœ¨è§£å†³é—®é¢˜æ—¶ä»–ä»¬å¯èƒ½æ˜¯æœ€å¥½çš„äººé€‰ã€‚ å…¶ä»–é¡¹ç›®ä½¿ç”¨`TODO`ä¸æ—¥æœŸæˆ–é—®é¢˜ç¼–å·æ¥æ³¨é‡Šã€‚

#### 3.2.2. ä¸å…¶æ³¨é‡Šä¸€æ®µä»£ç ï¼Œä¸å¦‚é‡æ„å®ƒ

> Good code is its own best documentation. As youâ€™re about to add a comment, ask yourself, 'How can I improve the code so that this comment isnâ€™t needed?' Improve the code and then document it to make it even clearer.
> å¥½çš„ä»£ç æ˜¯æœ€å¥½çš„æ–‡æ¡£ã€‚åœ¨å³å°†æ·»åŠ æ³¨é‡Šæ—¶ï¼Œè¯·é—®ä¸‹è‡ªå·±ï¼Œâ€œå¦‚ä½•æ”¹è¿›ä»£ç ä»¥ä¾¿ä¸éœ€è¦æ­¤æ³¨é‡Šï¼Ÿ' æ”¹è¿›ä»£ç ä½¿å…¶æ›´æ¸…æ™°ã€‚ â€” Steve McConnell

**å‡½æ•°åº”è¯¥åªåšä¸€ä»¶äº‹ã€‚ å¦‚æœä½ å‘ç°è‡ªå·±åœ¨æ³¨é‡Šä¸€æ®µä¸å‡½æ•°çš„å…¶ä½™éƒ¨åˆ†æ— å…³çš„ä»£ç ï¼Œè¯·è€ƒè™‘å°†å…¶æå–åˆ°å®ƒè‡ªå·±çš„å‡½æ•°ä¸­**ã€‚

**é™¤äº†æ›´å®¹æ˜“ç†è§£ä¹‹å¤–ï¼Œè¾ƒå°çš„å‡½æ•°æ›´æ˜“äºéš”ç¦»æµ‹è¯•ï¼Œå°†ä»£ç éš”ç¦»åˆ°å‡½æ•°ä¸­ï¼Œå…¶åç§°å¯èƒ½æ˜¯æ‰€éœ€çš„æ‰€æœ‰æ–‡æ¡£**ã€‚(_æ³¨ï¼šå³å‡½æ•°åå°±è¡¨æ˜äº†è¯¥å‡½æ•°çš„ä½œç”¨_)

### 4. åŒ…çš„è®¾è®¡

> Write shy code - modules that donâ€™t reveal anything unnecessary to other modules and that donâ€™t rely on other modules' implementations.
> ç¼–å†™è°¨æ…çš„ä»£ç  - ä¸å‘å…¶ä»–æ¨¡å—é€éœ²ä»»ä½•ä¸å¿…è¦çš„æ¨¡å—ï¼Œå¹¶ä¸”ä¸ä¾èµ–äºå…¶ä»–æ¨¡å—çš„å®ç°ã€‚ â€” Dave Thomas

æ¯ä¸ª Go è¯­è¨€çš„åŒ…å®é™…ä¸Šéƒ½æ˜¯å®ƒä¸€ä¸ªå°å°çš„ Go è¯­è¨€ç¨‹åºã€‚æ­£å¦‚å‡½æ•°æˆ–æ–¹æ³•çš„å®ç°å¯¹è°ƒç”¨è€…è€Œè¨€å¹¶ä¸é‡è¦ä¸€æ ·ï¼ŒåŒ…çš„å…¬å…± API-å…¶å‡½æ•°ã€æ–¹æ³•ä»¥åŠç±»å‹çš„å®ç°å¯¹äºè°ƒç”¨è€…æ¥è¯´ä¹Ÿå¹¶ä¸é‡è¦ã€‚

ä¸€ä¸ªå¥½çš„ Go è¯­è¨€åŒ…åº”è¯¥å…·æœ‰ä½ç¨‹åº¦çš„æºç çº§è€¦åˆï¼Œè¿™æ ·éšç€é¡¹ç›®çš„å¢é•¿ï¼Œå¯¹ä¸€ä¸ªåŒ…çš„æ›´æ”¹ä¸ä¼šé€ æˆè·¨ä»£ç åº“çº§è”ï¼ˆ_æœ‰æ²¡æœ‰æ·±ç—›çš„é¢†æ‚Ÿ_ï¼‰ã€‚ è¿™ç§é‡æ„ä¸¥æ ¼é™åˆ¶äº†ä»£ç åº“çš„å˜åŒ–ç‡ä»¥åŠåœ¨è¯¥ä»£ç åº“ä¸­å·¥ä½œçš„æˆå‘˜çš„ç”Ÿäº§ç‡ï¼Œå¦‚åŒä¸–ç•Œæœ«æ—¥ã€‚

åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†è®¨è®ºå¦‚ä½•è®¾è®¡åŒ…ï¼ŒåŒ…æ‹¬åŒ…çš„åç§°ï¼Œå‘½åç±»å‹ä»¥åŠç¼–å†™æ–¹æ³•å’Œå‡½æ•°çš„æŠ€å·§ã€‚

#### 4.1. ä¸€ä¸ªå¥½çš„åŒ…ä»å®ƒçš„åå­—å¼€å§‹

ç¼–å†™ä¸€ä¸ªå¥½çš„ Go è¯­è¨€åŒ…ä»åŒ…çš„åç§°å¼€å§‹ã€‚å°†ä½ çš„åŒ…åç”¨**ä¸€ä¸ªè¯**æ¥æè¿°å®ƒã€‚

æ­£å¦‚æˆ‘åœ¨ä¸Šä¸€èŠ‚ä¸­è°ˆåˆ°å˜é‡çš„åç§°ä¸€æ ·ï¼ŒåŒ…çš„åç§°ä¹Ÿéå¸¸é‡è¦ã€‚æˆ‘éµå¾ªçš„ç»éªŒæ³•åˆ™ä¸æ˜¯â€œæˆ‘åº”è¯¥åœ¨è¿™ä¸ªåŒ…ä¸­æ”¾å…¥ä»€ä¹ˆç±»å‹çš„ï¼Ÿâ€ã€‚ç›¸åï¼Œæˆ‘è¦é—®æ˜¯â€œè¯¥åŒ…æä¾›çš„æœåŠ¡æ˜¯ä»€ä¹ˆï¼Ÿâ€é€šå¸¸è¿™ä¸ªé—®é¢˜çš„ç­”æ¡ˆä¸æ˜¯â€œè¿™ä¸ªåŒ…æä¾›`X`ç±»å‹â€ï¼Œè€Œæ˜¯â€œè¿™ä¸ªåŒ…æä¾›`HTTP`â€ã€‚

> è´´å£«:ä»¥åŒ…æ‰€æä¾›çš„å†…å®¹æ¥å‘½åï¼Œè€Œä¸æ˜¯å®ƒåŒ…å«çš„å†…å®¹ã€‚(_æ³¨ï¼šä½¿ç”¨åŒ…çš„åŠŸèƒ½å‘½å_)

#### 4.1.1. å¥½çš„åŒ…ååº”è¯¥æ˜¯å”¯ä¸€çš„ã€‚

åœ¨é¡¹ç›®ä¸­ï¼Œæ¯ä¸ªåŒ…åç§°åº”è¯¥æ˜¯å”¯ä¸€çš„ã€‚ä½¿ç”¨åŒ…çš„ç”¨é€”å‘½åçš„å»ºè®®å¾ˆå®¹æ˜“ç†è§£ï¼Œå¦‚æœä½ å‘ç°æœ‰ä¸¤ä¸ªåŒ…éœ€è¦ç”¨ç›¸åŒåç§°ï¼Œå®ƒå¯èƒ½æ˜¯:

1. åŒ…çš„åç§°å¤ªé€šç”¨äº†ã€‚
2. è¯¥åŒ…ä¸å¦ä¸€ä¸ªç±»ä¼¼åç§°çš„åŒ…é‡å äº†ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ‚¨åº”è¯¥æ£€æŸ¥ä½ çš„è®¾è®¡ï¼Œæˆ–è€ƒè™‘åˆå¹¶åŒ…ã€‚

#### 4.2. é¿å…ä½¿ç”¨ç±»ä¼¼`base`ï¼Œ`common`æˆ–`util`çš„åŒ…åç§°

ä¸å¥½çš„åŒ…åçš„å¸¸è§æƒ…å†µæ˜¯`utility`åŒ…ã€‚è¿™äº›åŒ…é€šå¸¸æ˜¯éšç€æ—¶é—´çš„æ¨ç§»ä¸€äº›å¸®åŠ©ç¨‹åºå’Œå·¥å…·ç±»çš„åŒ…ã€‚ç”±äºè¿™äº›åŒ…åŒ…å«å„ç§ä¸ç›¸å…³çš„åŠŸèƒ½ï¼Œå› æ­¤å¾ˆéš¾æ ¹æ®åŒ…æä¾›çš„å†…å®¹æ¥æè¿°å®ƒä»¬ã€‚è¿™é€šå¸¸ä¼šå¯¼è‡´åŒ…çš„åç§°æ¥è‡ªåŒ…å«çš„å†…å®¹ - `utilities`ã€‚

åƒ`utils`æˆ–`helper`è¿™æ ·çš„åŒ…åç§°é€šå¸¸å‡ºç°åœ¨è¾ƒå¤§çš„é¡¹ç›®ä¸­ï¼Œè¿™äº›é¡¹ç›®å·²ç»å¼€å‘äº†æ·±å±‚æ¬¡åŒ…çš„ç»“æ„ï¼Œå¹¶ä¸”å¸Œæœ›åœ¨ä¸é‡åˆ°å¯¼å…¥å¾ªç¯çš„æƒ…å†µä¸‹å…±äº«`helper`å‡½æ•°ã€‚é€šè¿‡å°†`utility`ç¨‹åºå‡½æ•°æå–åˆ°æ–°çš„åŒ…ä¸­ï¼Œå¯¼å…¥å¾ªç¯ä¼šè¢«ç ´åï¼Œä½†ç”±äºè¯¥åŒ…æºäºé¡¹ç›®ä¸­çš„è®¾è®¡é—®é¢˜ï¼Œå› æ­¤å…¶åŒ…åç§°ä¸åæ˜ å…¶ç›®çš„ï¼Œä»…åæ˜ å…¶ä¸ºäº†æ‰“ç ´å¯¼å…¥å¾ªç¯ã€‚

æˆ‘å»ºè®®æ”¹è¿›`utils`æˆ–`helpers`åŒ…çš„åç§°æ˜¯åˆ†æå®ƒä»¬çš„è°ƒç”¨ä½ç½®ï¼Œå¦‚æœå¯èƒ½çš„è¯ï¼Œå°†ç›¸å…³çš„å‡½æ•°ç§»åŠ¨åˆ°è°ƒç”¨è€…çš„åŒ…ä¸­ã€‚å³ä½¿è¿™æ¶‰åŠå¤åˆ¶ä¸€äº›`helper`ç¨‹åºä»£ç ï¼Œè¿™ä¹Ÿæ¯”åœ¨ä¸¤ä¸ªç¨‹åºåŒ…ä¹‹é—´å¼•å…¥å¯¼å…¥ä¾èµ–é¡¹æ›´å¥½ã€‚

> [A little] duplication is far cheaper than the wrong abstraction.([ä¸€ç‚¹ç‚¹]é‡å¤æ¯”é”™è¯¯çš„æŠ½è±¡çš„æ€§ä»·æ¯”é«˜å¾ˆå¤šã€‚) â€” Sandy Metz

åœ¨ä½¿ç”¨`utility`ç¨‹åºçš„æƒ…å†µä¸‹ï¼Œæœ€å¥½é€‰å¤šä¸ªåŒ…ï¼Œæ¯ä¸ªåŒ…ä¸“æ³¨äºå•ä¸ªæ–¹é¢ï¼Œè€Œä¸æ˜¯é€‰å•ä¸€çš„æ•´ä½“åŒ…ã€‚

> è´´å£«:ä½¿ç”¨å¤æ•°å½¢å¼å‘½å`utility`åŒ…ã€‚ä¾‹å¦‚`strings`æ¥å¤„ç†å­—ç¬¦ä¸²ã€‚

å½“ä¸¤ä¸ªæˆ–å¤šä¸ªå®ç°å…±æœ‰çš„åŠŸèƒ½æˆ–å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨çš„å¸¸è§ç±»å‹è¢«é‡æ„ä¸ºå•ç‹¬çš„åŒ…æ—¶ï¼Œé€šå¸¸ä¼šæ‰¾åˆ°åç§°ç±»ä¼¼äº`base`æˆ–`common`çš„åŒ…ã€‚æˆ‘ç›¸ä¿¡è§£å†³æ–¹æ¡ˆæ˜¯å‡å°‘åŒ…çš„æ•°é‡ï¼Œå°†å®¢æˆ·ç«¯ï¼ŒæœåŠ¡å™¨å’Œå…¬å…±ä»£ç ç»„åˆåˆ°ä¸€ä¸ªä»¥åŒ…çš„åŠŸèƒ½å‘½åçš„åŒ…ä¸­ã€‚

ä¾‹å¦‚ï¼Œ`net/http`åŒ…æ²¡æœ‰`client`å’Œ`server`çš„åˆ†åŒ…ï¼Œè€Œæ˜¯æœ‰ä¸€ä¸ª`client.go`å’Œ`server.go`æ–‡ä»¶ï¼Œæ¯ä¸ªæ–‡ä»¶éƒ½æœ‰å„è‡ªçš„ç±»å‹ï¼Œè¿˜æœ‰ä¸€ä¸ª`transport.go`æ–‡ä»¶ï¼Œç”¨äºå…¬å…±æ¶ˆæ¯ä¼ è¾“ä»£ç ã€‚

> è´´å£«:
> **æ ‡è¯†ç¬¦çš„åç§°åŒ…æ‹¬å…¶åŒ…åç§°ã€‚**
> é‡è¦çš„æ˜¯æ ‡è¯†ç¬¦çš„åç§°åŒ…æ‹¬å…¶åŒ…çš„åç§°ã€‚
>
> - å½“ç”±å¦ä¸€ä¸ªåŒ…å¼•ç”¨æ—¶ï¼Œ`net/http`åŒ…ä¸­çš„ Get å‡½æ•°å˜ä¸º`http.Get`ã€‚
> - å½“å¯¼å…¥åˆ°å…¶ä»–åŒ…ä¸­æ—¶ï¼Œ`strings`åŒ…ä¸­çš„`Reader`ç±»å‹å˜ä¸º`strings.Reader`ã€‚
> - `net`åŒ…ä¸­çš„`Error`æ¥å£æ˜¾ç„¶ä¸ç½‘ç»œé”™è¯¯æœ‰å…³ã€‚

#### 4.3. å°½æ—©`return`è€Œä¸æ˜¯æ·±åº¦åµŒå¥—

ç”±äº Go è¯­è¨€çš„æ§åˆ¶æµä¸ä½¿ç”¨`exception`ï¼Œå› æ­¤ä¸éœ€è¦ä¸º`try`å’Œ`catch`å—æä¾›é¡¶çº§ç»“æ„è€Œæ·±åº¦ç¼©è¿›ä»£ç ã€‚Go è¯­è¨€ä»£ç ä¸æ˜¯æˆåŠŸçš„è·¯å¾„è¶Šæ¥è¶Šæ·±åœ°åµŒå¥—åˆ°å³è¾¹ï¼Œè€Œæ˜¯ä»¥ä¸€ç§é£æ ¼ç¼–å†™ï¼Œå…¶ä¸­éšç€å‡½æ•°çš„è¿›è¡Œï¼ŒæˆåŠŸè·¯å¾„ç»§ç»­æ²¿ç€å±å¹•å‘ä¸‹ç§»åŠ¨ã€‚ æˆ‘çš„æœ‹å‹ Mat Ryer å°†è¿™ç§åšæ³•ç§°ä¸ºâ€œè§†çº¿â€ç¼–ç ã€‚[[4]](https://medium.com/@matryer/line-of-sight-in-code-186dd7cdea88)

è¿™æ˜¯é€šè¿‡ä½¿ç”¨`guard clauses`æ¥å®ç°çš„; åœ¨è¿›å…¥å‡½æ•°æ—¶æ˜¯å…·æœ‰æ–­è¨€å‰ææ¡ä»¶çš„æ¡ä»¶å—ã€‚ è¿™æ˜¯ä¸€ä¸ªæ¥è‡ª`bytes`åŒ…çš„ä¾‹å­:

```go
func (b *Buffer) UnreadRune() error {
	if b.lastRead <= opInvalid {
		return errors.New("bytes.Buffer: UnreadRune: previous operation was not a successful ReadRune")
	}
	if b.off >= int(b.lastRead) {
		b.off -= int(b.lastRead)
	}
	b.lastRead = opInvalid
	return nil
}
```

è¿›å…¥`UnreadRune`åï¼Œå°†æ£€æŸ¥`b.lastRead`çš„çŠ¶æ€ï¼Œå¦‚æœä¹‹å‰çš„æ“ä½œä¸æ˜¯`ReadRune`ï¼Œåˆ™ä¼šç«‹å³è¿”å›é”™è¯¯ã€‚ ä¹‹åï¼Œå‡½æ•°çš„å…¶ä½™éƒ¨åˆ†ç»§ç»­è¿›è¡Œ`b.lastRead`å¤§äº`opInvalid`çš„æ–­è¨€ã€‚

ä¸æ²¡æœ‰`guard clause`çš„ç›¸åŒå‡½æ•°è¿›è¡Œæ¯”è¾ƒï¼Œ

```go
func (b *Buffer) UnreadRune() error {
	if b.lastRead > opInvalid {
		if b.off >= int(b.lastRead) {
			b.off -= int(b.lastRead)
		}
		b.lastRead = opInvalid
		return nil
	}
	return errors.New("bytes.Buffer: UnreadRune: previous operation was not a successful ReadRune")
}
```

æœ€å¸¸è§çš„æ‰§è¡ŒæˆåŠŸçš„æƒ…å†µæ˜¯åµŒå¥—åœ¨ç¬¬ä¸€ä¸ª if æ¡ä»¶å†…ï¼ŒæˆåŠŸçš„é€€å‡ºæ¡ä»¶æ˜¯`return nil`ï¼Œè€Œä¸”å¿…é¡»é€šè¿‡ä»”ç»†åŒ¹é…å¤§æ‹¬å·æ¥å‘ç°ã€‚å‡½æ•°çš„æœ€åä¸€è¡Œæ˜¯è¿”å›ä¸€ä¸ªé”™è¯¯ï¼Œå¹¶ä¸”è¢«è°ƒç”¨è€…å¿…é¡»è¿½æº¯åˆ°åŒ¹é…çš„å·¦æ‹¬å·ï¼Œä»¥äº†è§£ä½•æ—¶æ‰§è¡Œåˆ°æ­¤ç‚¹ã€‚

å¯¹äºè¯»è€…å’Œç»´æŠ¤ç¨‹åºå‘˜æ¥è¯´ï¼Œè¿™æ›´å®¹æ˜“å‡ºé”™ï¼Œå› æ­¤ Go è¯­è¨€æ›´å–œæ¬¢ä½¿ç”¨`guard clauses`å¹¶å°½æ—©è¿”å›é”™è¯¯ã€‚

#### 4.4. è®©é›¶å€¼æ›´æœ‰ç”¨

å‡è®¾å˜é‡æ²¡æœ‰åˆå§‹åŒ–ï¼Œæ¯ä¸ªå˜é‡å£°æ˜éƒ½ä¼šè‡ªåŠ¨åˆå§‹åŒ–ä¸ºä¸é›¶å†…å­˜çš„å†…å®¹ç›¸åŒ¹é…çš„å€¼ã€‚è¿™å°±æ˜¯é›¶å€¼ã€‚å€¼çš„ç±»å‹å†³å®šäº†å…¶é›¶å€¼; å¯¹äºæ•°å­—ç±»å‹ï¼Œå®ƒä¸º`0`ï¼Œå¯¹äºæŒ‡é’ˆç±»å‹ä¸º`nil`ã€`slices`ã€`map`å’Œ`channel`åŒæ ·æ˜¯`nil`ã€‚

å§‹ç»ˆè®¾ç½®å˜é‡ä¸ºå·²çŸ¥é»˜è®¤å€¼çš„å±æ€§å¯¹äºç¨‹åºçš„å®‰å…¨æ€§å’Œæ­£ç¡®æ€§éå¸¸é‡è¦ï¼Œå¹¶ä¸”å¯ä»¥ä½¿ Go è¯­è¨€ç¨‹åºæ›´ç®€å•ã€æ›´ç´§å‡‘ã€‚è¿™å°±æ˜¯ Go ç¨‹åºå‘˜æ‰€è¯´çš„â€œç»™ä½ çš„ç»“æ„ä¸€ä¸ªæœ‰ç”¨çš„é›¶å€¼â€ã€‚

å¯¹äº`sync.Mutex`ç±»å‹ã€‚`sync.Mutex`åŒ…å«ä¸¤ä¸ªæœªå…¬å¼€çš„æ•´æ•°å­—æ®µï¼Œå®ƒä»¬ç”¨æ¥è¡¨ç¤ºäº’æ–¥é”çš„å†…éƒ¨çŠ¶æ€ã€‚ æ¯å½“å£°æ˜`sync.Mutex`æ—¶ï¼Œå…¶å­—æ®µä¼šè¢«è®¾ç½®ä¸º`0`åˆå§‹å€¼ã€‚`sync.Mutex`åˆ©ç”¨æ­¤å±æ€§æ¥ç¼–å†™ï¼Œä½¿è¯¥ç±»å‹å¯ç›´æ¥ä½¿ç”¨è€Œæ— éœ€åˆå§‹åŒ–ã€‚

```go
type MyInt struct {
	mu  sync.Mutex
	val int
}

func main() {
	var i MyInt

	// i.mu is usable without explicit initialisation.
	i.mu.Lock()
	i.val++
	i.mu.Unlock()
}
```

å¦ä¸€ä¸ªåˆ©ç”¨é›¶å€¼çš„ç±»å‹æ˜¯`bytes.Buffer`ã€‚ æ‚¨å¯ä»¥å£°æ˜`bytes.Buffer`ç„¶åå°±ç›´æ¥å†™å…¥è€Œæ— éœ€åˆå§‹åŒ–ã€‚

```go
func main() {
	var b bytes.Buffer
	b.WriteString("Hello, world!\n")
	io.Copy(os.Stdout, &b)
}
```

åˆ‡ç‰‡çš„ä¸€ä¸ªæœ‰ç”¨å±æ€§æ˜¯å®ƒä»¬çš„é›¶å€¼`nil`ã€‚ å¦‚æœæˆ‘ä»¬çœ‹ä¸€ä¸‹åˆ‡ç‰‡è¿è¡Œæ—¶`header`çš„å®šä¹‰å°±ä¸éš¾ç†è§£:

```go
type slice struct {
        array *[...]T // pointer to the underlying array
        len   int
        cap   int
}
```

æ­¤ç»“æ„çš„é›¶å€¼æ„å‘³ç€`len`å’Œ`cap`çš„å€¼ä¸º`0`ï¼Œè€Œ`array`ï¼ˆæŒ‡å‘ä¿å­˜åˆ‡ç‰‡çš„å†…å®¹æ•°ç»„çš„æŒ‡é’ˆï¼‰å°†ä¸º`nil`ã€‚ è¿™æ„å‘³ç€ä½ ä¸éœ€è¦`make`åˆ‡ç‰‡ï¼Œä½ åªéœ€å£°æ˜å®ƒå³å¯ã€‚

```go
func main() {
	// s := make([]string, 0)
	// s := []string{}
	var s []string

	s = append(s, "Hello")
	s = append(s, "world")
	fmt.Println(strings.Join(s, " "))
}
```

> æ³¨æ„:
> `var s []string`ç±»ä¼¼äºå®ƒä¸Šé¢çš„ä¸¤æ¡æ³¨é‡Šè¡Œï¼Œä½†å¹¶ä¸å®Œå…¨ç›¸åŒã€‚å€¼ä¸º`nil`çš„åˆ‡ç‰‡ä¸å…·æœ‰é›¶é•¿åº¦çš„åˆ‡ç‰‡å°±å¯ä»¥æ¥ç›¸äº’æ¯”è¾ƒã€‚ä»¥ä¸‹ä»£ç å°†è¾“å‡º falseã€‚

```go
func main() {
	var s1 = []string{}
	var s2 []string
	fmt.Println(reflect.DeepEqual(s1, s2))
}
```

`nil pointers` -- æœªåˆå§‹åŒ–çš„æŒ‡é’ˆå˜é‡çš„ä¸€ä¸ªæœ‰ç”¨å±æ€§æ˜¯ä½ å¯ä»¥åœ¨å…·æœ‰`nil`å€¼çš„ç±»å‹ä¸Šè°ƒç”¨æ–¹æ³•ã€‚ å®ƒå¯ä»¥ç®€å•åœ°ç”¨äºæä¾›é»˜è®¤å€¼ã€‚

```go
type Config struct {
	path string
}

func (c *Config) Path() string {
	if c == nil {
		return "/usr/home"
	}
	return c.path
}

func main() {
	var c1 *Config
	var c2 = &Config{
		path: "/export",
	}
	fmt.Println(c1.Path(), c2.Path())
}
```

#### 4.5. é¿å…åŒ…çº§åˆ«çŠ¶æ€

ç¼–å†™å¯ç»´æŠ¤ç¨‹åºçš„å…³é”®æ˜¯å®ƒä»¬åº”è¯¥æ˜¯æ¾æ•£è€¦åˆçš„ - å¯¹ä¸€ä¸ªç¨‹åºåŒ…çš„æ›´æ”¹åº”è¯¥å¾ˆå°‘å½±å“å¦ä¸€ä¸ªä¸ç›´æ¥ä¾èµ–äºç¬¬ä¸€ä¸ªç¨‹åºåŒ…çš„ç¨‹åºåŒ…ã€‚

åœ¨ Go è¯­è¨€ä¸­æœ‰ä¸¤ç§å¾ˆå¥½çš„æ–¹æ³•å¯ä»¥å®ç°æ¾æ•£è€¦åˆ

1. ä½¿ç”¨æ¥å£æ¥æè¿°å‡½æ•°æˆ–æ–¹æ³•æ‰€éœ€çš„è¡Œä¸ºã€‚
2. é¿å…ä½¿ç”¨å…¨å±€çŠ¶æ€ã€‚

åœ¨ Go è¯­è¨€ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å‡½æ•°æˆ–æ–¹æ³•èŒƒå›´ä»¥åŠåŒ…èŒƒå›´å†…å£°æ˜å˜é‡ã€‚å½“å˜é‡æ˜¯å…¬å…±çš„æ—¶ï¼Œç»™å®šä¸€ä¸ªä»¥å¤§å†™å­—æ¯å¼€å¤´çš„æ ‡è¯†ç¬¦ï¼Œé‚£ä¹ˆå®ƒçš„èŒƒå›´å¯¹äºæ•´ä¸ªç¨‹åºæ¥è¯´å®é™…ä¸Šæ˜¯å…¨å±€çš„ - ä»»ä½•åŒ…éƒ½å¯ä»¥éšæ—¶è§‚å¯Ÿè¯¥å˜é‡çš„ç±»å‹å’Œå†…å®¹ã€‚

å¯å˜å…¨å±€çŠ¶æ€å¼•å…¥ç¨‹åºçš„ç‹¬ç«‹éƒ¨åˆ†ä¹‹é—´çš„ç´§å¯†è€¦åˆï¼Œå› ä¸ºå…¨å±€å˜é‡æˆä¸ºç¨‹åºä¸­æ¯ä¸ªå‡½æ•°çš„ä¸å¯è§å‚æ•°ï¼å¦‚æœè¯¥å˜é‡çš„ç±»å‹å‘ç”Ÿæ›´æ”¹ï¼Œåˆ™å¯ä»¥ç ´åä¾èµ–äºå…¨å±€å˜é‡çš„ä»»ä½•å‡½æ•°ã€‚å¦‚æœç¨‹åºçš„å¦ä¸€éƒ¨åˆ†æ›´æ”¹äº†è¯¥å˜é‡ï¼Œåˆ™å¯ä»¥ç ´åä¾èµ–äºå…¨å±€å˜é‡çŠ¶æ€çš„ä»»ä½•å‡½æ•°ã€‚

å¦‚æœè¦å‡å°‘å…¨å±€å˜é‡æ‰€å¸¦æ¥çš„è€¦åˆï¼Œ

1. å°†ç›¸å…³å˜é‡ä½œä¸ºå­—æ®µç§»åŠ¨åˆ°éœ€è¦å®ƒä»¬çš„ç»“æ„ä¸Šã€‚
2. ä½¿ç”¨æ¥å£æ¥å‡å°‘è¡Œä¸ºä¸å®ç°ä¹‹é—´çš„è€¦åˆã€‚

### 5. é¡¹ç›®ç»“æ„

æˆ‘ä»¬æ¥è°ˆè°ˆå¦‚ä½•å°†åŒ…ç»„åˆåˆ°é¡¹ç›®ä¸­ã€‚é€šå¸¸ä¸€ä¸ªé¡¹ç›®æ˜¯ä¸€ä¸ª`git`ä»“åº“ï¼Œä½†åœ¨æœªæ¥ Go è¯­è¨€å¼€å‘äººå‘˜ä¼šäº¤æ›¿åœ°ä½¿ç”¨`module`å’Œ`project`ã€‚

å°±åƒä¸€ä¸ªåŒ…ï¼Œæ¯ä¸ªé¡¹ç›®éƒ½åº”è¯¥æœ‰ä¸€ä¸ªæ˜ç¡®çš„ç›®çš„ã€‚ å¦‚æœä½ çš„é¡¹ç›®æ˜¯ä¸€ä¸ªåº“ï¼Œå®ƒåº”è¯¥æä¾›ä¸€ä»¶äº‹ï¼Œæ¯”å¦‚`XML`è§£ææˆ–è®°å½•ã€‚ æ‚¨åº”è¯¥é¿å…åœ¨ä¸€ä¸ªåŒ…å®ç°å¤šä¸ªç›®çš„ï¼Œè¿™å°†æœ‰åŠ©äºé¿å…æˆä¸º`common`åº“ã€‚

> è´´å£«:
> æ®æˆ‘çš„ç»éªŒï¼Œ`common`åº“æœ€ç»ˆä¼šä¸å…¶æœ€å¤§çš„è°ƒç”¨è€…ç´§å¯†ç›¸è¿ï¼Œåœ¨æ²¡æœ‰å‡çº§è¯¥åº“ä¸æœ€å¤§è°ƒç”¨è€…çš„æƒ…å†µä¸‹æ˜¯å¾ˆéš¾ä¿®å¤çš„ï¼Œè¿˜ä¼šå¸¦æ¥äº†è®¸å¤šæ— å…³çš„æ›´æ”¹ä»¥åŠ API ç ´åã€‚

å¦‚æœä½ çš„é¡¹ç›®æ˜¯åº”ç”¨ç¨‹åºï¼Œå¦‚`Web`åº”ç”¨ç¨‹åºï¼Œ`Kubernetes`æ§åˆ¶å™¨ç­‰ï¼Œé‚£ä¹ˆé¡¹ç›®ä¸­å¯èƒ½æœ‰ä¸€ä¸ªæˆ–å¤šä¸ª`main`ç¨‹åºåŒ…ã€‚ä¾‹å¦‚ï¼Œæˆ‘ç¼–å†™çš„`Kubernetes`æ§åˆ¶å™¨æœ‰ä¸€ä¸ª`cmd / contour`åŒ…ï¼Œæ—¢å¯ä»¥ä½œä¸ºéƒ¨ç½²åˆ°`Kubernetes`é›†ç¾¤çš„æœåŠ¡å™¨ï¼Œä¹Ÿå¯ä»¥ä½œä¸ºè°ƒè¯•ç›®çš„çš„å®¢æˆ·ç«¯ã€‚

#### 5.1. è€ƒè™‘æ›´å°‘ï¼Œæ›´å¤§çš„åŒ…

å¯¹äºä»å…¶ä»–è¯­è¨€è¿‡æ¸¡åˆ° Go è¯­è¨€çš„ç¨‹åºå‘˜æ¥è¯´ï¼Œæˆ‘å€¾å‘äºåœ¨ä»£ç å®¡æŸ¥ä¸­æåˆ°çš„ä¸€ä»¶äº‹æ˜¯ä»–ä»¬ä¼šè¿‡åº¦ä½¿ç”¨åŒ…ã€‚

Go è¯­è¨€æ²¡æœ‰æä¾›æœ‰å…³å¯è§æ€§çš„è¯¦ç»†æ–¹æ³•; Java æœ‰`public`ã€`protected`ã€`private`ä»¥åŠéšå¼`default`çš„è®¿é—®ä¿®é¥°ç¬¦ã€‚æ²¡æœ‰`C++`çš„`friend`ç±»æ¦‚å¿µã€‚

åœ¨ Go è¯­è¨€ä¸­ï¼Œæˆ‘ä»¬åªæœ‰ä¸¤ä¸ªè®¿é—®ä¿®é¥°ç¬¦ï¼Œ`public`å’Œ`private`ï¼Œç”±æ ‡è¯†ç¬¦çš„ç¬¬ä¸€ä¸ªå­—æ¯çš„å¤§å°å†™è¡¨ç¤ºã€‚ å¦‚æœæ ‡è¯†ç¬¦æ˜¯å…¬å…±çš„ï¼Œåˆ™å…¶åç§°ä»¥å¤§å†™å­—æ¯å¼€å¤´ï¼Œè¯¥æ ‡è¯†ç¬¦å¯ç”¨äºä»»ä½•å…¶ä»– Go è¯­è¨€åŒ…çš„å¼•ç”¨ã€‚

> æ³¨æ„:
> ä½ å¯èƒ½ä¼šå¬åˆ°äººä»¬è¯´`exported`ä¸`not exported`, è·Ÿ`public`å’Œ`private`æ˜¯åŒä¹‰è¯ã€‚

é‰´äºåŒ…çš„ç¬¦å·çš„è®¿é—®æœ‰é™æ§ä»¶ï¼ŒGo ç¨‹åºå‘˜åº”éµå¾ªå“ªäº›å®è·µæ¥é¿å…åˆ›å»ºè¿‡äºå¤æ‚çš„åŒ…å±‚æ¬¡ç»“æ„ï¼Ÿ

> è´´å£«:é™¤`cmd/`å’Œ`internal/`ä¹‹å¤–çš„æ¯ä¸ªåŒ…éƒ½åº”åŒ…å«ä¸€äº›æºä»£ç ã€‚

æˆ‘çš„å»ºè®®æ˜¯é€‰æ‹©æ›´å°‘ï¼Œæ›´å¤§çš„åŒ…ã€‚ä½ åº”è¯¥åšçš„æ˜¯ä¸åˆ›å»ºæ–°çš„ç¨‹åºåŒ…ã€‚è¿™å°†å¯¼è‡´å¤ªå¤šç±»å‹è¢«å…¬å¼€ï¼Œä¸ºä½ çš„åŒ…åˆ›å»ºä¸€ä¸ªå®½è€Œæµ…çš„ APIã€‚

ä»¥ä¸‹éƒ¨åˆ†å°†æ›´ä¸ºè¯¦ç»†åœ°æ¢è®¨è¿™ä¸€å»ºè®®ã€‚

> è´´å£«:
> æ¥è‡ª`Java`ï¼Ÿ
> å¦‚æœæ‚¨æ¥è‡ª`Java`æˆ–`C#`ï¼Œè¯·è€ƒè™‘è¿™ä¸€ç»éªŒæ³•åˆ™ -- `Java`åŒ…ç›¸å½“äºå•ä¸ª`.go`æºæ–‡ä»¶ã€‚ - Go è¯­è¨€åŒ…ç›¸å½“äºæ•´ä¸ª`Maven`æ¨¡å—æˆ–`.NET`ç¨‹åºé›†ã€‚

#### 5.1.1. é€šè¿‡`import`è¯­å¥å°†ä»£ç æ’åˆ—åˆ°æ–‡ä»¶ä¸­

å¦‚æœä½ æŒ‰ç…§åŒ…æä¾›çš„å†…å®¹æ¥å®‰æ’ä½ çš„ç¨‹åºåŒ…ï¼Œæ˜¯å¦éœ€è¦å¯¹ Go åŒ…ä¸­çš„æ–‡ä»¶ä¹Ÿæ‰§è¡Œç›¸åŒçš„æ“ä½œï¼Ÿä»€ä¹ˆæ—¶å€™åº”è¯¥å°†`.go`æ–‡ä»¶æ‹†åˆ†æˆå¤šä¸ªæ–‡ä»¶ï¼Ÿä»€ä¹ˆæ—¶å€™åº”è¯¥è€ƒè™‘æ•´åˆ`.go`æ–‡ä»¶ï¼Ÿ

ä»¥ä¸‹æ˜¯æˆ‘çš„ç»éªŒæ³•åˆ™ï¼š

- å¼€å§‹æ—¶ä½¿ç”¨ä¸€ä¸ª`.go`æ–‡ä»¶ã€‚ä¸ºè¯¥æ–‡ä»¶æŒ‡å®šä¸æ–‡ä»¶å¤¹åç§°ç›¸åŒçš„åç§°ã€‚ä¾‹å¦‚: `package http`åº”æ”¾åœ¨åä¸º`http`çš„ç›®å½•ä¸­åä¸º`http.go`çš„æ–‡ä»¶ä¸­ã€‚
- éšç€åŒ…çš„å¢é•¿ï¼Œæ‚¨å¯èƒ½å†³å®šå°†å„ç§èŒè´£ä»»åŠ¡æ‹†åˆ†ä¸ºä¸åŒçš„æ–‡ä»¶ã€‚ä¾‹å¦‚ï¼Œ`messages.go`åŒ…å«`Request`å’Œ`Response`ç±»å‹ï¼Œ`client.go`åŒ…å«`Client`ç±»å‹ï¼Œ`server.go`åŒ…å«`Server`ç±»å‹ã€‚
- å¦‚æœä½ çš„æ–‡ä»¶ä¸­`import`çš„å£°æ˜ç±»ä¼¼ï¼Œè¯·è€ƒè™‘å°†å®ƒä»¬ç»„åˆèµ·æ¥ã€‚æˆ–è€…ç¡®å®š`import`é›†ä¹‹é—´çš„å·®å¼‚å¹¶ç§»åŠ¨å®ƒä»¬ã€‚
- ä¸åŒçš„æ–‡ä»¶åº”è¯¥è´Ÿè´£åŒ…çš„ä¸åŒåŒºåŸŸã€‚`messages.go`å¯èƒ½è´Ÿè´£ç½‘ç»œçš„`HTTP`è¯·æ±‚å’Œå“åº”ï¼Œ`http.go`å¯èƒ½åŒ…å«åº•å±‚ç½‘ç»œå¤„ç†é€»è¾‘ï¼Œ`client.go`å’Œ`server.go`å®ç°`HTTP`ä¸šåŠ¡é€»è¾‘è¯·æ±‚çš„å®ç°æˆ–è·¯ç”±ç­‰ç­‰ã€‚

> è´´å£«: é¦–é€‰åè¯ä¸ºæºæ–‡ä»¶å‘½åã€‚

> æ³¨æ„:
> Go ç¼–è¯‘å™¨å¹¶è¡Œç¼–è¯‘æ¯ä¸ªåŒ…ã€‚åœ¨ä¸€ä¸ªåŒ…ä¸­ï¼Œç¼–è¯‘å™¨å¹¶è¡Œç¼–è¯‘æ¯ä¸ªå‡½æ•°ï¼ˆæ–¹æ³•åªæ˜¯ Go è¯­è¨€ä¸­å‡½æ•°çš„å¦ä¸€ç§å†™æ³•ï¼‰ã€‚æ›´æ”¹åŒ…ä¸­ä»£ç çš„å¸ƒå±€ä¸ä¼šå½±å“ç¼–è¯‘æ—¶é—´ã€‚

#### 5.1.2. ä¼˜å…ˆå†…éƒ¨æµ‹è¯•å†åˆ°å¤–éƒ¨æµ‹è¯•

`go tool`æ”¯æŒåœ¨ä¸¤ä¸ªåœ°æ–¹ç¼–å†™`testing`åŒ…æµ‹è¯•ã€‚å‡è®¾ä½ çš„åŒ…åä¸º`http2`ï¼Œæ‚¨å¯ä»¥ç¼–å†™`http2_test.go`æ–‡ä»¶å¹¶ä½¿ç”¨åŒ…`http2`å£°æ˜ã€‚è¿™æ ·åšä¼šç¼–è¯‘`http2_test.go`ä¸­çš„ä»£ç ï¼Œå°±åƒå®ƒæ˜¯`http2`åŒ…çš„ä¸€éƒ¨åˆ†ä¸€æ ·ã€‚è¿™å°±æ˜¯å†…éƒ¨æµ‹è¯•ã€‚

`go tool`è¿˜æ”¯æŒä¸€ä¸ªç‰¹æ®Šçš„åŒ…å£°æ˜ï¼Œä»¥`test`ä¸ºç»“å°¾ï¼Œå³`package http_test`ã€‚è¿™å…è®¸ä½ çš„æµ‹è¯•æ–‡ä»¶ä¸ä»£ç ä¸€èµ·å­˜æ”¾åœ¨åŒä¸€ä¸ªåŒ…ä¸­ï¼Œä½†æ˜¯å½“ç¼–è¯‘æ—¶è¿™äº›æµ‹è¯•ä¸æ˜¯åŒ…çš„ä»£ç çš„ä¸€éƒ¨åˆ†ï¼Œå®ƒä»¬å­˜åœ¨äºè‡ªå·±çš„åŒ…ä¸­ã€‚å°±åƒè°ƒç”¨å¦ä¸€ä¸ªåŒ…çš„ä»£ç ä¸€æ ·æ¥ç¼–å†™æµ‹è¯•ã€‚è¿™è¢«ç§°ä¸ºå¤–éƒ¨æµ‹è¯•ã€‚

æˆ‘å»ºè®®åœ¨ç¼–å†™å•å…ƒæµ‹è¯•æ—¶ä½¿ç”¨å†…éƒ¨æµ‹è¯•ã€‚è¿™æ ·ä½ å°±å¯ä»¥ç›´æ¥æµ‹è¯•æ¯ä¸ªå‡½æ•°æˆ–æ–¹æ³•ï¼Œé¿å…å¤–éƒ¨æµ‹è¯•å¹²æ‰°ã€‚

ä½†æ˜¯ï¼Œä½ åº”è¯¥å°†`Example`æµ‹è¯•å‡½æ•°æ”¾åœ¨å¤–éƒ¨æµ‹è¯•æ–‡ä»¶ä¸­ã€‚è¿™ç¡®ä¿äº†åœ¨`godoc`ä¸­æŸ¥çœ‹æ—¶ï¼Œç¤ºä¾‹å…·æœ‰é€‚å½“çš„åŒ…åå‰ç¼€å¹¶ä¸”å¯ä»¥è½»æ¾åœ°è¿›è¡Œå¤åˆ¶ç²˜è´´ã€‚

> è´´å£«:
> `é¿å…å¤æ‚çš„åŒ…å±‚æ¬¡ç»“æ„ï¼ŒæŠµåˆ¶åº”ç”¨åˆ†ç±»æ³•`
> Go è¯­è¨€åŒ…çš„å±‚æ¬¡ç»“æ„å¯¹äº`go tool`æ²¡æœ‰ä»»ä½•æ„ä¹‰é™¤äº†ä¸‹ä¸€èŠ‚è¦è¯´çš„ã€‚ ä¾‹å¦‚ï¼Œ`net/http`åŒ…ä¸æ˜¯ä¸€ä¸ªå­åŒ…æˆ–è€…`net`åŒ…çš„å­åŒ…ã€‚
>
> å¦‚æœåœ¨é¡¹ç›®ä¸­åˆ›å»ºäº†ä¸åŒ…å«`.go`æ–‡ä»¶çš„ä¸­é—´ç›®å½•ï¼Œåˆ™å¯èƒ½æ— æ³•éµå¾ªæ­¤å»ºè®®ã€‚

#### 5.1.3. ä½¿ç”¨`internal`åŒ…æ¥å‡å°‘å…¬å…± API

å¦‚æœé¡¹ç›®åŒ…å«å¤šä¸ªåŒ…ï¼Œå¯èƒ½æœ‰ä¸€äº›å…¬å…±çš„å‡½æ•°ï¼Œè¿™äº›å‡½æ•°æ—¨åœ¨ä¾›é¡¹ç›®ä¸­çš„å…¶ä»–åŒ…ä½¿ç”¨ï¼Œä½†ä¸æ‰“ç®—æˆä¸ºé¡¹ç›®çš„å…¬å…± API çš„ä¸€éƒ¨åˆ†ã€‚ å¦‚æœä½ å‘ç°æ˜¯è¿™ç§æƒ…å†µï¼Œé‚£ä¹ˆ`go tool`ä¼šè¯†åˆ«ä¸€ä¸ªç‰¹æ®Šçš„æ–‡ä»¶å¤¹åç§° - è€ŒéåŒ…åç§° - `internal/`å¯ç”¨äºæ”¾ç½®å¯¹é¡¹ç›®å…¬å¼€çš„ä»£ç ï¼Œä½†å¯¹å…¶ä»–é¡¹ç›®æ˜¯ç§æœ‰çš„ã€‚

è¦åˆ›å»ºæ­¤ç±»åŒ…ï¼Œè¯·å°†å…¶æ”¾åœ¨åä¸º`internal/`çš„ç›®å½•ä¸­ï¼Œæˆ–è€…æ”¾åœ¨åä¸º`internal/`çš„ç›®å½•çš„å­ç›®å½•ä¸­ã€‚ å½“`go`å‘½ä»¤åœ¨å…¶è·¯å¾„ä¸­çœ‹åˆ°å¯¼å…¥åŒ…å«`internal`çš„åŒ…æ—¶ï¼Œå®ƒä¼šéªŒè¯æ‰§è¡Œå¯¼å…¥çš„åŒ…æ˜¯å¦ä½äº`internal`ç›®å½•ã€‚

ä¾‹å¦‚ï¼Œ`.../a/b/c/internal/d/e/f`çš„åŒ…åªèƒ½é€šè¿‡ä»¥`.../a/b/c/ä¸ºæ ¹ç›®å½•çš„ä»£ç è¢«å¯¼å…¥ã€‚ å®ƒæ— æ³•é€šè¿‡`.../a/b/g`æˆ–ä»»ä½•å…¶ä»–ä»“åº“ä¸­çš„ä»£ç å¯¼å…¥ã€‚[[5]](https://golang.org/doc/go1.4#internalpackages)

#### 5.2. ç¡®ä¿`main`åŒ…å†…å®¹å°½å¯èƒ½çš„å°‘

`main`å‡½æ•°å’Œ`main`åŒ…çš„å†…å®¹åº”å°½å¯èƒ½å°‘ã€‚è¿™æ˜¯å› ä¸º`main.main`å……å½“å•ä¾‹; ç¨‹åºä¸­åªèƒ½æœ‰ä¸€ä¸ª`main`å‡½æ•°ï¼ŒåŒ…æ‹¬`tests`ã€‚

å› ä¸º`main.main`æ˜¯ä¸€ä¸ªå•ä¾‹ï¼Œå‡è®¾`main`å‡½æ•°ä¸­éœ€è¦æ‰§è¡Œå¾ˆå¤šäº‹æƒ…, `main.main`åªä¼šåœ¨`main.main`æˆ–`main.init`ä¸­è°ƒç”¨å®ƒä»¬å¹¶ä¸”åªè°ƒç”¨ä¸€æ¬¡ã€‚ è¿™ä½¿å¾—ä¸º`main.main`ç¼–å†™ä»£ç æµ‹è¯•å˜å¾—å¾ˆå›°éš¾ï¼Œå› æ­¤ä½ åº”è¯¥å°†æ‰€æœ‰ä¸šåŠ¡é€»è¾‘ä»`main`å‡½æ•°ä¸­ç§»å‡ºï¼Œæœ€å¥½æ˜¯ä»`main`åŒ…ä¸­ç§»å‡ºã€‚

> è´´å£«:
> `main`åº”è¯¥åšè§£æ`flags`ï¼Œå¼€å¯æ•°æ®åº“è¿æ¥ã€å¼€å¯æ—¥å¿—ç­‰ï¼Œç„¶åå°†æ‰§è¡Œäº¤ç»™æ›´é«˜ä¸€çº§çš„å¯¹è±¡ã€‚

### 6. API è®¾è®¡

æˆ‘ä»Šå¤©è¦ç»™å‡ºçš„æœ€åä¸€æ¡å»ºè®®æ˜¯è®¾è®¡, æˆ‘è®¤ä¸ºä¹Ÿæ˜¯æœ€é‡è¦çš„ã€‚

åˆ°ç›®å‰ä¸ºæ­¢æˆ‘æå‡ºçš„æ‰€æœ‰å»ºè®®éƒ½æ˜¯å»ºè®®ã€‚è¿™äº›æ˜¯æˆ‘å°è¯•ç¼–å†™ Go è¯­è¨€çš„æ–¹å¼ï¼Œä½†æˆ‘ä¸æ‰“ç®—åœ¨ä»£ç å®¡æŸ¥ä¸­æ‹¼å‘½æ¨å¹¿ã€‚

ä½†æ˜¯ï¼Œåœ¨å®¡æŸ¥ API æ—¶, æˆ‘å°±ä¸ä¼šé‚£ä¹ˆå®½å®¹äº†ã€‚è¿™æ˜¯å› ä¸ºåˆ°ç›®å‰ä¸ºæ­¢æˆ‘æ‰€è°ˆè®ºçš„æ‰€æœ‰å†…å®¹éƒ½æ˜¯å¯ä»¥ä¿®å¤è€Œä¸”ä¸ä¼šç ´åå‘åå…¼å®¹æ€§; å®ƒä»¬åœ¨å¾ˆå¤§ç¨‹åº¦ä¸Šæ˜¯å®ç°çš„ç»†èŠ‚ã€‚

å½“æ¶‰åŠåˆ°è½¯ä»¶åŒ…çš„å…¬å…± API æ—¶ï¼Œåœ¨åˆå§‹è®¾è®¡ä¸­æŠ•å…¥å¤§é‡ç²¾åŠ›æ˜¯å€¼å¾—çš„ï¼Œå› ä¸ºç¨åæ›´æ”¹è¯¥è®¾è®¡å¯¹äºå·²ç»ä½¿ç”¨ API çš„äººæ¥è¯´ä¼šæ˜¯ç ´åæ€§çš„ã€‚

#### 6.1. è®¾è®¡éš¾ä»¥è¢«è¯¯ç”¨çš„ APIã€‚

> APIs should be easy to use and hard to misuse.(API åº”è¯¥æ˜“äºä½¿ç”¨ä¸”éš¾ä»¥è¢«è¯¯ç”¨) â€” Josh BlochÂ [[3]](https://www.infoq.com/articles/API-Design-Joshua-Bloch)

å¦‚æœä½ ä»è¿™ä¸ªæ¼”è®²ä¸­å¸¦èµ°ä»»ä½•ä¸œè¥¿ï¼Œé‚£åº”è¯¥æ˜¯`Josh Bloch`çš„å»ºè®®ã€‚å¦‚æœä¸€ä¸ª API å¾ˆéš¾ç”¨äºç®€å•çš„äº‹æƒ…ï¼Œé‚£ä¹ˆ API çš„æ¯æ¬¡è°ƒç”¨éƒ½ä¼šå¾ˆå¤æ‚ã€‚å½“ API çš„å®é™…è°ƒç”¨å¾ˆå¤æ‚æ—¶ï¼Œå®ƒå°±ä¼šä¾¿å¾—ä¸é‚£ä¹ˆæ˜æ˜¾ï¼Œè€Œä¸”ä¼šæ›´å®¹æ˜“è¢«å¿½è§†ã€‚

#### 6.1.1. è­¦æƒ•é‡‡ç”¨å‡ ä¸ªç›¸åŒç±»å‹å‚æ•°çš„å‡½æ•°

ç®€å•, ä½†éš¾ä»¥æ­£ç¡®ä½¿ç”¨çš„ API æ˜¯é‡‡ç”¨ä¸¤ä¸ªæˆ–æ›´å¤šç›¸åŒç±»å‹å‚æ•°çš„ APIã€‚è®©æˆ‘ä»¬æ¯”è¾ƒä¸¤ä¸ªå‡½æ•°ç­¾åï¼š

```go
func Max(a, b int) int
func CopyFile(to, from string) error
```

è¿™ä¸¤ä¸ªå‡½æ•°æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿæ˜¾ç„¶ï¼Œä¸€ä¸ªè¿”å›ä¸¤ä¸ªæ•°å­—æœ€å¤§çš„é‚£ä¸ªï¼Œå¦ä¸€ä¸ªæ˜¯å¤åˆ¶æ–‡ä»¶ï¼Œä½†è¿™ä¸é‡è¦ã€‚

```go
Max(8, 10) // 10
Max(10, 8) // 10
```

`Max`æ˜¯å¯äº¤æ¢çš„; å‚æ•°çš„é¡ºåºæ— å…³ç´§è¦ã€‚æ— è®ºæ˜¯ 8 æ¯” 10 è¿˜æ˜¯ 10 æ¯” 8ï¼Œæœ€å¤§çš„éƒ½æ˜¯ 10ã€‚

ä½†æ˜¯ï¼Œå´ä¸é€‚ç”¨äº`CopyFile`ã€‚

```go
CopyFile("/tmp/backup", "presentation.md")
CopyFile("presentation.md", "/tmp/backup")
```

è¿™äº›å£°æ˜ä¸­å“ªä¸€ä¸ªå¤‡ä»½äº†`presentation.md`ï¼Œå“ªä¸€ä¸ªç”¨ä¸Šå‘¨çš„ç‰ˆæœ¬è¦†ç›–äº†`presentation.md`ï¼Ÿæ²¡æœ‰æ–‡æ¡£ï¼Œä½ æ— æ³•åˆ†è¾¨ã€‚å¦‚æœæ²¡æœ‰æŸ¥é˜…æ–‡æ¡£ï¼Œä»£ç å®¡æŸ¥å‘˜ä¹Ÿæ— æ³•çŸ¥é“ä½ å†™å¯¹äº†é¡ºåºã€‚

ä¸€ç§å¯èƒ½çš„è§£å†³æ–¹æ¡ˆæ˜¯å¼•å…¥ä¸€ä¸ª`helper`ç±»å‹ï¼Œå®ƒä¼šè´Ÿè´£å¦‚ä½•æ­£ç¡®åœ°è°ƒç”¨`CopyFile`ã€‚

```go
type Source string

func (src Source) CopyTo(dest string) error {
	return CopyFile(dest, string(src))
}

func main() {
	var from Source = "presentation.md"
	from.CopyTo("/tmp/backup")
}
```

é€šè¿‡è¿™ç§æ–¹å¼ï¼Œ`CopyFile`æ€»æ˜¯èƒ½è¢«æ­£ç¡®è°ƒç”¨ - è¿˜å¯ä»¥é€šè¿‡å•å…ƒæµ‹è¯• - å¹¶ä¸”å¯ä»¥è¢«è®¾ç½®ä¸ºç§æœ‰ï¼Œè¿›ä¸€æ­¥é™ä½äº†è¯¯ç”¨çš„å¯èƒ½æ€§ã€‚

> è´´å£«: å…·æœ‰å¤šä¸ªç›¸åŒç±»å‹å‚æ•°çš„ API éš¾ä»¥æ­£ç¡®ä½¿ç”¨ã€‚

#### 6.2. ä¸ºå…¶é»˜è®¤ç”¨ä¾‹è®¾è®¡ API

å‡ å¹´å‰ï¼Œæˆ‘å°±å¯¹`functional options`[[7]](https://commandcenter.blogspot.com/2014/01/self-referential-functions-and-design.html)è¿›è¡Œè¿‡è®¨è®º[[6]](https://dave.cheney.net/2014/10/17/functional-options-for-friendly-apis)ï¼Œä½¿ API æ›´æ˜“ç”¨äºé»˜è®¤ç”¨ä¾‹ã€‚

æœ¬æ¼”è®²çš„ä¸»æ—¨æ˜¯ä½ åº”è¯¥ä¸ºå¸¸è§ç”¨ä¾‹è®¾è®¡ APIã€‚å¦ä¸€æ–¹é¢ï¼ŒAPI ä¸åº”è¦æ±‚è°ƒç”¨è€…æä¾›ä»–ä»¬ä¸åœ¨ä¹å‚æ•°ã€‚

#### 6.2.1. ä¸é¼“åŠ±ä½¿ç”¨`nil`ä½œä¸ºå‚æ•°

æœ¬ç« å¼€å§‹æ—¶æˆ‘å»ºè®®æ˜¯ä¸è¦å¼ºè¿«æä¾›ç»™ API çš„è°ƒç”¨è€…ä»–ä»¬ä¸åœ¨ä¹çš„å‚æ•°ã€‚è¿™å°±æ˜¯æˆ‘è¦è¯´çš„ä¸ºé»˜è®¤ç”¨ä¾‹è®¾è®¡ APIã€‚

è¿™æ˜¯`net/http`åŒ…ä¸­çš„ä¸€ä¸ªä¾‹å­

```go
package http

// ListenAndServe listens on the TCP network address addr and then calls
// Serve with handler to handle requests on incoming connections.
// Accepted connections are configured to enable TCP keep-alives.
//
// The handler is typically nil, in which case the DefaultServeMux is used.
//
// ListenAndServe always returns a non-nil error.
func ListenAndServe(addr string, handler Handler) error {
```

`ListenAndServe`æœ‰ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªç”¨äºç›‘å¬ä¼ å…¥è¿æ¥çš„`TCP`åœ°å€ï¼Œå¦ä¸€ä¸ªç”¨äºå¤„ç†`HTTP`è¯·æ±‚çš„`http.Handler`ã€‚`Serve`å…è®¸ç¬¬äºŒä¸ªå‚æ•°ä¸º`nil`ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯è°ƒç”¨è€…é€šå¸¸ä¼šä¼ é€’`nil`ï¼Œè¡¨ç¤ºä»–ä»¬æƒ³è¦ä½¿ç”¨`http.DefaultServeMux`ä½œä¸ºéšå«å‚æ•°ã€‚

ç°åœ¨ï¼Œ`Serve`çš„è°ƒç”¨è€…æœ‰ä¸¤ç§æ–¹å¼å¯ä»¥åšåŒæ ·çš„äº‹æƒ…ã€‚

```go
http.ListenAndServe("0.0.0.0:8080", nil)
http.ListenAndServe("0.0.0.0:8080", http.DefaultServeMux)
```

ä¸¤è€…å®Œå…¨ç›¸åŒã€‚

è¿™ç§`nil`è¡Œä¸ºæ˜¯ç—…æ¯’å¼çš„ã€‚`http`åŒ…ä¹Ÿæœ‰ä¸€ä¸ª`http.Serve`å¸®åŠ©ç±»ï¼Œä½ å¯ä»¥åˆç†åœ°æƒ³è±¡ä¸€ä¸‹`ListenAndServe`æ˜¯è¿™æ ·æ„å»ºçš„

```go
func ListenAndServe(addr string, handler Handler) error {
	l, err := net.Listen("tcp", addr)
	if err != nil {
		return err
	}
	defer l.Close()
	return Serve(l, handler)
}
```

å› ä¸º`ListenAndServe`å…è®¸è°ƒç”¨è€…ä¸ºç¬¬äºŒä¸ªå‚æ•°ä¼ é€’`nil`ï¼Œæ‰€ä»¥`http.Serve`ä¹Ÿæ”¯æŒè¿™ç§è¡Œä¸ºã€‚äº‹å®ä¸Šï¼Œ`http.Serve`å®ç°äº†å¦‚æœ`handler`æ˜¯`nil`ï¼Œä½¿ç”¨`DefaultServeMux`çš„é€»è¾‘ã€‚å‚æ•°å¯ä¸º`nil`å¯èƒ½ä¼šå¯¼è‡´è°ƒç”¨è€…è®¤ä¸ºä»–ä»¬å¯ä»¥ä¸ºä¸¤ä¸ªå‚æ•°éƒ½ä½¿ç”¨`nil`ã€‚åƒä¸‹é¢è¿™æ ·:

```go
http.Serve(nil, nil)
```

ä¼šå¯¼è‡´`panic`ã€‚

> è´´å£«:
> ä¸è¦åœ¨åŒä¸€ä¸ªå‡½æ•°ç­¾åä¸­æ··åˆä½¿ç”¨å¯ä¸º`nil`å’Œä¸èƒ½ä¸º`nil`çš„å‚æ•°ã€‚

`http.ListenAndServe`çš„ä½œè€…è¯•å›¾åœ¨å¸¸è§æƒ…å†µä¸‹è®©ä½¿ç”¨ API çš„ç”¨æˆ·æ›´è½»æ¾äº›ï¼Œä½†å¾ˆå¯èƒ½ä¼šè®©è¯¥ç¨‹åºåŒ…æ›´éš¾ä»¥è¢«å®‰å…¨åœ°ä½¿ç”¨ã€‚

ä½¿ç”¨`DefaultServeMux`æˆ–ä½¿ç”¨`nil`æ²¡æœ‰ä»€ä¹ˆåŒºåˆ«ã€‚

```go
const root = http.Dir("/htdocs")
http.Handle("/", http.FileServer(root))
http.ListenAndServe("0.0.0.0:8080", nil)
```

å¯¹æ¯”

```go
const root = http.Dir("/htdocs")
http.Handle("/", http.FileServer(root))
http.ListenAndServe("0.0.0.0:8080", http.DefaultServeMux)
```

è¿™ç§æ··ä¹±å€¼å¾—æ‹¯æ•‘å—ï¼Ÿ

```go
const root = http.Dir("/htdocs")
mux := http.NewServeMux()
http.Handle("/", http.FileServer(root))
http.ListenAndServe("0.0.0.0:8080", mux)
```

> è´´å£«: è®¤çœŸè€ƒè™‘`helper`å‡½æ•°ä¼šèŠ‚çœä¸å°‘æ—¶é—´ã€‚ æ¸…æ™°è¦æ¯”ç®€æ´å¥½ã€‚
>
> è´´å£«:
> `é¿å…å…¬å…±APIä½¿ç”¨æµ‹è¯•å‚æ•°`
> é¿å…åœ¨å…¬å¼€çš„ API ä¸Šä½¿ç”¨ä»…åœ¨æµ‹è¯•èŒƒå›´ä¸Šä¸åŒçš„å€¼ã€‚ ç›¸åï¼Œä½¿ç”¨`Public wrappers`éšè—è¿™äº›å‚æ•°ï¼Œä½¿ç”¨è¾…åŠ©æ–¹å¼æ¥è®¾ç½®æµ‹è¯•èŒƒå›´ä¸­çš„å±æ€§ã€‚

#### 6.2.2. é¦–é€‰å¯å˜å‚æ•°å‡½æ•°è€Œé`[]T`å‚æ•°

ç¼–å†™ä¸€ä¸ªå¸¦æœ‰åˆ‡ç‰‡å‚æ•°çš„å‡½æ•°æˆ–æ–¹æ³•æ˜¯å¾ˆå¸¸è§çš„ã€‚

```go
func ShutdownVMs(ids []string) error
```

è¿™åªæ˜¯æˆ‘ç¼–çš„ä¸€ä¸ªä¾‹å­ï¼Œä½†å®ƒä¸æˆ‘æ‰€å†™çš„å¾ˆå¤šä»£ç ç›¸åŒã€‚è¿™é‡Œçš„é—®é¢˜æ˜¯ä»–ä»¬å‡è®¾ä»–ä»¬ä¼šè¢«è°ƒç”¨äºå¤šä¸ªæ¡ç›®ã€‚ ä½†æ˜¯å¾ˆå¤šæ—¶å€™è¿™äº›ç±»å‹çš„å‡½æ•°åªç”¨ä¸€ä¸ªå‚æ•°è°ƒç”¨ï¼Œä¸ºäº†æ»¡è¶³å‡½æ•°å‚æ•°çš„è¦æ±‚ï¼Œå®ƒå¿…é¡»æ‰“åŒ…åˆ°ä¸€ä¸ªåˆ‡ç‰‡å†…ã€‚

å¦å¤–ï¼Œå› ä¸º`ids`å‚æ•°æ˜¯åˆ‡ç‰‡ï¼Œæ‰€ä»¥ä½ å¯ä»¥å°†ä¸€ä¸ªç©ºåˆ‡ç‰‡æˆ–`nil`ä¼ é€’ç»™è¯¥å‡½æ•°ï¼Œç¼–è¯‘ä¹Ÿæ²¡ä»€ä¹ˆé”™è¯¯ã€‚ä½†æ˜¯è¿™ä¼šå¢åŠ é¢å¤–çš„æµ‹è¯•è´Ÿè½½ï¼Œå› ä¸ºä½ åº”è¯¥æ¶µç›–è¿™äº›æƒ…å†µåœ¨æµ‹è¯•ä¸­ã€‚

ä¸¾ä¸€ä¸ªè¿™ç±» API çš„ä¾‹å­ï¼Œæœ€è¿‘æˆ‘é‡æ„äº†ä¸€æ¡é€»è¾‘ï¼Œè¦æ±‚æˆ‘è®¾ç½®ä¸€äº›é¢å¤–çš„å­—æ®µï¼Œå¦‚æœä¸€ç»„å‚æ•°ä¸­è‡³å°‘æœ‰ä¸€ä¸ªéé›¶ã€‚é€»è¾‘çœ‹èµ·æ¥åƒè¿™æ ·ï¼š

```go
if svc.MaxConnections > 0 || svc.MaxPendingRequests > 0 || svc.MaxRequests > 0 || svc.MaxRetries > 0 {
	// apply the non zero parameters
}
```

ç”±äº`if`è¯­å¥å˜å¾—å¾ˆé•¿ï¼Œæˆ‘æƒ³å°†ç­¾å‡ºçš„é€»è¾‘æ‹‰å…¥å…¶è‡ªå·±çš„å‡½æ•°ä¸­ã€‚è¿™å°±æ˜¯æˆ‘æå‡ºçš„ï¼š

```go
// anyPostive indicates if any value is greater than zero.
func anyPositive(values ...int) bool {
	for _, v := range values {
		if v > 0 {
			return true
		}
	}
	return false
}
```

è¿™å°±èƒ½å¤Ÿå‘è¯»è€…æ˜ç¡®å†…éƒ¨å—çš„æ‰§è¡Œæ¡ä»¶ï¼š

```go
if anyPositive(svc.MaxConnections, svc.MaxPendingRequests, svc.MaxRequests, svc.MaxRetries) {
        // apply the non zero parameters
}
```

ä½†æ˜¯`anyPositive`è¿˜å­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼Œæœ‰äººå¯èƒ½ä¼šè¿™æ ·è°ƒç”¨å®ƒ:

```go
if anyPositive() { ... }
```

åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œ`anyPositive`å°†è¿”å›`false`ï¼Œå› ä¸ºå®ƒä¸ä¼šæ‰§è¡Œè¿­ä»£è€Œæ˜¯ç«‹å³è¿”å›`false`ã€‚å¯¹æ¯”èµ·å¦‚æœ`anyPositive`åœ¨æ²¡æœ‰ä¼ é€’å‚æ•°æ—¶è¿”å›`true`, è¿™è¿˜ä¸ç®—ä¸–ç•Œä¸Šæœ€ç³Ÿç³•çš„äº‹æƒ…ã€‚

ç„¶è€Œï¼Œå¦‚æœæˆ‘ä»¬å¯ä»¥æ›´æ”¹`anyPositive`çš„ç­¾åä»¥å¼ºåˆ¶è°ƒç”¨è€…åº”è¯¥ä¼ é€’è‡³å°‘ä¸€ä¸ªå‚æ•°ï¼Œé‚£ä¼šæ›´å¥½ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ç»„åˆæ­£å¸¸å’Œå¯å˜å‚æ•°æ¥åšåˆ°è¿™ä¸€ç‚¹ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```go
// anyPostive indicates if any value is greater than zero.
func anyPositive(first int, rest ...int) bool {
	if first > 0 {
		return true
	}
	for _, v := range rest {
		if v > 0 {
			return true
		}
	}
	return false
}
```

ç°åœ¨ä¸èƒ½ä½¿ç”¨å°‘äºä¸€ä¸ªå‚æ•°æ¥è°ƒç”¨`anyPositive`ã€‚

#### 6.3. è®©å‡½æ•°å®šä¹‰å®ƒä»¬æ‰€éœ€çš„è¡Œä¸º

å‡è®¾æˆ‘éœ€è¦ç¼–å†™ä¸€ä¸ªå°†`Document`ç»“æ„ä¿å­˜åˆ°ç£ç›˜çš„å‡½æ•°çš„ä»»åŠ¡ã€‚

```go
// Save writes the contents of doc to the file f.
func Save(f *os.File, doc *Document) error
```

æˆ‘å¯ä»¥æŒ‡å®šè¿™ä¸ªå‡½æ•°`Save`ï¼Œå®ƒå°†`*os.File`ä½œä¸ºå†™å…¥`Document`çš„ç›®æ ‡ã€‚ä½†è¿™æ ·åšä¼šæœ‰ä¸€äº›é—®é¢˜

`Save`çš„ç­¾åæ’é™¤äº†å°†æ•°æ®å†™å…¥ç½‘ç»œä½ç½®çš„é€‰é¡¹ã€‚å‡è®¾ç½‘ç»œå­˜å‚¨å¯èƒ½åœ¨ä»¥åæˆä¸ºéœ€æ±‚ï¼Œåˆ™æ­¤åŠŸèƒ½çš„ç­¾åå¿…é¡»æ”¹å˜ï¼Œä»è€Œå½±å“å…¶æ‰€æœ‰è°ƒç”¨è€…ã€‚

`Save`æµ‹è¯•èµ·æ¥ä¹Ÿå¾ˆéº»çƒ¦ï¼Œå› ä¸ºå®ƒç›´æ¥æ“ä½œç£ç›˜ä¸Šçš„æ–‡ä»¶ã€‚å› æ­¤ï¼Œä¸ºäº†éªŒè¯å…¶æ“ä½œï¼Œæµ‹è¯•æ—¶å¿…é¡»åœ¨å†™å…¥æ–‡ä»¶åå†è¯»å–è¯¥æ–‡ä»¶çš„å†…å®¹ã€‚

è€Œä¸”æˆ‘å¿…é¡»ç¡®ä¿`f`è¢«å†™å…¥ä¸´æ—¶ä½ç½®å¹¶ä¸”éšåè¦å°†å…¶åˆ é™¤ã€‚

`*os.File`è¿˜å®šä¹‰äº†è®¸å¤šä¸`Save`æ— å…³çš„æ–¹æ³•ï¼Œæ¯”å¦‚è¯»å–ç›®å½•å¹¶æ£€æŸ¥è·¯å¾„æ˜¯å¦æ˜¯ç¬¦å·é“¾æ¥ã€‚å¦‚æœ`Save`å‡½æ•°çš„ç­¾ååªç”¨`*os.File`çš„ç›¸å…³å†…å®¹ï¼Œé‚£å°†ä¼šå¾ˆæœ‰ç”¨ã€‚

æˆ‘ä»¬èƒ½åšä»€ä¹ˆ ï¼Ÿ

```go
// Save writes the contents of doc to the supplied
// ReadWriterCloser.
func Save(rwc io.ReadWriteCloser, doc *Document) error
```

ä½¿ç”¨`io.ReadWriteCloser`ï¼Œæˆ‘ä»¬å¯ä»¥åº”ç”¨[æ¥å£éš”ç¦»åŸåˆ™](https://zh.wikipedia.org/wiki/%E6%8E%A5%E5%8F%A3%E9%9A%94%E7%A6%BB%E5%8E%9F%E5%88%99)æ¥é‡æ–°å®šä¹‰`Save`ä»¥è·å–æ›´é€šç”¨æ–‡ä»¶å½¢å¼ã€‚

é€šè¿‡æ­¤æ›´æ”¹ï¼Œä»»ä½•å®ç°`io.ReadWriteCloser`æ¥å£çš„ç±»å‹éƒ½å¯ä»¥æ›¿æ¢ä»¥å‰çš„`*os.File`ã€‚

è¿™ä½¿`Save`åœ¨å…¶åº”ç”¨ç¨‹åºä¸­æ›´å¹¿æ³›ï¼Œå¹¶å‘`Save`çš„è°ƒç”¨è€…é˜æ˜`*os.File`ç±»å‹çš„å“ªäº›æ–¹æ³•ä¸å…¶æ“ä½œæœ‰å…³ã€‚

è€Œä¸”ï¼Œ`Save`çš„ä½œè€…ä¹Ÿä¸å¯ä»¥åœ¨`*os.File`ä¸Šè°ƒç”¨é‚£äº›ä¸ç›¸å…³çš„æ–¹æ³•ï¼Œå› ä¸ºå®ƒéšè—åœ¨`io.ReadWriteCloser`æ¥å£åé¢ã€‚

ä½†æˆ‘ä»¬å¯ä»¥è¿›ä¸€æ­¥é‡‡ç”¨[æ¥å£éš”ç¦»åŸåˆ™](https://zh.wikipedia.org/wiki/%E6%8E%A5%E5%8F%A3%E9%9A%94%E7%A6%BB%E5%8E%9F%E5%88%99)ã€‚

é¦–å…ˆï¼Œå¦‚æœ`Save`éµå¾ª[å•ä¸€åŠŸèƒ½åŸåˆ™](https://zh.wikipedia.org/wiki/%E5%8D%95%E4%B8%80%E5%8A%9F%E8%83%BD%E5%8E%9F%E5%88%99)ï¼Œå®ƒä¸å¯èƒ½è¯»å–å®ƒåˆšåˆšå†™å…¥çš„æ–‡ä»¶æ¥éªŒè¯å…¶å†…å®¹ - è¿™åº”è¯¥æ˜¯å¦ä¸€æ®µä»£ç çš„åŠŸèƒ½ã€‚

```go
// Save writes the contents of doc to the supplied
// WriteCloser.
func Save(wc io.WriteCloser, doc *Document) error
```

å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥å°†æˆ‘ä»¬ä¼ é€’ç»™`Save`çš„æ¥å£çš„è§„èŒƒç¼©å°åˆ°åªå†™å’Œå…³é—­ã€‚

å…¶æ¬¡ï¼Œé€šè¿‡å‘`Save`æä¾›ä¸€ä¸ªå…³é—­å…¶æµçš„æœºåˆ¶ï¼Œä½¿å…¶çœ‹èµ·æ¥ä»ç„¶åƒä¸€ä¸ªæ–‡ä»¶ï¼Œè¿™å°±æå‡ºäº†åœ¨ä»€ä¹ˆæƒ…å†µä¸‹å…³é—­`wc`çš„é—®é¢˜ã€‚

å¯èƒ½`Save`ä¼šæ— æ¡ä»¶åœ°è°ƒç”¨`Close`ï¼Œæˆ–è€…åœ¨æˆåŠŸçš„æƒ…å†µä¸‹è°ƒç”¨`Close`ã€‚

è¿™ç»™`Save`çš„è°ƒç”¨è€…å¸¦æ¥äº†é—®é¢˜ï¼Œå› ä¸ºå®ƒå¯èƒ½å¸Œæœ›åœ¨å†™å…¥æ–‡æ¡£åå°†å…¶ä»–æ•°æ®å†™å…¥æµã€‚

```go
// Save writes the contents of doc to the supplied
// Writer.
func Save(w io.Writer, doc *Document) error
```

ä¸€ä¸ªæ›´å¥½çš„è§£å†³æ–¹æ¡ˆæ˜¯é‡æ–°å®šä¹‰`Save`ä»…ä½¿ç”¨`io.Writer`ï¼Œå®ƒåªè´Ÿè´£å°†æ•°æ®å†™å…¥æµã€‚

å°†[æ¥å£éš”ç¦»åŸåˆ™](https://zh.wikipedia.org/wiki/%E6%8E%A5%E5%8F%A3%E9%9A%94%E7%A6%BB%E5%8E%9F%E5%88%99)åº”ç”¨äºæˆ‘ä»¬çš„`Save`åŠŸèƒ½ï¼ŒåŒæ—¶, å°±éœ€æ±‚è€Œè¨€, å¾—å‡ºäº†æœ€å…·ä½“çš„ä¸€ä¸ªå‡½æ•° - å®ƒåªéœ€è¦ä¸€ä¸ªå¯å†™çš„ä¸œè¥¿ - å¹¶ä¸”å®ƒçš„åŠŸèƒ½æœ€é€šç”¨ï¼Œç°åœ¨æˆ‘ä»¬å¯ä»¥ä½¿ç”¨`Save`å°†æˆ‘ä»¬çš„æ•°æ®ä¿å­˜åˆ°å®ç°`io.Writer`çš„ä»»ä½•äº‹ç‰©ä¸­ã€‚

[[è¯‘æ³¨: ä¸ç†è§£è®¾è®¡åŸåˆ™éƒ¨åˆ†çš„åŒå­¦å¯ä»¥é˜…è¯» Dave å¤§ç¥çš„å¦ä¸€ç¯‡<Go è¯­è¨€ SOLID è®¾è®¡>]](https://www.jianshu.com/p/0aebd9618300)

### 7. é”™è¯¯å¤„ç†

æˆ‘å·²ç»ç»™å‡ºäº†å‡ ä¸ªå…³äºé”™è¯¯å¤„ç†çš„æ¼”ç¤ºæ–‡ç¨¿[[8]](https://dave.cheney.net/2016/04/27/dont-just-check-errors-handle-them-gracefully)ï¼Œå¹¶åœ¨æˆ‘çš„åšå®¢ä¸Šå†™äº†å¾ˆå¤šå…³äºé”™è¯¯å¤„ç†çš„æ–‡ç« ã€‚æˆ‘åœ¨æ˜¨å¤©çš„ä¼šè®®ä¸Šä¹Ÿè®²äº†å¾ˆå¤šå…³äºé”™è¯¯å¤„ç†çš„å†…å®¹ï¼Œæ‰€ä»¥åœ¨è¿™é‡Œä¸å†èµ˜è¿°ã€‚

- <https://dave.cheney.net/2014/12/24/inspecting-errors>
- <https://dave.cheney.net/2016/04/07/constant-errors>

ç›¸åï¼Œæˆ‘æƒ³ä»‹ç»ä¸é”™è¯¯å¤„ç†ç›¸å…³çš„ä¸¤ä¸ªå…¶ä»–æ–¹é¢ã€‚

#### 7.1. é€šè¿‡æ¶ˆé™¤é”™è¯¯æ¥æ¶ˆé™¤é”™è¯¯å¤„ç†

å¦‚æœä½ æ˜¨å¤©åœ¨æˆ‘çš„æ¼”è®²ä¸­ï¼Œæˆ‘è°ˆåˆ°äº†æ”¹è¿›é”™è¯¯å¤„ç†çš„ææ¡ˆã€‚ä½†æ˜¯ä½ çŸ¥é“æœ‰ä»€ä¹ˆæ¯”æ”¹è¿›é”™è¯¯å¤„ç†çš„è¯­æ³•æ›´å¥½å—ï¼Ÿé‚£å°±æ˜¯æ ¹æœ¬ä¸éœ€è¦å¤„ç†é”™è¯¯ã€‚

> æ³¨æ„:
> æˆ‘ä¸æ˜¯è¯´â€œåˆ é™¤ä½ çš„é”™è¯¯å¤„ç†â€ã€‚æˆ‘çš„å»ºè®®æ˜¯ï¼Œä¿®æ”¹ä½ çš„ä»£ç ï¼Œè¿™æ ·å°±ä¸ç”¨å¤„ç†é”™è¯¯äº†ã€‚

æœ¬èŠ‚ä»`John Ousterhout`æœ€è¿‘çš„è‘—ä½œâ€œè½¯ä»¶è®¾è®¡å“²å­¦â€[[9]](https://www.amazon.com/Philosophy-Software-Design-John-Ousterhout/dp/1732102201)ä¸­æ±²å–çµæ„Ÿã€‚è¯¥ä¹¦çš„å…¶ä¸­ä¸€ç« æ˜¯â€œå®šä¹‰ä¸å­˜åœ¨çš„é”™è¯¯â€ã€‚æˆ‘ä»¬å°†å°è¯•å°†æ­¤å»ºè®®åº”ç”¨äº Go è¯­è¨€ã€‚

#### 7.1.1. è®¡ç®—è¡Œæ•°

è®©æˆ‘ä»¬ç¼–å†™ä¸€ä¸ªå‡½æ•°æ¥è®¡ç®—æ–‡ä»¶ä¸­çš„è¡Œæ•°ã€‚

```go
func CountLines(r io.Reader) (int, error) {
	var (
		br    = bufio.NewReader(r)
		lines int
		err   error
	)

	for {
		_, err = br.ReadString('\n')
		lines++
		if err != nil {
			break
		}
	}

	if err != io.EOF {
		return 0, err
	}
	return lines, nil
}
```

ç”±äºæˆ‘ä»¬éµå¾ªå‰é¢éƒ¨åˆ†çš„å»ºè®®ï¼Œ`CountLines`éœ€è¦ä¸€ä¸ª`io.Reader`ï¼Œè€Œä¸æ˜¯ä¸€ä¸ª`*File`; å®ƒçš„ä»»åŠ¡æ˜¯è°ƒç”¨è€…ä¸ºæˆ‘ä»¬æƒ³è¦è®¡ç®—çš„å†…å®¹æä¾›`io.Reader`ã€‚

æˆ‘ä»¬æ„é€ ä¸€ä¸ª`bufio.Reader`ï¼Œç„¶ååœ¨ä¸€ä¸ªå¾ªç¯ä¸­è°ƒç”¨`ReadString`æ–¹æ³•ï¼Œé€’å¢è®¡æ•°å™¨ç›´åˆ°æˆ‘ä»¬åˆ°è¾¾æ–‡ä»¶çš„æœ«å°¾ï¼Œç„¶åæˆ‘ä»¬è¿”å›è¯»å–çš„è¡Œæ•°ã€‚

è‡³å°‘è¿™æ˜¯æˆ‘ä»¬æƒ³è¦ç¼–å†™çš„ä»£ç ï¼Œä½†æ˜¯è¿™ä¸ªå‡½æ•°ç”±äºéœ€è¦é”™è¯¯å¤„ç†è€Œå˜å¾—æ›´åŠ å¤æ‚ã€‚ä¾‹å¦‚ï¼Œæœ‰è¿™æ ·ä¸€ä¸ªå¥‡æ€ªçš„ç»“æ„:

```go
_, err = br.ReadString('\n')
lines++
if err != nil {
    break
}
```

æˆ‘ä»¬åœ¨æ£€æŸ¥é”™è¯¯ä¹‹å‰å¢åŠ äº†è¡Œæ•°ï¼Œè¿™æ ·åšçœ‹èµ·æ¥å¾ˆå¥‡æ€ªã€‚

æˆ‘ä»¬å¿…é¡»ä»¥è¿™ç§æ–¹å¼ç¼–å†™å®ƒçš„åŸå› æ˜¯ï¼Œå¦‚æœåœ¨é‡åˆ°æ¢è¡Œç¬¦ä¹‹å‰å°±è¯»åˆ°æ–‡ä»¶ç»“æŸï¼Œåˆ™`ReadString`å°†è¿”å›é”™è¯¯ã€‚å¦‚æœæ–‡ä»¶ä¸­æ²¡æœ‰æ¢è¡Œç¬¦ï¼ŒåŒæ ·ä¼šå‡ºç°è¿™ç§æƒ…å†µã€‚

ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬é‡æ–°æ’åˆ—é€»è¾‘å¢æ¥åŠ è¡Œæ•°ï¼Œç„¶åæŸ¥çœ‹æ˜¯å¦éœ€è¦é€€å‡ºå¾ªç¯ã€‚

> æ³¨æ„:
> è¿™ä¸ªé€»è¾‘ä»ç„¶ä¸å®Œç¾ï¼Œä½ èƒ½å‘ç°é”™è¯¯å—ï¼Ÿ

ä½†æ˜¯æˆ‘ä»¬è¿˜æ²¡æœ‰å®Œæˆæ£€æŸ¥é”™è¯¯ã€‚å½“`ReadString`åˆ°è¾¾æ–‡ä»¶æœ«å°¾æ—¶ï¼Œé¢„æœŸå®ƒä¼šè¿”å›`io.EOF`ã€‚`ReadString`éœ€è¦æŸç§æ–¹å¼åœ¨æ²¡æœ‰ä»€ä¹ˆå¯è¯»æ—¶æ¥åœæ­¢ã€‚å› æ­¤ï¼Œåœ¨æˆ‘ä»¬å°†é”™è¯¯è¿”å›ç»™`CountLine`çš„è°ƒç”¨è€…ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦æ£€æŸ¥é”™è¯¯æ˜¯å¦æ˜¯`io.EOF`ï¼Œå¦‚æœä¸æ˜¯å°†å…¶é”™è¯¯è¿”å›ï¼Œå¦åˆ™æˆ‘ä»¬è¿”å›`nil`è¯´ä¸€åˆ‡æ­£å¸¸ã€‚

æˆ‘è®¤ä¸ºè¿™æ˜¯`Russ Cox`è§‚å¯Ÿåˆ°é”™è¯¯å¤„ç†å¯èƒ½ä¼šæ¨¡ â€‹â€‹ ç³Šå‡½æ•°æ“ä½œçš„ä¸€ä¸ªå¾ˆå¥½çš„ä¾‹å­ã€‚æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªæ”¹è¿›çš„ç‰ˆæœ¬ã€‚

```go
func CountLines(r io.Reader) (int, error) {
	sc := bufio.NewScanner(r)
	lines := 0

	for sc.Scan() {
		lines++
	}
	return lines, sc.Err()
}
```

è¿™ä¸ªæ”¹è¿›çš„ç‰ˆæœ¬ä»`bufio.Reader`åˆ‡æ¢åˆ°`bufio.Scanner`ã€‚

åœ¨`bufio.Scanner`å†…éƒ¨ä½¿ç”¨`bufio.Reader`ï¼Œä½†å®ƒæ·»åŠ äº†ä¸€ä¸ªå¾ˆå¥½çš„æŠ½è±¡å±‚ï¼Œå®ƒæœ‰åŠ©äºé€šè¿‡éšè—`CountLines`çš„æ“ä½œæ¥æ¶ˆé™¤é”™è¯¯å¤„ç†ã€‚

> æ³¨æ„:
> `bufio.Scanner`å¯ä»¥æ‰«æä»»ä½•æ¨¡å¼ï¼Œä½†é»˜è®¤æƒ…å†µä¸‹å®ƒä¼šæŸ¥æ‰¾æ¢è¡Œç¬¦ã€‚

å¦‚æœæ‰«æç¨‹åºåŒ¹é…äº†ä¸€è¡Œæ–‡æœ¬å¹¶ä¸”æ²¡æœ‰é‡åˆ°é”™è¯¯ï¼Œåˆ™`sc.Scan()`æ–¹æ³•è¿”å›`true`ã€‚å› æ­¤ï¼Œåªæœ‰å½“æ‰«æä»ªçš„ç¼“å†²åŒºä¸­æœ‰ä¸€è¡Œæ–‡æœ¬æ—¶ï¼Œæ‰ä¼šè°ƒç”¨`for`å¾ªç¯çš„ä¸»ä½“ã€‚è¿™æ„å‘³ç€æˆ‘ä»¬ä¿®æ”¹åçš„`CountLines`æ­£ç¡®å¤„ç†æ²¡æœ‰æ¢è¡Œç¬¦çš„æƒ…å†µï¼Œå¹¶ä¸”è¿˜å¤„ç†æ–‡ä»¶ä¸ºç©ºçš„æƒ…å†µã€‚

å…¶æ¬¡ï¼Œå½“`sc.Scan`åœ¨é‡åˆ°é”™è¯¯æ—¶è¿”å›`false`ï¼Œæˆ‘ä»¬çš„`for`å¾ªç¯å°†åœ¨åˆ°è¾¾æ–‡ä»¶ç»“å°¾æˆ–é‡åˆ°é”™è¯¯æ—¶é€€å‡ºã€‚`bufio.Scanner`ç±»å‹ä¼šè®°ä½é‡åˆ°çš„ç¬¬ä¸€ä¸ªé”™è¯¯ï¼Œä¸€æ—¦æˆ‘ä»¬ä½¿ç”¨`sc.Err()`æ–¹æ³•é€€å‡ºå¾ªç¯ï¼Œæˆ‘ä»¬å°±å¯ä»¥è·å–è¯¥é”™è¯¯ã€‚

æœ€åï¼Œ`sc.Err()`è´Ÿè´£å¤„ç†`io.EOF`å¹¶åœ¨è¾¾åˆ°æ–‡ä»¶æœ«å°¾æ—¶å°†å…¶è½¬æ¢ä¸º`nil`ï¼Œè€Œä¸ä¼šé‡åˆ°å…¶ä»–é”™è¯¯ã€‚

> è´´å£«:
> å½“é‡åˆ°éš¾ä»¥å¿å—çš„é”™è¯¯å¤„ç†æ—¶ï¼Œè¯·å°è¯•å°†æŸäº›æ“ä½œæå–åˆ°è¾…åŠ©ç¨‹åºç±»å‹ä¸­ã€‚

#### 7.1.2. WriteResponse

æˆ‘çš„ç¬¬äºŒä¸ªä¾‹å­å—åˆ°äº†`Errors are values`åšå®¢æ–‡ç« [[10]](https://blog.golang.org/errors-are-values)çš„å¯å‘ã€‚

åœ¨æœ¬ç« å‰é¢æˆ‘ä»¬å·²ç»çœ‹è¿‡å¤„ç†æ‰“å¼€ã€å†™å…¥å’Œå…³é—­æ–‡ä»¶çš„ç¤ºä¾‹ã€‚é”™è¯¯å¤„ç†æ˜¯å­˜åœ¨çš„ï¼Œä½†æ˜¯æ¥æ”¶èŒƒå›´å†…çš„ï¼Œå› ä¸ºæ“ä½œå¯ä»¥å°è£…åœ¨è¯¸å¦‚`ioutil.ReadFile`å’Œ`ioutil.WriteFile`ä¹‹ç±»çš„è¾…åŠ©ç¨‹åºä¸­ã€‚ä½†æ˜¯ï¼Œåœ¨å¤„ç†åº•å±‚ç½‘ç»œåè®®æ—¶ï¼Œæœ‰å¿…è¦ä½¿ç”¨`I/O`åŸå§‹çš„é”™è¯¯å¤„ç†æ¥ç›´æ¥æ„å»ºå“åº”ï¼Œè¿™æ ·å°±å¯èƒ½ä¼šå˜å¾—é‡å¤ã€‚çœ‹ä¸€ä¸‹æ„å»º`HTTP`å“åº”çš„`HTTP`æœåŠ¡å™¨çš„è¿™ä¸ªç‰‡æ®µã€‚

```go
type Header struct {
	Key, Value string
}

type Status struct {
	Code   int
	Reason string
}

func WriteResponse(w io.Writer, st Status, headers []Header, body io.Reader) error {
	_, err := fmt.Fprintf(w, "HTTP/1.1 %d %s\r\n", st.Code, st.Reason)
	if err != nil {
		return err
	}

	for _, h := range headers {
		_, err := fmt.Fprintf(w, "%s: %s\r\n", h.Key, h.Value)
		if err != nil {
			return err
		}
	}

	if _, err := fmt.Fprint(w, "\r\n"); err != nil {
		return err
	}

	_, err = io.Copy(w, body)
	return err
}
```

é¦–å…ˆï¼Œæˆ‘ä»¬ä½¿ç”¨`fmt.Fprintf`æ„é€ çŠ¶æ€ç å¹¶æ£€æŸ¥é”™è¯¯ã€‚ç„¶åå¯¹äºæ¯ä¸ªæ ‡é¢˜ï¼Œæˆ‘ä»¬å†™å…¥é”®å€¼å¯¹ï¼Œæ¯æ¬¡éƒ½æ£€æŸ¥é”™è¯¯ã€‚ æœ€åï¼Œæˆ‘ä»¬ä½¿ç”¨é¢å¤–çš„`\r\n`ç»ˆæ­¢æ ‡é¢˜éƒ¨åˆ†ï¼Œæ£€æŸ¥é”™è¯¯ä¹‹åå°†å“åº”ä¸»ä½“å¤åˆ¶åˆ°å®¢æˆ·ç«¯ã€‚æœ€åï¼Œè™½ç„¶æˆ‘ä»¬ä¸éœ€è¦æ£€æŸ¥`io.Copy`ä¸­çš„é”™è¯¯ï¼Œä½†æˆ‘ä»¬éœ€è¦å°†`io.Copy`è¿”å›çš„ä¸¤ä¸ªè¿”å›å€¼å½¢å¼è½¬æ¢ä¸º`WriteResponse`çš„å•ä¸ªè¿”å›å€¼ã€‚

è¿™é‡Œå¾ˆå¤šé‡å¤æ€§çš„å·¥ä½œã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡å¼•å…¥ä¸€ä¸ªåŒ…è£…å™¨ç±»å‹`errWriter`æ¥ä½¿å…¶æ›´å®¹æ˜“ã€‚

`errWriter`å®ç°`io.Writer`æ¥å£ï¼Œå› æ­¤å¯ç”¨äºåŒ…è£…ç°æœ‰çš„`io.Writer`ã€‚`errWriter`å†™å…¥ä¼ é€’ç»™å…¶åº•å±‚`writer`ï¼Œç›´åˆ°æ£€æµ‹åˆ°é”™è¯¯ã€‚ä»æ­¤æ—¶èµ·ï¼Œå®ƒä¼šä¸¢å¼ƒä»»ä½•å†™å…¥å¹¶è¿”å›å…ˆå‰çš„é”™è¯¯ã€‚

```go
type errWriter struct {
	io.Writer
	err error
}

func (e *errWriter) Write(buf []byte) (int, error) {
	if e.err != nil {
		return 0, e.err
	}
	var n int
	n, e.err = e.Writer.Write(buf)
	return n, nil
}

func WriteResponse(w io.Writer, st Status, headers []Header, body io.Reader) error {
	ew := &errWriter{Writer: w}
	fmt.Fprintf(ew, "HTTP/1.1 %d %s\r\n", st.Code, st.Reason)

	for _, h := range headers {
		fmt.Fprintf(ew, "%s: %s\r\n", h.Key, h.Value)
	}

	fmt.Fprint(ew, "\r\n")
	io.Copy(ew, body)
	return ew.err
}
```

å°†`errWriter`åº”ç”¨äº`WriteResponse`å¯ä»¥æ˜¾ç€æé«˜ä»£ç çš„æ¸…æ™°åº¦ã€‚æ¯ä¸ªæ“ä½œä¸å†éœ€è¦è‡ªå·±åšé”™è¯¯æ£€æŸ¥ã€‚é€šè¿‡æ£€æŸ¥`ew.err`å­—æ®µï¼Œå°†é”™è¯¯æŠ¥å‘Šç§»åŠ¨åˆ°å‡½æ•°æœ«å°¾ï¼Œä»è€Œé¿å…è½¬æ¢ä»`io.Copy`çš„ä¸¤ä¸ªè¿”å›å€¼ã€‚

#### 7.2. é”™è¯¯åªå¤„ç†ä¸€æ¬¡

æœ€åï¼Œæˆ‘æƒ³æä¸€ä¸‹ä½ åº”è¯¥åªå¤„ç†é”™è¯¯ä¸€æ¬¡ã€‚å¤„ç†é”™è¯¯æ„å‘³ç€æ£€æŸ¥é”™è¯¯å€¼å¹¶åšå‡ºå•ä¸€å†³å®šã€‚

```go
// WriteAll writes the contents of buf to the supplied writer.
func WriteAll(w io.Writer, buf []byte) {
        w.Write(buf)
}
```

å¦‚æœä½ åšå‡ºçš„å†³å®šå°‘äºä¸€ä¸ªï¼Œåˆ™å¿½ç•¥è¯¥é”™è¯¯ã€‚æ­£å¦‚æˆ‘ä»¬åœ¨è¿™é‡Œçœ‹åˆ°çš„é‚£æ ·ï¼Œ`w.WriteAll`çš„é”™è¯¯è¢«ä¸¢å¼ƒã€‚

ä½†æ˜¯ï¼Œé’ˆå¯¹å•ä¸ªé”™è¯¯åšå‡ºå¤šä¸ªå†³ç­–ä¹Ÿæ˜¯æœ‰é—®é¢˜çš„ã€‚ä»¥ä¸‹æ˜¯æˆ‘ç»å¸¸é‡åˆ°çš„ä»£ç ã€‚

```go
func WriteAll(w io.Writer, buf []byte) error {
	_, err := w.Write(buf)
	if err != nil {
		log.Println("unable to write:", err) // annotated error goes to log file
		return err                           // unannotated error returned to caller
	}
	return nil
}
```

åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œå¦‚æœåœ¨`w.Write`æœŸé—´å‘ç”Ÿé”™è¯¯ï¼Œåˆ™ä¼šå†™å…¥æ—¥å¿—æ–‡ä»¶ï¼Œæ³¨æ˜é”™è¯¯å‘ç”Ÿçš„æ–‡ä»¶ä¸è¡Œæ•°ï¼Œå¹¶ä¸”é”™è¯¯ä¹Ÿä¼šè¿”å›ç»™è°ƒç”¨è€…ï¼Œè°ƒç”¨è€…å¯èƒ½ä¼šè®°å½•è¯¥é”™è¯¯å¹¶å°†å…¶è¿”å›åˆ°ä¸Šä¸€çº§ï¼Œä¸€ç›´å›åˆ°ç¨‹åºçš„é¡¶éƒ¨ã€‚

è°ƒç”¨è€…å¯èƒ½æ­£åœ¨åšåŒæ ·çš„äº‹æƒ…

```go
func WriteConfig(w io.Writer, conf *Config) error {
	buf, err := json.Marshal(conf)
	if err != nil {
		log.Printf("could not marshal config: %v", err)
		return err
	}
	if err := WriteAll(w, buf); err != nil {
		log.Println("could not write config: %v", err)
		return err
	}
	return nil
}
```

å› æ­¤ä½ åœ¨æ—¥å¿—æ–‡ä»¶ä¸­å¾—åˆ°ä¸€å †é‡å¤çš„å†…å®¹ï¼Œ

```go
unable to write: io.EOF
could not write config: io.EOF
```

ä½†åœ¨ç¨‹åºçš„é¡¶éƒ¨ï¼Œè™½ç„¶å¾—åˆ°äº†åŸå§‹é”™è¯¯ï¼Œä½†æ²¡æœ‰ç›¸å…³å†…å®¹ã€‚

```go
err := WriteConfig(f, &conf)
fmt.Println(err) // io.EOF
```

æˆ‘æƒ³æ·±å…¥ç ”ç©¶è¿™ä¸€ç‚¹ï¼Œå› ä¸ºä½œä¸ºä¸ªäººåå¥½, æˆ‘å¹¶æ²¡æœ‰çœ‹åˆ°`logging`å’Œè¿”å›çš„é—®é¢˜ã€‚

```go
func WriteConfig(w io.Writer, conf *Config) error {
	buf, err := json.Marshal(conf)
	if err != nil {
		log.Printf("could not marshal config: %v", err)
		// oops, forgot to return
	}
	if err := WriteAll(w, buf); err != nil {
		log.Println("could not write config: %v", err)
		return err
	}
	return nil
}
```

å¾ˆå¤šé—®é¢˜æ˜¯ç¨‹åºå‘˜å¿˜è®°ä»é”™è¯¯ä¸­è¿”å›ã€‚æ­£å¦‚æˆ‘ä»¬ä¹‹å‰è°ˆåˆ°çš„é‚£æ ·ï¼ŒGo è¯­è¨€é£æ ¼æ˜¯ä½¿ç”¨`guard clauses`ä»¥åŠæ£€æŸ¥å‰ææ¡ä»¶ä½œä¸ºå‡½æ•°è¿›å±•å¹¶æå‰è¿”å›ã€‚

åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œä½œè€…æ£€æŸ¥äº†é”™è¯¯ï¼Œè®°å½•äº†å®ƒï¼Œä½†å¿˜äº†è¿”å›ã€‚è¿™å°±å¼•èµ·äº†ä¸€ä¸ªå¾®å¦™çš„é”™è¯¯ã€‚

Go è¯­è¨€ä¸­çš„é”™è¯¯å¤„ç†è§„å®šï¼Œå¦‚æœå‡ºç°é”™è¯¯ï¼Œä½ ä¸èƒ½å¯¹å…¶ä»–è¿”å›å€¼çš„å†…å®¹åšå‡ºä»»ä½•å‡è®¾ã€‚ç”±äº`JSON`è§£æå¤±è´¥ï¼Œ`buf`çš„å†…å®¹æœªçŸ¥ï¼Œå¯èƒ½å®ƒä»€ä¹ˆéƒ½æ²¡æœ‰ï¼Œä½†æ›´ç³Ÿçš„æ˜¯å®ƒå¯èƒ½åŒ…å«è§£æçš„`JSON`ç‰‡æ®µéƒ¨åˆ†ã€‚

ç”±äºç¨‹åºå‘˜åœ¨æ£€æŸ¥å¹¶è®°å½•é”™è¯¯åå¿˜è®°è¿”å›ï¼Œå› æ­¤æŸåçš„ç¼“å†²åŒºå°†ä¼ é€’ç»™`WriteAll`ï¼Œè¿™å¯èƒ½ä¼šæˆåŠŸï¼Œå› æ­¤é…ç½®æ–‡ä»¶å°†è¢«é”™è¯¯åœ°å†™å…¥ã€‚ä½†æ˜¯ï¼Œè¯¥å‡½æ•°ä¼šæ­£å¸¸è¿”å›ï¼Œå¹¶ä¸”å‘ç”Ÿé—®é¢˜çš„å”¯ä¸€æ—¥å¿—è¡Œæ˜¯æœ‰å…³`JSON`è§£æé”™è¯¯ï¼Œè€Œä¸å†™å…¥é…ç½®å¤±è´¥æœ‰å…³ã€‚

#### 7.2.1. ä¸ºé”™è¯¯æ·»åŠ ç›¸å…³å†…å®¹

å‘ç”Ÿé”™è¯¯çš„åŸå› æ˜¯ä½œè€…è¯•å›¾åœ¨é”™è¯¯æ¶ˆæ¯ä¸­æ·»åŠ `context`ã€‚ä»–ä»¬è¯•å›¾ç»™è‡ªå·±ç•™ä¸‹ä¸€äº›çº¿ç´¢ï¼ŒæŒ‡å‡ºé”™è¯¯çš„æ ¹æºã€‚

è®©æˆ‘ä»¬çœ‹çœ‹ä½¿ç”¨`fmt.Errorf`çš„å¦ä¸€ç§æ–¹å¼ã€‚

```go
func WriteConfig(w io.Writer, conf *Config) error {
	buf, err := json.Marshal(conf)
	if err != nil {
		return fmt.Errorf("could not marshal config: %v", err)
	}
	if err := WriteAll(w, buf); err != nil {
		return fmt.Errorf("could not write config: %v", err)
	}
	return nil
}

func WriteAll(w io.Writer, buf []byte) error {
	_, err := w.Write(buf)
	if err != nil {
		return fmt.Errorf("write failed: %v", err)
	}
	return nil
}
```

é€šè¿‡å°†æ³¨é‡Šä¸è¿”å›çš„é”™è¯¯ç»„åˆèµ·æ¥ï¼Œå°±æ›´éš¾ä»¥å¿˜è®°é”™è¯¯çš„è¿”å›æ¥é¿å…æ„å¤–ç»§ç»­ã€‚

å¦‚æœå†™å…¥æ–‡ä»¶æ—¶å‘ç”Ÿ`I/O`é”™è¯¯ï¼Œåˆ™`error`çš„`Error()`æ–¹æ³•ä¼šæŠ¥å‘Šä»¥ä¸‹ç±»ä¼¼çš„å†…å®¹;

```go
could not write config: write failed: input/output error
```

#### 7.2.2. ä½¿ç”¨`github.com/pkg/errors`åŒ…è£…`errors`

`fmt.Errorf`æ¨¡å¼é€‚ç”¨äºæ³¨é‡Šé”™è¯¯`message`ï¼Œä½†è¿™æ ·åšçš„ä»£ä»·æ˜¯æ¨¡ç³Šäº†åŸå§‹é”™è¯¯çš„ç±»å‹ã€‚æˆ‘è®¤ä¸ºå°†é”™è¯¯è§†ä¸ºä¸é€æ˜å€¼å¯¹äºæ¾æ•£è€¦åˆçš„è½¯ä»¶éå¸¸é‡è¦ï¼Œå› æ­¤å¦‚æœä½ ä½¿ç”¨é”™è¯¯å€¼åšçš„å”¯ä¸€äº‹æƒ…æ˜¯åŸå§‹é”™è¯¯çš„ç±»å‹åº”è¯¥æ— å…³ç´§è¦çš„é¢å­”

1. æ£€æŸ¥å®ƒæ˜¯å¦ä¸º`nil`ã€‚
2. è¾“å‡ºæˆ–è®°å½•å®ƒã€‚

ä½†æ˜¯åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œæˆ‘è®¤ä¸ºå®ƒä»¬å¹¶ä¸å¸¸è§ï¼Œæ‚¨éœ€è¦æ¢å¤åŸå§‹é”™è¯¯ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä½¿ç”¨ç±»ä¼¼æˆ‘çš„`errors`åŒ…æ¥æ³¨é‡Šè¿™æ ·çš„é”™è¯¯, å¦‚ä¸‹

```go
func ReadFile(path string) ([]byte, error) {
	f, err := os.Open(path)
	if err != nil {
		return nil, errors.Wrap(err, "open failed")
	}
	defer f.Close()

	buf, err := ioutil.ReadAll(f)
	if err != nil {
		return nil, errors.Wrap(err, "read failed")
	}
	return buf, nil
}

func ReadConfig() ([]byte, error) {
	home := os.Getenv("HOME")
	config, err := ReadFile(filepath.Join(home, ".settings.xml"))
	return config, errors.WithMessage(err, "could not read config")
}

func main() {
	_, err := ReadConfig()
	if err != nil {
		fmt.Println(err)
		os.Exit(1)
	}
}
```

ç°åœ¨æŠ¥å‘Šçš„é”™è¯¯å°±æ˜¯`Kï¼†D` [[11]](http://www.gopl.io/)æ ·å¼é”™è¯¯ï¼Œ

```go
could not read config: open failed: open /Users/dfc/.settings.xml: no such file or directory
```

å¹¶ä¸”é”™è¯¯å€¼ä¿ç•™å¯¹åŸå§‹åŸå› çš„å¼•ç”¨ã€‚

```go
func main() {
	_, err := ReadConfig()
	if err != nil {
		fmt.Printf("original error: %T %v\n", errors.Cause(err), errors.Cause(err))
		fmt.Printf("stack trace:\n%+v\n", err)
		os.Exit(1)
	}
}
```

å› æ­¤ï¼Œä½ å¯ä»¥æ¢å¤åŸå§‹é”™è¯¯å¹¶æ‰“å°å †æ ˆè·Ÿè¸ª;

```go
original error: *os.PathError open /Users/dfc/.settings.xml: no such file or directory
stack trace:
open /Users/dfc/.settings.xml: no such file or directory
open failed
main.ReadFile
        /Users/dfc/devel/practical-go/src/errors/readfile2.go:16
main.ReadConfig
        /Users/dfc/devel/practical-go/src/errors/readfile2.go:29
main.main
        /Users/dfc/devel/practical-go/src/errors/readfile2.go:35
runtime.main
        /Users/dfc/go/src/runtime/proc.go:201
runtime.goexit
        /Users/dfc/go/src/runtime/asm_amd64.s:1333
could not read config
```

ä½¿ç”¨`errors`åŒ…ï¼Œä½ å¯ä»¥ä»¥äººå’Œæœºå™¨éƒ½å¯æ£€æŸ¥çš„æ–¹å¼å‘é”™è¯¯å€¼æ·»åŠ ä¸Šä¸‹æ–‡ã€‚ å¦‚æœæ˜¨å¤©ä½ æ¥å¬æˆ‘çš„æ¼”è®²ï¼Œä½ ä¼šçŸ¥é“è¿™ä¸ªåº“åœ¨è¢«ç§»æ¤åˆ°å³å°†å‘å¸ƒçš„ Go è¯­è¨€ç‰ˆæœ¬çš„æ ‡å‡†åº“ä¸­ã€‚

### 8. å¹¶å‘

ç”±äº Go è¯­è¨€çš„å¹¶å‘åŠŸèƒ½ï¼Œç»å¸¸è¢«é€‰ä½œé¡¹ç›®ç¼–ç¨‹è¯­è¨€ã€‚Go è¯­è¨€å›¢é˜Ÿå·²ç»ç«­å°½å…¨åŠ›ä»¥å»‰ä»·ï¼ˆåœ¨ç¡¬ä»¶èµ„æºæ–¹é¢ï¼‰å’Œé«˜æ€§èƒ½æ¥å®ç°å¹¶å‘ï¼Œä½†æ˜¯ Go è¯­è¨€çš„å¹¶å‘åŠŸèƒ½ä¹Ÿå¯ä»¥è¢«ç”¨æ¥ç¼–å†™æ€§èƒ½ä¸é«˜åŒæ—¶ä¹Ÿä¸å¤ªå¯é çš„ä»£ç ã€‚åœ¨ç»“å°¾ï¼Œæˆ‘æƒ³ç•™ä¸‹ä¸€äº›å»ºè®®ï¼Œä»¥é¿å… Go è¯­è¨€çš„å¹¶å‘åŠŸèƒ½å¸¦æ¥çš„ä¸€äº›é™·é˜±ã€‚

Go è¯­è¨€ä»¥`channels`ä»¥åŠ`select`å’Œ`go`è¯­å¥æ¥æ”¯æŒå¹¶å‘ã€‚å¦‚æœä½ å·²ç»ä»ä¹¦ç±æˆ–åŸ¹è®­è¯¾ç¨‹ä¸­æ­£å¼å­¦ä¹ äº† Go è¯­è¨€ï¼Œä½ å¯èƒ½å·²ç»æ³¨æ„åˆ°å¹¶å‘éƒ¨åˆ†å§‹ç»ˆæ˜¯è¿™äº›è¯¾ç¨‹çš„æœ€åä¸€éƒ¨åˆ†ã€‚è¿™ä¸ªç ”è®¨ä¼šä¹Ÿæ²¡æœ‰ä»€ä¹ˆä¸åŒï¼Œæˆ‘é€‰æ‹©æœ€åè¦†ç›–å¹¶å‘ï¼Œå¥½åƒå®ƒæ˜¯ Go ç¨‹åºå‘˜åº”è¯¥æŒæ¡çš„å¸¸è§„æŠ€èƒ½çš„é¢å¤–è¡¥å……ã€‚

è¿™é‡Œæœ‰ä¸€ä¸ªäºŒåˆ†æ³•; Go è¯­è¨€çš„æœ€å¤§ç‰¹ç‚¹æ˜¯ç®€å•ã€è½»é‡çº§çš„å¹¶å‘æ¨¡å‹ã€‚ä½œä¸ºä¸€ç§äº§å“ï¼Œæˆ‘ä»¬çš„è¯­è¨€å‡ ä¹åªæ¨å¹¿è¿™ä¸ªåŠŸèƒ½ã€‚å¦ä¸€æ–¹é¢ï¼Œæœ‰ä¸€ç§è¯´æ³•è®¤ä¸ºå¹¶å‘ä½¿ç”¨èµ·æ¥å®é™…ä¸Šå¹¶ä¸å®¹æ˜“ï¼Œå¦åˆ™ä½œè€…ä¸ä¼šæŠŠå®ƒä½œä¸ºä»–ä»¬ä¹¦ä¸­çš„æœ€åä¸€ç« ï¼Œæˆ‘ä»¬ä¹Ÿä¸ä¼šé—æ†¾åœ°æ¥å›é¡¾å…¶å½¢æˆè¿‡ç¨‹ã€‚

æœ¬èŠ‚è®¨è®ºäº† Go è¯­è¨€çš„å¹¶å‘åŠŸèƒ½çš„â€œå‘â€ã€‚

#### 8.1. ä¿æŒè‡ªå·±å¿™ç¢Œæˆ–åšè‡ªå·±çš„å·¥ä½œ

è¿™ä¸ªç¨‹åºæœ‰ä»€ä¹ˆé—®é¢˜ï¼Ÿ

```go
package main

import (
	"fmt"
	"log"
	"net/http"
)

func main() {
	http.HandleFunc("/", func(w http.ResponseWriter, r *http.Request) {
		fmt.Fprintln(w, "Hello, GopherCon SG")
	})
	go func() {
		if err := http.ListenAndServe(":8080", nil); err != nil {
			log.Fatal(err)
		}
	}()

	for {
	}
}
```

è¯¥ç¨‹åºå®ç°äº†æˆ‘ä»¬çš„é¢„æœŸï¼Œå®ƒæä¾›ç®€å•çš„`Web`æœåŠ¡ã€‚ç„¶è€Œï¼Œå®ƒåŒæ—¶ä¹Ÿåšäº†å…¶ä»–äº‹æƒ…ï¼Œå®ƒåœ¨æ— é™å¾ªç¯ä¸­æµªè´¹`CPU`èµ„æºã€‚è¿™æ˜¯å› ä¸º`main`çš„æœ€åä¸€è¡Œä¸Šçš„`for {}`å°†é˜»å¡`main goroutine`ï¼Œå› ä¸ºå®ƒä¸æ‰§è¡Œä»»ä½•`IO`ã€ç­‰å¾…é”å®šã€å‘é€æˆ–æ¥æ”¶é€šé“æ•°æ®æˆ–ä»¥å…¶ä»–æ–¹å¼ä¸è°ƒåº¦å™¨é€šä¿¡ã€‚

ç”±äº Go è¯­è¨€è¿è¡Œæ—¶ä¸»è¦æ˜¯ååŒè°ƒåº¦ï¼Œè¯¥ç¨‹åºå°†åœ¨å•ä¸ª`CPU`ä¸Šåšæ— æ•ˆåœ°æ—‹è½¬ï¼Œå¹¶å¯èƒ½æœ€ç»ˆå®æ—¶é”å®šã€‚

æˆ‘ä»¬å¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜ï¼Ÿ è¿™æ˜¯ä¸€ä¸ªå»ºè®®ã€‚

```go
package main

import (
	"fmt"
	"log"
	"net/http"
	"runtime"
)

func main() {
	http.HandleFunc("/", func(w http.ResponseWriter, r *http.Request) {
		fmt.Fprintln(w, "Hello, GopherCon SG")
	})
	go func() {
		if err := http.ListenAndServe(":8080", nil); err != nil {
			log.Fatal(err)
		}
	}()

	for {
		runtime.Gosched()
	}
}
```

è¿™çœ‹èµ·æ¥å¾ˆæ„šè ¢ï¼Œä½†è¿™æ˜¯æˆ‘çœ‹è¿‡çš„ä¸€ç§å¸¸è§è§£å†³æ–¹æ¡ˆã€‚è¿™æ˜¯ä¸äº†è§£æ½œåœ¨é—®é¢˜çš„ç—‡çŠ¶ã€‚

ç°åœ¨ï¼Œå¦‚æœä½ æœ‰æ›´å¤šçš„ç»éªŒï¼Œä½ å¯èƒ½ä¼šå†™è¿™æ ·çš„ä¸œè¥¿ã€‚

```go
package main

import (
	"fmt"
	"log"
	"net/http"
)

func main() {
	http.HandleFunc("/", func(w http.ResponseWriter, r *http.Request) {
		fmt.Fprintln(w, "Hello, GopherCon SG")
	})
	go func() {
		if err := http.ListenAndServe(":8080", nil); err != nil {
			log.Fatal(err)
		}
	}()

	select {}
}
```

ç©ºçš„`select`è¯­å¥å°†æ°¸è¿œé˜»æ­¢ã€‚è¿™æ˜¯ä¸€ä¸ªæœ‰ç”¨çš„å±æ€§ï¼Œå› ä¸ºç°åœ¨æˆ‘ä»¬ä¸å†è°ƒç”¨`runtime.GoSched()`è€Œè€—è´¹æ•´ä¸ª`CPU`ã€‚ä½†æ˜¯è¿™ä¹Ÿåªæ˜¯æ²»ç–—äº†ç—‡çŠ¶ï¼Œè€Œä¸æ˜¯ç—…æ ¹ã€‚

æˆ‘æƒ³å‘ä½ æå‡ºå¦ä¸€ç§ä½ å¯èƒ½åœ¨ç”¨çš„è§£å†³æ–¹æ¡ˆã€‚ä¸å…¶åœ¨`goroutine`ä¸­è¿è¡Œ`http.ListenAndServe`ï¼Œä¼šç»™æˆ‘ä»¬ç•™ä¸‹å¤„ç†`main goroutine`çš„é—®é¢˜ï¼Œä¸å¦‚åœ¨`main goroutine`æœ¬èº«ä¸Šè¿è¡Œ`http.ListenAndServe`ã€‚

> è´´å£«:
> å¦‚æœ Go è¯­è¨€ç¨‹åºçš„`main.main`å‡½æ•°è¿”å›ï¼Œæ— è®ºç¨‹åºåœ¨ä¸€æ®µæ—¶é—´å†…å¯åŠ¨çš„å…¶ä»–`goroutine`åœ¨åšä»€ä¹ˆ, Go è¯­è¨€ç¨‹åºä¼šæ— æ¡ä»¶åœ°é€€å‡ºã€‚

```go
package main

import (
	"fmt"
	"log"
	"net/http"
)

func main() {
	http.HandleFunc("/", func(w http.ResponseWriter, r *http.Request) {
		fmt.Fprintln(w, "Hello, GopherCon SG")
	})
	if err := http.ListenAndServe(":8080", nil); err != nil {
		log.Fatal(err)
	}
}
```

æ‰€ä»¥è¿™æ˜¯æˆ‘çš„ç¬¬ä¸€æ¡å»ºè®®ï¼šå¦‚æœä½ çš„`goroutine`åœ¨å¾—åˆ°å¦ä¸€ä¸ªç»“æœä¹‹å‰æ— æ³•å–å¾—è¿›å±•ï¼Œé‚£ä¹ˆè®©è‡ªå·±å®Œæˆæ­¤å·¥ä½œè€Œä¸æ˜¯å§”æ‰˜ç»™å…¶ä»–`goroutine`ä¼šæ›´ç®€å•ã€‚

è¿™é€šå¸¸ä¼šæ¶ˆé™¤å°†ç»“æœä»`goroutine`è¿”å›åˆ°å…¶å¯åŠ¨ç¨‹åºæ‰€éœ€çš„å¤§é‡çŠ¶æ€è·Ÿè¸ªå’Œé€šé“æ“ä½œã€‚

> è´´å£«:
> è®¸å¤š Go ç¨‹åºå‘˜è¿‡åº¦ä½¿ç”¨`goroutine`ï¼Œç‰¹åˆ«æ˜¯åˆšå¼€å§‹æ—¶ã€‚ä¸ç”Ÿæ´»ä¸­çš„æ‰€æœ‰äº‹æƒ…ä¸€æ ·ï¼Œé€‚åº¦æ˜¯æˆåŠŸçš„å…³é”®ã€‚

#### 8.2. å°†å¹¶å‘æ€§ç•™ç»™è°ƒç”¨è€…

ä»¥ä¸‹ä¸¤ä¸ª API æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

```go
// ListDirectory returns the contents of dir.
func ListDirectory(dir string) ([]string, error)
```

```go
// ListDirectory returns a channel over which
// directory entries will be published. When the list
// of entries is exhausted, the channel will be closed.
func ListDirectory(dir string) chan string
```

é¦–å…ˆï¼Œæœ€æ˜æ˜¾çš„ä¸åŒ: ç¬¬ä¸€ä¸ªç¤ºä¾‹å°†ç›®å½•è¯»å…¥åˆ‡ç‰‡ç„¶åè¿”å›æ•´ä¸ªåˆ‡ç‰‡ï¼Œå¦‚æœå‡ºé”™åˆ™è¿”å›é”™è¯¯ã€‚è¿™æ˜¯åŒæ­¥å‘ç”Ÿçš„ï¼Œ`ListDirectory`çš„è°ƒç”¨è€…ä¼šé˜»å¡ï¼Œç›´åˆ°è¯»å–äº†æ‰€æœ‰ç›®å½•æ¡ç›®ã€‚æ ¹æ®ç›®å½•çš„å¤§å°ï¼Œè¿™å¯èƒ½éœ€è¦å¾ˆé•¿æ—¶é—´ï¼Œå¹¶ä¸”å¯èƒ½ä¼šåˆ†é…å¤§é‡å†…å­˜æ¥æ„å»ºç›®å½•æ¡ç›®ã€‚

è®©æˆ‘ä»¬çœ‹çœ‹ç¬¬äºŒä¸ªä¾‹å­ã€‚è¿™ä¸ªç¤ºä¾‹æ›´åƒæ˜¯ Go è¯­è¨€é£æ ¼ï¼Œ`ListDirectory`è¿”å›ä¸€ä¸ªé€šé“ï¼Œé€šè¿‡è¯¥é€šé“ä¼ é€’ç›®å½•æ¡ç›®ã€‚å½“é€šé“å…³é—­æ—¶ï¼Œè¡¨æ˜æ²¡æœ‰æ›´å¤šç›®å½•æ¡ç›®ã€‚ç”±äºåœ¨`ListDirectory`è¿”å›åå‘ç”Ÿäº†é€šé“çš„å¡«å……ï¼Œ`ListDirectory`å¯èƒ½ä¼šå¯åŠ¨ä¸€ä¸ª`goroutine`æ¥å¡«å……é€šé“ã€‚

> æ³¨æ„:
> ç¬¬äºŒä¸ªç‰ˆæœ¬å®é™…ä¸Šä¸å¿…ä½¿ç”¨ Go åç¨‹; å®ƒå¯ä»¥åˆ†é…ä¸€ä¸ªè¶³ä»¥ä¿å­˜æ‰€æœ‰ç›®å½•æ¡ç›®è€Œä¸é˜»å¡çš„é€šé“ï¼Œå¡«å……é€šé“ï¼Œå…³é—­å®ƒï¼Œç„¶åå°†é€šé“è¿”å›ç»™è°ƒç”¨è€…ã€‚ä½†è¿™æ ·åšä¸å¤ªç°å®ï¼Œå› ä¸ºä¼šæ¶ˆè€—å¤§é‡å†…å­˜æ¥ç¼“å†²é€šé“ä¸­çš„æ‰€æœ‰ç»“æœã€‚

é€šé“ç‰ˆæœ¬çš„`ListDirectory`è¿˜æœ‰ä¸¤ä¸ªé—®é¢˜ï¼š

- é€šè¿‡ä½¿ç”¨å…³é—­é€šé“ä½œä¸ºæ²¡æœ‰å…¶ä»–é¡¹ç›®è¦å¤„ç†çš„ä¿¡å·ï¼Œåœ¨ä¸­é€”é‡åˆ°äº†é”™è¯¯æ—¶, `ListDirectory`æ— æ³•å‘Šè¯‰è°ƒç”¨è€…é€šè¿‡é€šé“è¿”å›çš„é¡¹ç›®é›†æ˜¯å¦å®Œæ•´ã€‚è°ƒç”¨è€…æ— æ³•åŒºåˆ†ç©ºç›®å½•å’Œè¯»å–ç›®å½•çš„é”™è¯¯ã€‚ä¸¤è€…éƒ½å¯¼è‡´ä»`ListDirectory`è¿”å›çš„é€šé“ç«‹å³å…³é—­ã€‚
- è°ƒç”¨è€…å¿…é¡»æŒç»­ä»é€šé“ä¸­è¯»å–ï¼Œç›´åˆ°å®ƒè¢«å…³é—­ï¼Œå› ä¸ºè¿™æ˜¯è°ƒç”¨è€…çŸ¥é“æ­¤é€šé“çš„æ˜¯å¦åœæ­¢çš„å”¯ä¸€æ–¹å¼ã€‚è¿™æ˜¯å¯¹`ListDirectory`ä½¿ç”¨çš„ä¸¥é‡é™åˆ¶ï¼Œå³ä½¿å¯èƒ½å·²ç»æ”¶åˆ°äº†å®ƒæƒ³è¦çš„ç­”æ¡ˆï¼Œè°ƒç”¨è€…ä¹Ÿå¿…é¡»èŠ±æ—¶é—´ä»é€šé“ä¸­è¯»å–ã€‚å°±ä¸­å‹åˆ°å¤§å‹ç›®å½•çš„å†…å­˜ä½¿ç”¨è€Œè¨€ï¼Œå®ƒå¯èƒ½æ›´æœ‰æ•ˆï¼Œä½†è¿™ç§æ–¹æ³•å¹¶ä¸æ¯”åŸå§‹çš„åŸºäºåˆ‡ç‰‡çš„æ–¹æ³•å¿«ã€‚

ä»¥ä¸Šä¸¤ç§å®ç°æ‰€å¸¦æ¥çš„é—®é¢˜çš„è§£å†³æ–¹æ¡ˆæ˜¯ä½¿ç”¨å›è°ƒï¼Œè¯¥å›è°ƒæ˜¯åœ¨æ‰§è¡Œæ—¶åœ¨æ¯ä¸ªç›®å½•æ¡ç›®çš„ä¸Šä¸‹æ–‡ä¸­è°ƒç”¨å‡½æ•°ã€‚

```go
func ListDirectory(dir string, fn func(string))
```

æ¯«ä¸å¥‡æ€ªï¼Œè¿™å°±æ˜¯`filepath.WalkDir`å‡½æ•°çš„å·¥ä½œæ–¹å¼ã€‚

> è´´å£«:
> å¦‚æœä½ çš„å‡½æ•°å¯åŠ¨äº†`goroutine`ï¼Œä½ å¿…é¡»ä¸ºè°ƒç”¨è€…æä¾›ä¸€ç§æ˜ç¡®åœæ­¢`goroutine`çš„æ–¹æ³•ã€‚ æŠŠå¼‚æ­¥æ‰§è¡Œå‡½æ•°çš„å†³å®šç•™ç»™è¯¥å‡½æ•°çš„è°ƒç”¨è€…é€šå¸¸ä¼šæ›´å®¹æ˜“äº›ã€‚

#### 8.3. æ°¸è¿œä¸è¦å¯åŠ¨ä¸€ä¸ªåœæ­¢ä¸äº†çš„ goroutineã€‚

å‰é¢çš„ä¾‹å­æ˜¾ç¤ºå½“ä¸€ä¸ªä»»åŠ¡æ—¶æ²¡æœ‰å¿…è¦æ—¶ä½¿ç”¨`goroutine`ã€‚ä½†ä½¿ç”¨ Go è¯­è¨€çš„åŸå› ä¹‹ä¸€æ˜¯è¯¥è¯­è¨€æä¾›çš„å¹¶å‘åŠŸèƒ½ã€‚å®é™…ä¸Šï¼Œå¾ˆå¤šæƒ…å†µä¸‹ä½ å¸Œæœ›åˆ©ç”¨ç¡¬ä»¶ä¸­å¯ç”¨çš„å¹¶è¡Œæ€§ã€‚ä¸ºæ­¤ï¼Œä½ å¿…é¡»ä½¿ç”¨`goroutines`ã€‚

è¿™ä¸ªç®€å•çš„åº”ç”¨ç¨‹åºåœ¨ä¸¤ä¸ªä¸åŒçš„ç«¯å£ä¸Šæä¾›`http`æœåŠ¡ï¼Œç«¯å£`8080`ç”¨äºåº”ç”¨ç¨‹åºæœåŠ¡ï¼Œç«¯å£`8001`ç”¨äºè®¿é—®`/debug/pprof`ç»ˆç«¯ã€‚

```go
package main

import (
	"fmt"
	"net/http"
	_ "net/http/pprof"
)

func main() {
	mux := http.NewServeMux()
	mux.HandleFunc("/", func(resp http.ResponseWriter, req *http.Request) {
		fmt.Fprintln(resp, "Hello, QCon!")
	})
	go http.ListenAndServe("127.0.0.1:8001", http.DefaultServeMux) // debug
	http.ListenAndServe("0.0.0.0:8080", mux)                       // app traffic
}
```

è™½ç„¶è¿™ä¸ªç¨‹åºä¸æ˜¯å¾ˆå¤æ‚ï¼Œä½†å®ƒä»£è¡¨äº†çœŸå®åº”ç”¨ç¨‹åºçš„åŸºç¡€ã€‚

è¯¥åº”ç”¨ç¨‹åºå­˜åœ¨ä¸€äº›é—®é¢˜ï¼Œå› ä¸ºå®ƒéšç€åº”ç”¨ç¨‹åºçš„å¢é•¿è€Œæ˜¾éœ²å‡ºæ¥ï¼Œæ‰€ä»¥æˆ‘ä»¬ç°åœ¨æ¥è§£å†³å…¶ä¸­çš„ä¸€äº›é—®é¢˜ã€‚

```go
func serveApp() {
	mux := http.NewServeMux()
	mux.HandleFunc("/", func(resp http.ResponseWriter, req *http.Request) {
		fmt.Fprintln(resp, "Hello, QCon!")
	})
	http.ListenAndServe("0.0.0.0:8080", mux)
}

func serveDebug() {
	http.ListenAndServe("127.0.0.1:8001", http.DefaultServeMux)
}

func main() {
	go serveDebug()
	serveApp()
}
```

é€šè¿‡å°†`serveApp`å’Œ`serveDebug`å¤„ç†ç¨‹åºåˆ†è§£æˆä¸ºå®ƒä»¬è‡ªå·±çš„å‡½æ•°ï¼Œæˆ‘ä»¬å°†å®ƒä»¬ä¸`main.main`åˆ†ç¦»ã€‚ä¹Ÿéµå¾ªäº†ä¸Šé¢çš„å»ºè®®ï¼Œå¹¶ç¡®ä¿`serveApp`å’Œ`serveDebug`å°†å®ƒä»¬çš„å¹¶å‘æ€§ç•™ç»™è°ƒç”¨è€…ã€‚

ä½†æ˜¯è¿™ä¸ªç¨‹åºå­˜åœ¨ä¸€äº›å¯æ“ä½œæ€§é—®é¢˜ã€‚å¦‚æœ`serveApp`è¿”å›ï¼Œé‚£ä¹ˆ`main.main`å°†è¿”å›ï¼Œå¯¼è‡´ç¨‹åºå…³é—­å¹¶ç”±ä½ ä½¿ç”¨çš„è¿›ç¨‹ç®¡ç†å™¨æ¥é‡æ–°å¯åŠ¨ã€‚

> è´´å£«:
> æ­£å¦‚ Go è¯­è¨€ä¸­çš„å‡½æ•°å°†å¹¶å‘æ€§ç•™ç»™è°ƒç”¨è€…ä¸€æ ·ï¼Œåº”ç”¨ç¨‹åºåº”è¯¥å°†ç›‘è§†å…¶çŠ¶æ€å’Œæ£€æµ‹æ˜¯å¦é‡å¯çš„å·¥ä½œç•™ç»™å¦å¤–çš„ç¨‹åºæ¥åšã€‚ä¸è¦è®©ä½ çš„åº”ç”¨ç¨‹åºè´Ÿè´£é‡æ–°å¯åŠ¨è‡ªå·±ï¼Œæœ€å¥½ä»åº”ç”¨ç¨‹åºå¤–éƒ¨å¤„ç†è¯¥è¿‡ç¨‹ã€‚

ç„¶è€Œï¼Œ`serveDebug`æ˜¯åœ¨ä¸€ä¸ªå•ç‹¬çš„`goroutine`ä¸­è¿è¡Œçš„ï¼Œè¿”å›åè¯¥`goroutine`å°†é€€å‡ºï¼Œè€Œç¨‹åºçš„å…¶ä½™éƒ¨åˆ†ç»§ç»­ã€‚ç”±äº`/debug`å¤„ç†ç¨‹åºå·²åœæ­¢å·¥ä½œå¾ˆä¹…ï¼Œå› æ­¤æ“ä½œäººå‘˜ä¸ä¼šå¾ˆé«˜å…´å‘ç°ä»–ä»¬æ— æ³•åœ¨ä½ çš„åº”ç”¨ç¨‹åºä¸­è·å–ç»Ÿè®¡ä¿¡æ¯ã€‚

æˆ‘ä»¬æƒ³è¦ç¡®ä¿çš„æ˜¯ï¼Œå¦‚æœä»»ä½•è´Ÿè´£æä¾›æ­¤åº”ç”¨ç¨‹åºçš„`goroutine`åœæ­¢ï¼Œæˆ‘ä»¬å°†å…³é—­è¯¥åº”ç”¨ç¨‹åºã€‚

```go
func serveApp() {
	mux := http.NewServeMux()
	mux.HandleFunc("/", func(resp http.ResponseWriter, req *http.Request) {
		fmt.Fprintln(resp, "Hello, QCon!")
	})
	if err := http.ListenAndServe("0.0.0.0:8080", mux); err != nil {
		log.Fatal(err)
	}
}

func serveDebug() {
	if err := http.ListenAndServe("127.0.0.1:8001", http.DefaultServeMux); err != nil {
		log.Fatal(err)
	}
}

func main() {
	go serveDebug()
	go serveApp()
	select {}
}
```

ç°åœ¨`serverApp`å’Œ`serveDebug`æ£€æŸ¥ä»`ListenAndServe`è¿”å›çš„é”™è¯¯ï¼Œå¹¶åœ¨éœ€è¦æ—¶è°ƒç”¨`log.Fatal`ã€‚å› ä¸ºä¸¤ä¸ªå¤„ç†ç¨‹åºéƒ½åœ¨`goroutine`ä¸­è¿è¡Œï¼Œæ‰€ä»¥æˆ‘ä»¬å°†`main goroutine`åœåœ¨`select{}`ä¸­ã€‚

è¿™ç§æ–¹æ³•å­˜åœ¨è®¸å¤šé—®é¢˜ï¼š

1. å¦‚æœ`ListenAndServer`è¿”å›`nil`é”™è¯¯ï¼Œåˆ™ä¸ä¼šè°ƒç”¨`log.Fatal`ï¼Œå¹¶ä¸”è¯¥ç«¯å£ä¸Šçš„`HTTP`æœåŠ¡å°†åœ¨ä¸åœæ­¢åº”ç”¨ç¨‹åºçš„æƒ…å†µä¸‹å…³é—­ã€‚
2. `log.Fatal`è°ƒç”¨`os.Exit`ï¼Œå®ƒå°†æ— æ¡ä»¶åœ°é€€å‡ºç¨‹åº; `defer`ä¸ä¼šè¢«è°ƒç”¨ï¼Œå…¶ä»–`goroutines`ä¹Ÿä¸ä¼šè¢«é€šçŸ¥å…³é—­ï¼Œç¨‹åºå°±åœæ­¢äº†ã€‚ è¿™ä½¿å¾—ç¼–å†™è¿™äº›å‡½æ•°çš„æµ‹è¯•å˜å¾—å›°éš¾ã€‚

> è´´å£«:
> åªåœ¨`main.main`æˆ–`init`å‡½æ•°ä¸­çš„ä½¿ç”¨`log.Fatal`ã€‚

æˆ‘ä»¬çœŸæ­£æƒ³è¦çš„æ˜¯ä»»ä½•é”™è¯¯å‘é€å›`goroutine`çš„è°ƒç”¨è€…ï¼Œä»¥ä¾¿å®ƒå¯ä»¥çŸ¥é“`goroutine`åœæ­¢çš„åŸå› ï¼Œå¯ä»¥å¹²å‡€åœ°å…³é—­ç¨‹åºè¿›ç¨‹ã€‚

```go
func serveApp() error {
	mux := http.NewServeMux()
	mux.HandleFunc("/", func(resp http.ResponseWriter, req *http.Request) {
		fmt.Fprintln(resp, "Hello, QCon!")
	})
	return http.ListenAndServe("0.0.0.0:8080", mux)
}

func serveDebug() error {
	return http.ListenAndServe("127.0.0.1:8001", http.DefaultServeMux)
}

func main() {
	done := make(chan error, 2)
	go func() {
		done <- serveDebug()
	}()
	go func() {
		done <- serveApp()
	}()

	for i := 0; i < cap(done); i++ {
		if err := <-done; err != nil {
			fmt.Println("error: %v", err)
		}
	}
}
```

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨é€šé“æ¥æ”¶é›†`goroutine`çš„è¿”å›çŠ¶æ€ã€‚é€šé“çš„å¤§å°ç­‰äºæˆ‘ä»¬æƒ³è¦ç®¡ç†çš„`goroutine`çš„æ•°é‡ï¼Œè¿™æ ·å‘é€åˆ°`done`é€šé“å°±ä¸ä¼šé˜»å¡ï¼Œå› ä¸ºè¿™ä¼šé˜»æ­¢`goroutine`çš„å…³é—­ï¼Œå¯¼è‡´å®ƒæ³„æ¼ã€‚

ç”±äºæ²¡æœ‰åŠæ³•å®‰å…¨åœ°å…³é—­`done`é€šé“ï¼Œæˆ‘ä»¬ä¸èƒ½ä½¿ç”¨`for range`æ¥å¾ªç¯é€šé“ç›´åˆ°è·å–æ‰€æœ‰`goroutine`å‘æ¥çš„æŠ¥å‘Šï¼Œè€Œæ˜¯å¾ªç¯æˆ‘ä»¬å¼€å¯çš„å¤šä¸ª`goroutine`ï¼Œå³é€šé“çš„å®¹é‡ã€‚

ç°åœ¨æˆ‘ä»¬æœ‰åŠæ³•ç­‰å¾…æ¯ä¸ª goroutine å¹²å‡€åœ°é€€å‡ºå¹¶è®°å½•ä»–ä»¬é‡åˆ°çš„é”™è¯¯ã€‚æ‰€éœ€è¦çš„åªæ˜¯ä¸€ç§ä»ç¬¬ä¸€ä¸ª`goroutine`è½¬å‘å…³é—­ä¿¡å·åˆ°å…¶ä»–`goroutine`çš„æ–¹æ³•ã€‚

äº‹å®è¯æ˜ï¼Œè¦æ±‚`http.Server`å…³é—­æ˜¯æœ‰ç‚¹ç‰µæ‰¯çš„ï¼Œæ‰€ä»¥æˆ‘å°†è¿™ä¸ªé€»è¾‘è½¬ç»™è¾…åŠ©å‡½æ•°ã€‚`serve`åŠ©æ‰‹ä½¿ç”¨ä¸€ä¸ªåœ°å€å’Œ`http.Handler`ï¼Œç±»ä¼¼äº`http.ListenAndServe`ï¼Œè¿˜æœ‰ä¸€ä¸ª`stop`é€šé“ï¼Œæˆ‘ä»¬ç”¨å®ƒæ¥è§¦å‘`Shutdown`æ–¹æ³•ã€‚

```go
func serve(addr string, handler http.Handler, stop <-chan struct{}) error {
	s := http.Server{
		Addr:    addr,
		Handler: handler,
	}

	go func() {
		<-stop // wait for stop signal
		s.Shutdown(context.Background())
	}()

	return s.ListenAndServe()
}

func serveApp(stop <-chan struct{}) error {
	mux := http.NewServeMux()
	mux.HandleFunc("/", func(resp http.ResponseWriter, req *http.Request) {
		fmt.Fprintln(resp, "Hello, QCon!")
	})
	return serve("0.0.0.0:8080", mux, stop)
}

func serveDebug(stop <-chan struct{}) error {
	return serve("127.0.0.1:8001", http.DefaultServeMux, stop)
}

func main() {
	done := make(chan error, 2)
	stop := make(chan struct{})
	go func() {
		done <- serveDebug(stop)
	}()
	go func() {
		done <- serveApp(stop)
	}()

	var stopped bool
	for i := 0; i < cap(done); i++ {
		if err := <-done; err != nil {
			fmt.Println("error: %v", err)
		}
		if !stopped {
			stopped = true
			close(stop)
		}
	}
}
```

ç°åœ¨ï¼Œæ¯æ¬¡æˆ‘ä»¬åœ¨`done`é€šé“ä¸Šæ”¶åˆ°ä¸€ä¸ªå€¼æ—¶ï¼Œæˆ‘ä»¬å…³é—­`stop`é€šé“ï¼Œè¿™ä¼šå¯¼è‡´åœ¨è¯¥é€šé“ä¸Šç­‰å¾…çš„æ‰€æœ‰`goroutine`å…³é—­å…¶`http.Server`ã€‚è¿™åè¿‡æ¥å°†å¯¼è‡´å…¶ä½™æ‰€æœ‰çš„`ListenAndServe` goroutines è¿”å›ã€‚ä¸€æ—¦æˆ‘ä»¬å¼€å¯çš„æ‰€æœ‰`goroutine`éƒ½åœæ­¢äº†ï¼Œ`main.main`å°±ä¼šè¿”å›å¹¶ä¸”è¿›ç¨‹ä¼šå¹²å‡€åœ°åœæ­¢ã€‚

> è´´å£«:
> è‡ªå·±ç¼–å†™è¿™ç§é€»è¾‘æ˜¯é‡å¤è€Œå¾®å¦™çš„ã€‚ å‚è€ƒä¸‹è¿™ä¸ªåŒ…: [https://github.com/heptio/workgroup](https://github.com/heptio/workgroup)ï¼Œå®ƒä¼šä¸ºä½ å®Œæˆå¤§éƒ¨åˆ†å·¥ä½œã€‚

---

> **å¼•ç”¨: **
>
> [1](https://dave.cheney.net/practical-go/presentations/qcon-china.html#_footnoteref_1).Â [https://gaston.life/books/effective-programming/](https://gaston.life/books/effective-programming/)
>
> [2](https://dave.cheney.net/practical-go/presentations/qcon-china.html#_footnoteref_2).Â [https://talks.golang.org/2014/names.slide#4](https://talks.golang.org/2014/names.slide#4)
>
> [3](https://dave.cheney.net/practical-go/presentations/qcon-china.html#_footnoteref_3).Â [https://www.infoq.com/articles/API-Design-Joshua-Bloch](https://www.infoq.com/articles/API-Design-Joshua-Bloch)
>
> [1](https://dave.cheney.net/practical-go/presentations/qcon-china.html#_footnoteref_1).Â [https://www.lysator.liu.se/c/pikestyle.html](https://www.lysator.liu.se/c/pikestyle.html)
>
> [2](https://dave.cheney.net/practical-go/presentations/qcon-china.html#_footnoteref_2).Â [https://speakerdeck.com/campoy/understanding-nil](https://speakerdeck.com/campoy/understanding-nil)
>
> [3](https://dave.cheney.net/practical-go/presentations/qcon-china.html#_footnoteref_3).Â [https://www.youtube.com/watch?v=Ic2y6w8lMPA](https://www.youtube.com/watch?v=Ic2y6w8lMPA)
>
> [4](https://dave.cheney.net/practical-go/presentations/qcon-china.html#_footnoteref_4).Â [https://medium.com/@matryer/line-of-sight-in-code-186dd7cdea88](https://medium.com/@matryer/line-of-sight-in-code-186dd7cdea88)
>
> [5](https://dave.cheney.net/practical-go/presentations/qcon-china.html#_footnoteref_5).Â [https://golang.org/doc/go1.4#internalpackages](https://golang.org/doc/go1.4#internalpackages)
>
> [6](https://dave.cheney.net/practical-go/presentations/qcon-china.html#_footnoteref_6).Â [https://dave.cheney.net/2014/10/17/functional-options-for-friendly-apis](https://dave.cheney.net/2014/10/17/functional-options-for-friendly-apis)
>
> [7](https://dave.cheney.net/practical-go/presentations/qcon-china.html#_footnoteref_7).Â [https://commandcenter.blogspot.com/2014/01/self-referential-functions-and-design.html](https://commandcenter.blogspot.com/2014/01/self-referential-functions-and-design.html)
>
> [8](https://dave.cheney.net/practical-go/presentations/qcon-china.html#_footnoteref_8).Â [https://dave.cheney.net/2016/04/27/dont-just-check-errors-handle-them-gracefully](https://dave.cheney.net/2016/04/27/dont-just-check-errors-handle-them-gracefully)
>
> [9](https://dave.cheney.net/practical-go/presentations/qcon-china.html#_footnoteref_9).Â [https://www.amazon.com/Philosophy-Software-Design-John-Ousterhout/dp/1732102201](https://www.amazon.com/Philosophy-Software-Design-John-Ousterhout/dp/1732102201)
>
> [10](https://dave.cheney.net/practical-go/presentations/qcon-china.html#_footnoteref_10).Â [https://blog.golang.org/errors-are-values](https://blog.golang.org/errors-are-values)
>
> [11](https://dave.cheney.net/practical-go/presentations/qcon-china.html#_footnoteref_11).Â [http://www.gopl.io/](http://www.gopl.io/)

---

**åŸæ–‡é“¾æ¥ï¼š**[Practical Go: Real world advice for writing maintainable Go programs](https://dave.cheney.net/practical-go/presentations/qcon-china.html)

- _å¦‚æœ‰ç¿»è¯‘æœ‰è¯¯æˆ–è€…ä¸ç†è§£çš„åœ°æ–¹ï¼Œè¯·è¯„è®ºæŒ‡æ­£_
- _å¾…æ›´æ–°çš„è¯‘æ³¨ä¹‹åä¼šåšè¿›ä¸€æ­¥ä¿®æ”¹ç¿»è¯‘_
- _ç¿»è¯‘ï¼š[ç”°æµ©](https://github.com/llitfkitfk)_
- _é‚®ç®±ï¼š<llitfkitfk@gmail.com>_
